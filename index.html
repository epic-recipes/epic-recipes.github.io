<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#12141d">
  <meta name="description" content="Gestor de recetas con an√°lisis de costos y rentabilidad">
  <meta name="google-site-verification" content="3j2Z8l4hrvtZDrUhDKHbE6EIfZpE9w3ilwKD0WKS0A4" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="cookie.svg">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="cookie.svg">
  <title>Recetario √âpico</title>
  <style>
    :root {
      --primary: #7C9D8E;
      --primary-light: #A1C1B1;
      --primary-dark: #5F7A6E;
      --bg: #F8F9F5;
      --bg-card: #FFFFFF;
      --accent: #D9AD98;
      --accent-light: #E5C3B1;
      --accent-dark: #B88D75;
      --border-soft: #E5E7EB;
      --text: #2C3E50;
      --text-muted: #7F8C8D;
      --danger: #E74C3C;
      --success: #27AE60;
      --warning: #F39C12;
      --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.05);
      --shadow-hover: 0 10px 30px rgba(0, 0, 0, 0.1);
      --radius: 1rem;
    }

    * {
      box-sizing: border-box;
      transition: background-color 0.2s, color 0.2s, transform 0.2s, box-shadow 0.2s;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      color: var(--text);
      background-color: var(--bg);
    }

    #toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: var(--bg-card);
      color: var(--text);
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow-hover);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 280px;
      border-left: 4px solid var(--primary);
      animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .toast-success {
      border-left-color: var(--success);
    }

    .toast-error {
      border-left-color: var(--danger);
    }

    .toast-warning {
      border-left-color: var(--warning);
    }

    @keyframes slideIn {
      from {
        transform: translateX(120%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(44, 62, 80, 0.4);
      backdrop-filter: blur(4px);
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--bg-card);
      padding: 1.5rem;
      width: 90%;
      max-width: 600px;
      border-radius: 1.5rem;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Donation Modal Specifics */
    .donation-modal .modal-content {
      max-height: 98vh;
      display: flex;
      flex-direction: column;
    }

    .iframe-container {
      width: 100%;
      min-height: 650px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #fff;
      margin: 0 auto;
    }

    .iframe-container iframe {
      width: 100% !important;
      max-width: 350px;
      height: 650px !important;
      border: none;
      display: block;
      margin: 0 auto;
    }

    @media (max-width: 768px) {
      .donation-modal .modal-content {
        width: 100%;
        height: 100%;
        max-height: 100vh;
        border-radius: 0;
      }

      .iframe-container {
        min-height: 650px;
        padding-bottom: env(safe-area-inset-bottom, 2rem);
      }
    }

    /* Mobile fine-tuning */
    @media (max-width: 640px) {
      :root {
        --radius: 0.75rem;
      }

      .modal-content {
        padding: 1.25rem;
        border-radius: 1.25rem;
      }

      header {
        padding: 0.75rem 1rem !important;
      }

      header h1 {
        font-size: 1rem !important;
      }

      .card {
        padding: 1rem !important;
        margin-bottom: 0.75rem !important;
      }

      section {
        padding: 1.5rem !important;
        border-radius: 1.5rem !important;
      }

      .fab,
      .fab-save {
        width: 50px !important;
        height: 50px !important;
        bottom: 80px !important;
        right: 16px !important;
      }

      .fab-save {
        width: auto !important;
        padding: 0 1.25rem !important;
      }

      .btn {
        padding: 0.5rem 1rem !important;
        font-size: 0.875rem !important;
      }

      #toast-container {
        bottom: 16px;
        right: 16px;
        left: 16px;
      }

      .toast {
        min-width: auto;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
      }

      .main-content-p {
        padding: 0.75rem !important;
        padding-bottom: 5rem !important;
      }

      .bottom-nav-m {
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        height: auto !important;
        border-radius: 0 !important;
        border-top: 1px solid #f3f4f6 !important;
        padding: 0.75rem 0 !important;
        padding-bottom: calc(env(safe-area-inset-bottom, 0.5rem) + 0.5rem) !important;
      }

      .bottom-nav-m button {
        width: 3.5rem !important;
        height: 3.5rem !important;
        flex-shrink: 0 !important;
      }

      .rec-summary {
        padding: 1.25rem !important;
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 1.25rem !important;
        position: relative;
      }

      .rec-summary>div:first-child {
        width: 100%;
      }

      .rec-summary h3 {
        font-size: 1.25rem !important;
        padding-right: 3rem;
        word-break: break-word;
      }

      .rec-summary .gap-4 {
        flex-wrap: wrap !important;
        gap: 0.5rem !important;
      }

      .rec-summary .gap-4>span {
        font-size: 0.75rem !important;
        padding: 0.25rem 0.5rem !important;
      }

      .rec-summary button {
        position: absolute !important;
        top: 1.25rem;
        right: 1.25rem;
      }

      .rec-summary .mt-3 span {
        display: inline-block;
        max-width: 100%;
        font-size: 0.875rem !important;
      }

      .ing-card-mobile {
        padding: 0.75rem !important;
        border-radius: 1rem !important;
      }

      .ing-card-mobile b {
        font-size: 0.875rem;
      }

      .ing-card-mobile span {
        font-size: 0.75rem;
      }
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.625rem 1.25rem;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn-icon:hover {
      background-color: var(--primary-light);
      color: white;
    }

    /* FAB - Floating Action Button */
    .fab,
    .fab-save {
      position: fixed;
      bottom: 100px;
      /* Above bottom nav */
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 20px;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 25px rgba(124, 157, 142, 0.4);
      z-index: 1001;
      cursor: pointer;
      border: none;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .fab:hover,
    .fab-save:hover {
      transform: scale(1.1) translateY(-5px);
      box-shadow: 0 15px 30px rgba(124, 157, 142, 0.6);
      background-color: var(--primary-dark);
    }

    .fab:active,
    .fab-save:active {
      transform: scale(0.95);
    }

    .fab-save {
      width: auto;
      padding: 0 1.5rem;
      border-radius: 30px;
      background-color: #fbbf24;
      color: #1f2937;
      font-weight: 700;
      box-shadow: 0 10px 25px rgba(251, 191, 36, 0.4);
    }

    .fab-save:hover {
      background-color: #f59e0b;
      box-shadow: 0 15px 30px rgba(251, 191, 36, 0.6);
    }

    @media (min-width: 768px) {

      .fab,
      .fab-save {
        position: sticky;
        bottom: 24px;
        right: 0;
        margin-left: auto;
        margin-top: 20px;
      }
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      box-shadow: 0 4px 12px rgba(124, 157, 142, 0.3);
    }

    .btn-secondary {
      background: var(--bg);
      color: var(--text);
      border: 1px solid #e0e0e0;
    }

    .btn-secondary:hover {
      background: #f0f0f0;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .card:hover {
      box-shadow: var(--shadow-hover);
    }

    /* Hide scrollbar but keep functionality */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Ocultar botones flotantes cuando hay un modal activo */
    body:has(.modal.active) .fab,
    body:has(.modal.active) .fab-save {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: scale(0.8);
      transition: all 0.3s ease;
    }
  </style>
</head>

<body>



  <!-- MODAL de Idioma (Redise√±ado) -->
  <div id="language-modal" class="modal">
    <div class="modal-content max-w-lg">
      <div class="modal-header flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800" data-i18n="settings.title">Idioma</h3>
        <button
          class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:text-gray-600 transition-all font-bold"
          onclick="toggleLangBar()">√ó</button>
      </div>
      <div class="grid grid-cols-2 gap-2 max-h-[60vh] overflow-y-auto no-scrollbar" id="lang-options">
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('es')">üá™üá∏ Espa√±ol</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('en')">üá∫üá∏ English</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('fr')">üá´üá∑ Fran√ßais</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('de')">üá©üá™ Deutsch</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('it')">üáÆüáπ Italiano</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('pt')">üáµüáπ Portugu√™s</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('nl')">üá≥üá± Nederlands</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('ar')">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('ja')">üáØüáµ Êó•Êú¨Ë™û</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('ko')">üá∞üá∑ ÌïúÍµ≠Ïñ¥</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('zh')">üá®üá≥ ‰∏≠Êñá</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('tr')">üáπüá∑ T√ºrk√ße</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('vi')">üáªüá≥ Ti·∫øng Vi·ªát</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('th')">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('pl')">üáµüá± Polski</button>
        <button
          class="btn btn-secondary justify-start font-medium py-3 px-4 rounded-xl hover:border-primary/50 transition-all text-xs"
          onclick="changeLanguage('srn')">üá∏üá∑ Sranan</button>
      </div>
    </div>
  </div>

  <div class="flex h-screen bg-gray-50 overflow-x-hidden">
    <aside class="hidden md:flex flex-col items-center py-6 w-24 bg-white border-r border-gray-100"
      style="background-color: var(--bg-card)">
      <div class="w-12 h-12 rounded-2xl flex items-center justify-center mb-10 shadow-sm"
        style="background-color: var(--accent-light)">
        <i class="fas fa-utensils text-white text-xl"></i>
      </div>
      <button id="sidebar-ingredientes"
        class="w-16 h-16 flex items-center justify-center rounded-2xl text-gray-400 mb-4 hover:text-primary transition-all"
        onclick="switchTab('tab-ingredientes')" title="Ingredientes" data-i18n-title="nav.ingredients">
        <i class="fas fa-carrot text-xl"></i>
      </button>
      <button id="sidebar-receta"
        class="w-16 h-16 flex items-center justify-center rounded-2xl text-gray-400 mb-4 hover:text-primary transition-all"
        onclick="switchTab('tab-receta')" title="Crear Receta" data-i18n-title="nav.create_recipe">
        <i class="fas fa-mortar-pestle text-xl"></i>
      </button>
      <button id="sidebar-libro"
        class="w-16 h-16 flex items-center justify-center rounded-2xl bg-primary text-white mb-4 shadow-lg shadow-primary/20"
        style="background-color: var(--primary)" onclick="switchTab('tab-libro')" title="Mis Recetas"
        data-i18n-title="nav.my_recipes">
        <i class="fas fa-book-open text-xl"></i>
      </button>
      <button id="sidebar-config"
        class="w-16 h-16 flex items-center justify-center rounded-2xl text-gray-400 hover:text-primary transition-all mt-auto"
        onclick="switchTab('tab-config')" title="Configuraci√≥n" data-i18n-title="nav.settings">
        <i class="fas fa-sliders-h text-xl"></i>
      </button>
    </aside>
    <main class="flex-1 md:ml-0 flex flex-col">
      <header class="sticky top-0 z-30 p-4 px-6 flex justify-between items-center border-b border-gray-100 shadow-sm"
        style="background-color: var(--bg-card)">
        <div class="flex items-center">
          <div class="w-2 h-8 rounded-full mr-3" style="background-color: var(--primary)"></div>
          <h1 class="text-xl font-extrabold tracking-tight" style="color: var(--text)" data-i18n="app_name">RECETARIO
            √âPICO</h1>
        </div>
        <div class="flex gap-3">
          <button
            class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-50 text-gray-500 hover:bg-gray-100 transition-colors"
            onclick="toggleLangBar()" title="Cambiar idioma" data-i18n-title="settings.title"
            style="background-color: var(--bg)">
            <i class="fas fa-language text-lg"></i>
          </button>
          <button
            class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-50 text-gray-500 hover:bg-gray-100 transition-colors"
            onclick="shareApp()" title="Compartir App" data-i18n-title="book.share" style="background-color: var(--bg)">
            <i class="fas fa-share-alt text-lg"></i>
          </button>
          <button
            class="text-white px-5 py-2 rounded-xl font-semibold shadow-md hover:opacity-90 transition-all text-sm donate-btn"
            style="background-color: var(--primary)" onclick="openDonationModal()"
            data-i18n="donation.title">Donar</button>
        </div>
      </header>

      <!-- Install App Banner -->
      <div id="install-banner"
        class="hidden bg-gray-900 text-white p-4 flex items-center justify-between gap-4 shadow-2xl border-l-4 border-primary sticky top-[73px] z-20">
        <div class="flex items-center gap-4 flex-1">
          <div class="w-12 h-12 flex-shrink-0 animate-bounce">
            <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'>
              <path
                d="M256,42c-118.2,0-214,95.8-214,214s95.8,214,214,214s214-95.8,214-214c0-43.3-12.8-83.6-34.9-117.2c3.7,10.1,5.9,21.1,5.9,32.6c0,53-43,96-96,96s-96-43-96-96s43-96,96-96c11.5,0,22.5,2.1,32.6,5.9C339.6,54.8,299.3,42,256,42z"
                fill="#D2691E" />
              <circle cx="160" cy="190" r="22" fill="#4B2C20" />
              <circle cx="320" cy="290" r="22" fill="#4B2C20" />
              <circle cx="230" cy="400" r="22" fill="#4B2C20" />
              <circle cx="110" cy="340" r="22" fill="#4B2C20" />
              <circle cx="390" cy="410" r="22" fill="#4B2C20" />
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-semibold text-sm" data-i18n="donation.install_app">Instalar como App</p>
            <p class="text-xs opacity-90" data-i18n="donation.install_description">Guarda Recetario en tu dispositivo
              para acceso r√°pido sin conexi√≥n</p>
          </div>
        </div>
        <div class="flex gap-2 flex-shrink-0">
          <button
            class="bg-white hover:bg-gray-100 text-primary font-medium px-4 py-2 rounded-lg transition-colors text-sm whitespace-nowrap"
            style="color: var(--primary)" onclick="installApp()" data-i18n="donation.install_button">Instalar</button>
          <button
            class="bg-primary-dark hover:bg-black/20 text-white font-medium px-4 py-2 rounded-lg transition-colors text-sm whitespace-nowrap"
            onclick="dismissInstallBanner()" data-i18n="donation.later">Ahora no</button>
        </div>
      </div>

      <!-- Bottom Nav for Mobile -->
      <div class="md:hidden fixed flex justify-around z-40 shadow-2xl shadow-primary/10 bottom-nav-m"
        style="background-color: var(--bg-card)">
        <button id="bottom-ingredientes"
          class="flex items-center justify-center text-gray-400 transition-all hover:scale-110 active:scale-95"
          onclick="switchTab('tab-ingredientes')" title="Ingredientes">
          <i class="fas fa-carrot text-2xl"></i>
        </button>
        <button id="bottom-receta"
          class="flex items-center justify-center text-gray-400 transition-all hover:scale-110 active:scale-95"
          onclick="switchTab('tab-receta')" title="Crear Receta">
          <i class="fas fa-mortar-pestle text-2xl"></i>
        </button>
        <button id="bottom-libro"
          class="flex items-center justify-center text-primary transition-all hover:scale-110 active:scale-95"
          style="color: var(--primary)" onclick="switchTab('tab-libro')" title="Mis Recetas">
          <i class="fas fa-book-open text-2xl"></i>
        </button>
        <button id="bottom-config"
          class="flex items-center justify-center text-gray-400 transition-all hover:scale-110 active:scale-95"
          onclick="switchTab('tab-config')" title="Configuraci√≥n">
          <i class="fas fa-sliders-h text-2xl"></i>
        </button>
      </div>

      <div class="flex-1 overflow-y-auto p-4 pb-16 md:pb-4 overflow-x-hidden main-content-p">

        <!-- TAB 1: INGREDIENTES -->
        <div id="tab-ingredientes" class="tab-content">
          <section class="bg-white rounded-[2rem] shadow-sm p-8 mb-20 border"
            style="background-color: var(--bg-card); border-color: var(--border-soft)">
            <div class="flex justify-between items-center mb-8">
              <div>
                <h3 class="text-xl font-bold" style="color: var(--text)" data-i18n="ingredients.list_title">Despensa
                </h3>
                <p class="text-sm" style="color: var(--text-muted)" data-i18n="app_description">Gestor de ingredientes
                </p>
              </div>
              <button
                class="bg-primary text-white px-5 py-2.5 rounded-xl font-bold shadow-md hover:scale-[1.02] active:scale-95 transition-all text-sm flex items-center gap-2"
                style="background-color: var(--primary)" onclick="openIngredientModal()">
                <i class="fas fa-plus"></i>
                <span data-i18n="ingredients.add_ingredient">A√±adir Ingrediente</span>
              </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="ing-list">
              <!-- Listado de ingredientes -->
            </div>
          </section>
        </div>

        <!-- TAB 2: CREAR RECETA -->
        <div id="tab-receta" class="tab-content">
          <div class="grid grid-cols-1 gap-4">
            <section class="bg-white rounded-[2rem] shadow-sm p-8 border border-gray-50">
              <h2 class="text-xl font-bold text-gray-800 mb-6" data-i18n="recipe.title">Creador de Recetas</h2>
              <div class="space-y-6">
                <!-- Resumen de Receta (Solo lectura) -->
                <div class="bg-gray-50 rounded-2xl p-5 flex justify-between items-center border border-gray-100 rec-summary"
                  style="background-color: var(--bg); border-color: var(--border-soft)">
                  <div>
                    <h3 class="text-2xl font-black" style="color: var(--text)" id="display-rec-name"
                      data-i18n="common.new_recipe">
                      Nueva Receta</h3>
                    <div class="flex items-center gap-4 text-sm mt-2" style="color: var(--text-muted)">
                      <span class="bg-white px-2 py-1 rounded-lg border border-gray-100"
                        style="background-color: var(--bg-card)">
                        <span id="display-rec-portions">1</span> <span data-i18n="book.portions">porciones</span>
                      </span>
                      <span class="bg-white px-2 py-1 rounded-lg border border-gray-100"
                        style="background-color: var(--bg-card)">
                        <span id="display-service-pct-val">0</span>% <span
                          data-i18n="recipe.stats.service_cost">Servicios</span>
                      </span>
                      <span class="bg-white px-2 py-1 rounded-lg border border-gray-100"
                        style="background-color: var(--bg-card)">
                        +<span id="display-profit-pct-val">0</span>% <span
                          data-i18n="settings.profit_percentage">Ganancia</span>
                      </span>
                    </div>
                    <div class="mt-3">
                      <span class="font-bold px-3 py-1.5 rounded-lg border"
                        style="color: var(--primary); background-color: var(--bg-card); border-color: var(--primary-light)">
                        <span id="display-rec-price">0.00‚Ç¨</span> <span data-i18n="modal.sale_price">Venta por
                          Porci√≥n</span>
                      </span>
                    </div>
                  </div>
                  <button
                    class="w-10 h-10 bg-white text-primary border border-gray-100 rounded-2xl shadow-sm hover:shadow-md transition-all flex items-center justify-center"
                    style="color: var(--primary)" onclick="openRecipeDetailsModal()" title="Editar Detalles"
                    data-i18n-title="common.edit_details">
                    <i class="fas fa-pen text-sm"></i>
                  </button>
                </div>

                <div class="flex gap-3">
                  <button
                    class="flex-1 bg-primary text-white px-6 py-3 rounded-2xl font-bold shadow-lg shadow-primary/20 hover:scale-[1.02] transition-all flex items-center justify-center gap-2"
                    style="background-color: var(--primary)" onclick="openRecipeItemModal()"
                    data-i18n="recipe.add_ingredient_button">
                    <i class="fas fa-plus-circle"></i> A√±adir Componentes
                  </button>
                  <button
                    class="bg-red-50 text-red-500 px-6 py-3 rounded-2xl font-bold hover:bg-red-100 transition-all border border-red-100"
                    onclick="resetActiveRecipe()" data-i18n="recipe.clear_button">Restablecer</button>
                </div>
                <div>
                  <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 ml-1"
                    data-i18n="recipe.selected_ingredients">Ingredientes Seleccionados</label>
                  <div class="grid grid-cols-1 gap-3 max-h-64 overflow-y-auto pr-2 no-scrollbar" id="rec-items-list">
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                  <div class="p-2 rounded-xl border"
                    style="background-color: var(--bg); border-color: var(--border-soft)">
                    <div class="text-[9px] font-bold uppercase tracking-wider" style="color: var(--accent-dark)"
                      data-i18n="recipe.stats.base_cost">Costo Base</div>
                    <div class="text-sm font-black" style="color: var(--accent-dark)" id="stat-base-cost">0.00‚Ç¨</div>
                  </div>
                  <div class="p-2 rounded-xl border" style="background-color: var(--bg); border-color: var(--warning)">
                    <div class="text-[9px] font-bold uppercase tracking-wider" style="color: var(--text)">
                      <span data-i18n="recipe.stats.service_cost">Gastos Servicios</span>
                      <span class="text-[8px] opacity-70 ml-1">(<span id="display-service-pct">0</span>%)</span>
                    </div>
                    <div class="text-sm font-black" style="color: var(--text)" id="stat-service-cost">0.00‚Ç¨</div>
                  </div>
                  <div class="p-2 rounded-xl border"
                    style="background-color: var(--bg); border-color: var(--border-soft)">
                    <div class="text-[9px] font-bold uppercase tracking-wider" style="color: var(--primary)"
                      data-i18n="recipe.stats.total_cost">Costo Total</div>
                    <div class="text-sm font-black" style="color: var(--primary)" id="stat-total-cost">0.00‚Ç¨</div>
                  </div>
                  <div class="p-2 rounded-xl border"
                    style="background-color: var(--bg); border-color: var(--border-soft)">
                    <div class="text-[9px] font-bold uppercase tracking-wider" style="color: var(--accent-dark)">
                      <span data-i18n="recipe.stats.suggested_price">Precio Sugerido</span>
                      <span class="text-[8px] opacity-70 ml-1">(+<span id="display-profit-pct">0</span>%)</span>
                    </div>
                    <div class="text-sm font-black" style="color: var(--accent-dark)" id="stat-suggested-price">0.00‚Ç¨
                    </div>
                  </div>
                  <div class="p-2 rounded-xl border"
                    style="background-color: var(--bg-card); border-color: var(--border-soft)">
                    <div class="text-[9px] font-bold uppercase tracking-wider" style="color: var(--text-muted)"
                      data-i18n="recipe.stats.profit">Beneficio Real</div>
                    <div class="text-sm font-black" style="color: var(--text)" id="stat-profit">0.00‚Ç¨</div>
                  </div>
                  <div class="p-2 rounded-xl border"
                    style="background-color: var(--bg-card); border-color: var(--border-soft)">
                    <div class="text-[9px] font-bold uppercase tracking-wider" style="color: var(--text-muted)"
                      data-i18n="recipe.stats.price_per_portion">Precio/Porci√≥n</div>
                    <div class="text-sm font-black" style="color: var(--text)" id="stat-price-per-portion">0.00‚Ç¨</div>
                  </div>
                </div>
                <!-- Bot√≥n Flotante de Guardado -->
                <button class="fab-save" id="btn-save-recipe" onclick="saveRecipe()"
                  data-i18n="recipe.save_button">Guardar
                  Receta</button>
              </div>
            </section>
          </div>
        </div>

        <!-- TAB 3: LIBRO DE RECETAS -->
        <div id="tab-libro" class="tab-content active">
          <section class="bg-white rounded-[2rem] shadow-sm p-8 border border-gray-50">
            <h2 class="text-xl font-bold text-gray-800 mb-6" data-i18n="book.title">Mis Recetas</h2>
            <div id="recipe-book"
              class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2 no-scrollbar">
              <!-- Recetas guardadas -->
            </div>
            <div class="flex gap-4 mt-8">
              <p class="text-xs text-center w-full text-gray-400" data-i18n="settings.export_centralized">La exportaci√≥n
                e importaci√≥n se gestiona desde Configuraci√≥n</p>
            </div>
            <input type="file" id="file-input" class="hidden" accept=".json" onchange="handleFileImport()">
          </section>
        </div>

        <!-- TAB 4: CONFIGURACI√ìN -->
        <div id="tab-config" class="tab-content">
          <section class="bg-white rounded-[2rem] shadow-sm p-8 border"
            style="background-color: var(--bg-card); border-color: var(--border-soft)">
            <h2 class="text-xl font-bold mb-8" style="color: var(--text)" data-i18n="settings.title">Configuraci√≥n</h2>

            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xs font-black text-primary uppercase tracking-widest" style="color: var(--primary)"
                data-i18n="settings.units_title">Unidades de Medida</h3>
              <button
                class="bg-primary text-white px-4 py-2 rounded-xl font-bold text-xs shadow-sm shadow-primary/20 hover:scale-[1.02] active:scale-95 transition-all flex items-center gap-2"
                style="background-color: var(--primary)" onclick="openUnitModal()">
                <i class="fas fa-plus"></i>
                <span data-i18n="settings.add_unit">Agregar Unidad</span>
              </button>
            </div>
            <div id="units-list"
              class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-8 max-h-48 overflow-y-auto pr-2 no-scrollbar"></div>

            <div class="border-t border-gray-100 pt-8 mb-8">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xs font-black text-primary uppercase tracking-widest" style="color: var(--primary)"
                  data-i18n="settings.conversions_title">Equivalencias</h3>
                <button
                  class="bg-primary text-white px-4 py-2 rounded-xl font-bold text-xs shadow-sm shadow-primary/20 hover:scale-[1.02] active:scale-95 transition-all flex items-center gap-2"
                  style="background-color: var(--primary)" onclick="openConversionModal()">
                  <i class="fas fa-plus"></i>
                  <span data-i18n="settings.add_conversion">Agregar Conversi√≥n</span>
                </button>
              </div>
              <div id="conversions-list" class="grid grid-cols-1 gap-2 mb-8 max-h-48 overflow-y-auto pr-2 no-scrollbar">
              </div>
            </div>

            <div class="border-t border-gray-100 pt-8 mb-8 hidden">
              <h3 class="text-xs font-black text-primary uppercase tracking-widest mb-4" style="color: var(--primary)"
                data-i18n="settings.accounting_title">C√°lculos Contables Globales</h3>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                    data-i18n="settings.service_percentage">Gastos de Servicios (%)</label>
                  <input type="number" id="service-percentage"
                    class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                    placeholder="0" min="0" max="100" step="0.1" value="0"
                    oninput="updateServicePercentage(this.value)">
                  <p class="text-[10px] text-gray-400 mt-1 ml-1" data-i18n="settings.service_percentage_hint">
                    Electricidad, gas, agua, etc.
                  </p>
                </div>

                <div>
                  <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                    data-i18n="settings.profit_percentage">Margen de Ganancias (%)</label>
                  <input type="number" id="profit-percentage"
                    class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                    placeholder="0" min="0" max="1000" step="0.1" value="0"
                    oninput="updateProfitPercentage(this.value)">
                  <p class="text-[10px] text-gray-400 mt-1 ml-1" data-i18n="settings.profit_percentage_hint">
                    Ganancia deseada sobre el costo total
                  </p>
                </div>
              </div>
            </div>


            <div class="bg-gray-50 rounded-2xl p-5 mt-8 border border-gray-100"
              style="background-color: var(--bg); border-color: var(--border-soft)">
              <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                  <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 ml-1"
                    data-i18n="settings.data_title">Gesti√≥n de Datos</h3>
                  <p class="text-[10px] text-gray-400 ml-1 opacity-70" data-i18n="settings.export_centralized">
                    Exportaci√≥n e importaci√≥n centralizada</p>
                </div>
                <div class="flex gap-2 flex-wrap">
                  <button
                    class="flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-100 rounded-xl hover:shadow-md transition-all group min-w-[100px] justify-center"
                    style="background-color: var(--bg-card)" onclick="exportBulkData()">
                    <i class="fas fa-cloud-download-alt text-blue-400 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest" style="color: var(--text-muted)"
                      data-i18n="settings.export_btn">Exportar</span>
                  </button>
                  <button
                    class="flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-100 rounded-xl hover:shadow-md transition-all group min-w-[100px] justify-center"
                    style="background-color: var(--bg-card)" onclick="importBulkData()">
                    <i class="fas fa-cloud-upload-alt text-orange-400 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest" style="color: var(--text-muted)"
                      data-i18n="settings.import_btn">Importar</span>
                  </button>
                  <button
                    class="flex items-center gap-2 px-4 py-2.5 bg-red-50/50 text-red-500 rounded-xl hover:bg-red-50 transition-all border border-red-100/50 min-w-[100px] justify-center"
                    onclick="resetAllData()">
                    <i class="fas fa-trash-alt text-[10px] opacity-60"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest"
                      data-i18n="settings.clear_btn">Limpiar</span>
                  </button>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- VISTA ORIGINAL ESCRITORIO -->
        <div class="main-grid" id="desktop-view" style="display: none;">
          <!-- PANEL IZQUIERDO: INGREDIENTES -->
          <section class="panel">
            <h2 data-i18n="desktop.ingredients">Ingredientes</h2>
            <div class="form-group">
              <label data-i18n="ingredients.ingredient_name">Nombre del Ingrediente</label>
              <input type="text" id="ing-name-desk" placeholder="Ej: Carne de Res, Ajo, Tomate"
                data-i18n="ingredients.ingredient_name_placeholder">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
              <div class="form-group">
                <label data-i18n="ingredients.price">Precio (‚Ç¨)</label>
                <input type="number" id="ing-cost-desk" placeholder="0.00" step="0.01">
              </div>
              <div class="form-group">
                <label data-i18n="ingredients.unit">Unidad</label>
                <select id="ing-rarity-desk"></select>
              </div>
            </div>
            <div class="form-group" style="margin-top:8px">
              <label data-i18n="ingredients.category_label">Categor√≠a</label>
              <select id="ing-category-desk">
                <option value="food" data-i18n="ingredients.type_food">Ingrediente</option>
                <option value="supply" data-i18n="ingredients.type_supply">Insumo / Empaque</option>
              </select>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px">
              <div class="form-group">
                <label data-i18n="ingredients.price_type">Tipo de Precio</label>
                <select id="ing-price-type-desk" onchange="togglePackInput('ing-price-type-desk','ing-pack-size-desk')">
                  <option value="unit" data-i18n="ingredients.per_unit">Por unidad</option>
                  <option value="pack" data-i18n="ingredients.per_pack">Por pack</option>
                </select>
              </div>
              <div class="form-group">
                <label data-i18n="ingredients.pack_size">Tama√±o del Pack (cantidad)</label>
                <input type="number" id="ing-pack-size-desk" placeholder="1" value="1" min="0.01" step="0.01"
                  oninput="validatePackSize('ing-pack-size-desk', 'ing-rarity-desk')">
              </div>
            </div>
            <div class="btn-grid">
              <button class="btn btn-primary" onclick="addIngredientDesk()"
                data-i18n="desktop.add_ingredient">A√±adir</button>
              <button class="btn btn-danger" onclick="clearIngredientsDesk()">Vaciar</button>
            </div>

            <div class="divider"></div>
            <label data-i18n="ingredients.list_title">Despensa</label>
            <div class="list-container" id="ing-list-desk">
              <!-- Listado de ingredientes -->
            </div>
          </section>

          <!-- PANEL DERECHO: COCINA -->
          <section class="panel">
            <h2 data-i18n="recipe.title">Creador de Recetas</h2>
            <div class="form-group">
              <label data-i18n="recipe.recipe_name">Nombre del Plato</label>
              <input type="text" id="rec-name-desk" placeholder="Pasta a la Carbonara"
                data-i18n="recipe.recipe_name_placeholder">
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
              <div class="form-group">
                <label data-i18n="recipe.ingredient">Ingrediente</label>
                <select id="rec-ing-select-desk" onchange="updateTypeSelector('desk', 'ing')"></select>
              </div>
              <div class="form-group">
                <label data-i18n="recipe.supplies_section">Insumo</label>
                <select id="rec-supply-select-desk" onchange="updateTypeSelector('desk', 'supply')"></select>
              </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
              <div class="form-group">
                <label data-i18n="nav.my_recipes">Sub-Receta</label>
                <select id="rec-recipe-select-desk" onchange="updateTypeSelector('desk', 'recipe')"></select>
              </div>
              <div class="form-group">
                <label data-i18n="recipe.unit">Unidad</label>
                <select id="rec-unit-select-desk"></select>
              </div>
            </div>
            <div class="form-group">
              <label data-i18n="recipe.quantity">Cantidad</label>
              <input type="number" id="rec-qty-desk" value="100" min="0.01" step="0.1">
            </div>

            <div class="btn-grid">
              <button class="btn btn-success" onclick="addToRecipeDesk()" data-i18n="recipe.add_button">A√±adir</button>
              <button class="btn btn-danger" onclick="clearActiveRecipeDesk()"
                data-i18n="desktop.clear_recipe">Limpiar</button>
            </div>

            <div class="divider"></div>
            <label data-i18n="recipe.selected_ingredients">Ingredientes Seleccionados</label>
            <div class="list-container" id="rec-items-list-desk" style="max-height: 180px;"></div>

            <div class="form-group" style="margin-top:15px">
              <label data-i18n="recipe.price">Precio del Plato (‚Ç¨)</label>
              <input type="number" id="rec-price-desk" placeholder="0.00" step="0.01" oninput="updateStatsDesk()">
            </div>

            <div class="form-group">
              <label data-i18n="recipe.portions">Porciones</label>
              <input type="number" id="rec-portions-desk" placeholder="1" value="1" min="1" step="1"
                oninput="updateStatsDesk()">
            </div>

            <div class="form-group">
              <label data-i18n="recipe.instructions">M√©todo de Preparaci√≥n</label>
              <textarea id="rec-instructions-desk" placeholder="Describe los pasos para preparar la receta..."
                rows="4"></textarea>
            </div>

            <div class="stats-box">
              <div class="stat-card">
                <span class="stat-label" data-i18n="recipe.stats.cost">Costo Ingredientes</span>
                <div class="stat-val" id="stat-cost-desk">0.00‚Ç¨</div>
              </div>
              <div class="stat-card">
                <span class="stat-label" data-i18n="recipe.stats.profit">Beneficio Neto</span>
                <div class="stat-val" id="stat-profit-desk">0.00‚Ç¨</div>
              </div>
              <div class="stat-card">
                <span class="stat-label" data-i18n="recipe.stats.price_per_portion">Precio por Porci√≥n</span>
                <div class="stat-val" id="stat-price-per-portion-desk">0.00‚Ç¨</div>
              </div>
              <div class="stat-card">
                <span class="stat-label" data-i18n="recipe.stats.margin">Margen %</span>
                <div class="stat-val" id="stat-margin-desk">0%</div>
              </div>
              <div class="stat-card">
                <span class="stat-label" data-i18n="recipe.stats.roi">Rentabilidad</span>
                <div class="stat-val" id="stat-roi-desk">0.00x</div>
              </div>
            </div>

            <div class="btn-grid" style="margin-top:20px">
              <button class="btn btn-primary" style="flex:1" onclick="saveRecipeDesk()"
                data-i18n="desktop.save_recipe">Guardar Receta</button>
            </div>
          </section>
        </div>

        <!-- RECETAS GUARDADAS ESCRITORIO -->
        <section class="panel" style="margin-top:20px; display: none;" id="recipe-book-section-desk">
          <h2 data-i18n="desktop.my_recipes">Mis Recetas
            <div style="display:flex; gap:5px; justify-self:end">
              <p class="text-[9px] text-gray-400 font-normal" data-i18n="settings.export_centralized">La exportaci√≥n e
                importaci√≥n se gestiona desde Configuraci√≥n</p>
            </div>
          </h2>
          <div id="recipe-book-desk" class="list-container">
            <!-- Recetas guardadas -->
          </div>
        </section>
      </div>

      <!-- MODAL para ver detalles de receta -->
      <div id="recipe-modal" class="modal">
        <div class="modal-content max-w-3xl">
          <div class="modal-header flex justify-between items-center mb-6">
            <h3 id="modal-recipe-name" class="text-2xl font-black text-gray-800 tracking-tight">Nombre de la Receta</h3>
            <button
              class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:text-gray-600 transition-all font-bold"
              onclick="closeRecipeModal()">√ó</button>
          </div>
          <div id="modal-recipe-details" class="recipe-details mb-8 no-scrollbar overflow-y-auto"></div>
          <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
            <button class="btn btn-secondary text-xs p-2.5" onclick="closeRecipeModal()"
              data-i18n="book.close">Cerrar</button>
            <button class="btn btn-secondary text-primary text-xs p-2.5" style="color: var(--primary)"
              onclick="editRecipe()" data-i18n="desktop.edit">Editar</button>
            <button class="btn btn-secondary text-blue-500 text-xs p-2.5" onclick="shareRecipe()"
              data-i18n="book.share">Compartir</button>
            <button class="btn btn-secondary text-purple-500 text-xs p-2.5" onclick="exportRecipeJSON()"
              data-i18n="book.export">Exportar</button>
            <button class="btn bg-red-50 text-red-500 text-xs p-2.5" onclick="deleteFromModalRecipe()"
              data-i18n="book.delete">Borrar</button>
          </div>
        </div>
      </div>

      <!-- MODAL de Donaciones -->
      <div id="donation-modal" class="modal donation-modal">
        <div class="modal-content max-w-md p-0 overflow-hidden border-0 relative shadow-2xl">
          <!-- Close Button -->
          <button
            class="absolute top-4 right-4 w-9 h-9 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:bg-gray-100 hover:text-gray-600 transition-all z-20 text-xl font-bold border border-gray-100"
            onclick="closeDonationModal()">√ó</button>

          <div class="p-6 bg-gray-50 border-b border-gray-100">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-primary/10 text-primary rounded-xl flex items-center justify-center text-lg shadow-inner">
                  <i class="fas fa-heart"></i>
                </div>
                <div>
                  <h3 class="text-lg font-black text-gray-800 tracking-tight leading-none mb-1"
                    data-i18n="donation.title">
                    Donaciones</h3>
                  <div class="text-[9px] text-gray-400 font-bold uppercase tracking-widest"
                    data-i18n="donation.support_project">Support the project</div>
                </div>
              </div>

              <!-- Bot√≥n de Instalaci√≥n din√°mico para m√≥vil -->
              <button id="modal-install-btn"
                class="hidden md:hidden items-center gap-2 bg-primary text-white text-[10px] font-bold px-3 py-2 rounded-xl shadow-lg shadow-primary/20 animate-pulse"
                style="background-color: var(--primary)" onclick="installApp()">
                <i class="fas fa-mobile-alt"></i>
                <span data-i18n="donation.install_button">Instalar</span>
              </button>
            </div>
          </div>

          <div class="iframe-container bg-white">
            <iframe src="https://nowpayments.io/embeds/donation-widget?api_key=fdda84fb-c7f9-409f-9f7d-bde15b5ab352"
              frameborder="0" scrolling="yes">
              Can't load widget
            </iframe>
          </div>
        </div>
      </div>

      <!-- MODAL de Confirmaci√≥n -->
      <div id="confirm-modal" class="modal">
        <div class="modal-content overflow-visible">
          <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-exclamation-triangle text-2xl"></i>
          </div>
          <div class="text-center mb-8">
            <h3 class="text-xl font-black text-gray-900 mb-2">Confirmar Acci√≥n</h3>
            <p id="confirm-message" class="text-gray-500 text-sm leading-relaxed"></p>
          </div>
          <div class="flex gap-4">
            <button class="flex-1 btn btn-secondary" onclick="closeConfirmModal(false)"
              data-i18n="common.cancel">Cancelar</button>
            <button class="flex-1 btn bg-red-500 text-white hover:bg-red-600" onclick="closeConfirmModal(true)"
              data-i18n="common.save">Confirmar</button>
          </div>
        </div>
      </div>

      <!-- ALL MODALS MUST BE ABOVE THIS LINE -->
      <!-- MODAL para A√±adir/Editar Ingrediente -->
      <div id="ingredient-modal-form" class="modal">
        <div class="modal-content">
          <div class="modal-header flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800" id="ing-modal-title" data-i18n="modal.add_ingredient_title">
              A√±adir Componente</h3>
            <button
              class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:text-gray-600 transition-all font-bold"
              onclick="closeIngredientModal()">√ó</button>
          </div>
          <div class="space-y-6">
            <div>
              <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                data-i18n="ingredients.ingredient_name">Nombre del Ingrediente</label>
              <input
                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                type="text" id="ing-name" placeholder="Ej: Carne de Res, Ajo, Tomate"
                data-i18n="ingredients.ingredient_name_placeholder">
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                data-i18n="ingredients.category_label">Categor√≠a</label>
              <select
                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all appearance-none"
                id="ing-category">
                <option value="food" data-i18n="ingredients.type_food">Ingrediente</option>
                <option value="supply" data-i18n="ingredients.type_supply">Insumo / Empaque</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                  data-i18n="ingredients.price">Precio (‚Ç¨)</label>
                <input
                  class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                  type="number" id="ing-cost" placeholder="0.00" step="0.01">
              </div>
              <div>
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                  data-i18n="ingredients.unit">Unidad</label>
                <select
                  class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all appearance-none"
                  id="ing-rarity"></select>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                  data-i18n="ingredients.price_type">Tipo de Precio</label>
                <select
                  class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all appearance-none"
                  id="ing-price-type" onchange="togglePackInput('ing-price-type','ing-pack-size')">
                  <option value="unit" data-i18n="ingredients.per_unit">Por unidad</option>
                  <option value="pack" data-i18n="ingredients.per_pack">Por pack</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                  data-i18n="ingredients.pack_size">Pack Size</label>
                <input
                  class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                  type="number" id="ing-pack-size" placeholder="1" value="1" min="0.01" step="0.01"
                  oninput="validatePackSize('ing-pack-size', 'ing-rarity')">
              </div>
            </div>
            <div class="flex gap-4 pt-6">
              <button class="flex-1 btn btn-secondary py-3.5" onclick="closeIngredientModal()"
                data-i18n="common.cancel">Cancelar</button>
              <button class="flex-1 btn btn-primary py-3.5" id="ing-modal-action-btn" onclick="addIngredient()"
                data-i18n="common.save">Guardar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL para A√±adir Ingrediente a Receta -->
      <div id="recipe-add-item-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800" data-i18n="modal.add_recipe_item_title">A√±adir Componente a
              Receta</h3>
            <button class="text-gray-500 hover:text-gray-700 text-xl" onclick="closeRecipeItemModal()">√ó</button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                data-i18n="recipe.ingredient">Ingrediente</label>
              <select
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-2"
                id="rec-ing-select" onchange="updateTypeSelector('mobile', 'ing')"></select>

              <label class="block text-sm font-medium text-gray-700 mb-1"
                data-i18n="recipe.supplies_section">Insumo</label>
              <select
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-2"
                id="rec-supply-select" onchange="updateTypeSelector('mobile', 'supply')"></select>

              <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="nav.my_recipes">Sub-Receta</label>
              <select
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400"
                id="rec-recipe-select" onchange="updateTypeSelector('mobile', 'recipe')"></select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" data-i18n="recipe.quantity">Cantidad</label>
              <input
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400"
                type="number" id="rec-qty" value="100" min="0.01" step="0.1">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" data-i18n="recipe.unit">Unidad</label>
              <select
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400"
                id="rec-unit-select"></select>
            </div>
            <div class="flex gap-4 pt-6">
              <button class="flex-1 btn btn-secondary py-3.5" onclick="closeRecipeItemModal()"
                data-i18n="common.cancel">Cancelar</button>
              <button class="flex-1 btn btn-primary py-3.5" onclick="addToRecipe()"
                data-i18n="common.add">A√±adir</button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL para A√±adir Unidad -->
      <div id="unit-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800" data-i18n="modal.add_unit_title">A√±adir Unidad</h3>
            <button
              class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:text-gray-600 transition-all font-bold"
              onclick="closeUnitModal()">√ó</button>
          </div>
          <div class="space-y-6">
            <div>
              <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                data-i18n="settings.unit_name">Nombre de Unidad</label>
              <input
                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                type="text" id="unit-key" placeholder="kilogramo">
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                data-i18n="settings.symbol">S√≠mbolo</label>
              <input
                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                type="text" id="unit-value" placeholder="kg">
            </div>
            <div class="flex gap-4 pt-6">
              <button class="flex-1 btn btn-secondary py-3.5" onclick="closeUnitModal()"
                data-i18n="common.cancel">Cancelar</button>
              <button class="flex-1 btn btn-primary py-3.5" onclick="addCustomUnit()"
                data-i18n="common.add">Agregar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL para A√±adir Conversi√≥n -->
      <div id="conversion-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800" data-i18n="modal.add_conversion_title">A√±adir Conversi√≥n</h3>
            <button
              class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:text-gray-600 transition-all font-bold"
              onclick="closeConversionModal()">√ó</button>
          </div>
          <div class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                  data-i18n="settings.from">De</label>
                <select
                  class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all appearance-none"
                  id="conv-from"></select>
              </div>
              <div>
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                  data-i18n="settings.to">A</label>
                <select
                  class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all appearance-none"
                  id="conv-to"></select>
              </div>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                data-i18n="settings.factor">Factor</label>
              <input
                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                type="number" id="conv-factor" placeholder="1.0" step="0.01">
              <div class="text-[10px] text-gray-400 mt-2 ml-1">1 [De] = Factor * [A]</div>
            </div>
            <div class="flex gap-4 pt-6">
              <button class="flex-1 btn btn-secondary py-3.5" onclick="closeConversionModal()"
                data-i18n="common.cancel">Cancelar</button>
              <button class="flex-1 btn btn-primary py-3.5" onclick="addConversion()"
                data-i18n="common.add">Agregar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL Para Detalles de la Receta (Nombre, Precio, Instrucciones) -->
      <div id="recipe-details-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800" data-i18n="modal.recipe_details_title">Detalles de la Receta
            </h3>
            <button
              class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:text-gray-600 transition-all font-bold"
              onclick="closeRecipeDetailsModal()">√ó</button>
          </div>
          <div class="space-y-6">
            <div>
              <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                data-i18n="recipe.recipe_name">Nombre del Plato</label>
              <input
                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                type="text" id="rec-name" placeholder="Pasta a la Carbonara" data-i18n="recipe.recipe_name_placeholder"
                oninput="updateStats()">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                  data-i18n="recipe.price">Precio de Venta (‚Ç¨)</label>
                <input
                  class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                  type="number" id="rec-price" placeholder="0.00" step="0.01" oninput="updateStats()">
              </div>
              <div>
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                  data-i18n="recipe.portions">Porciones</label>
                <input
                  class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                  type="number" id="rec-portions" placeholder="1" value="1" min="1" step="1" oninput="updateStats()">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                  data-i18n="settings.service_percentage">Gastos Servicios (%)</label>
                <input
                  class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                  type="number" id="rec-service-pct" placeholder="0" step="0.1" value="0" oninput="updateStats()">
              </div>
              <div>
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                  data-i18n="settings.profit_percentage">Margen Ganancia (%)</label>
                <input
                  class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                  type="number" id="rec-profit-pct" placeholder="0" step="0.1" value="0" oninput="updateStats()">
              </div>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1"
                data-i18n="recipe.instructions">M√©todo</label>
              <textarea
                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all no-scrollbar"
                id="rec-instructions" placeholder="Pasos..." rows="4" data-i18n="recipe.instructions_placeholder"
                oninput="updateStats()"></textarea>
            </div>
            <div class="flex gap-4 pt-6">
              <button class="flex-1 btn btn-secondary py-3.5" onclick="closeRecipeDetailsModal()"
                data-i18n="common.cancel">Cerrar</button>
              <button class="flex-1 btn btn-primary py-3.5" onclick="saveRecipeDetails()"
                data-i18n="common.confirm_changes">Confirmar Cambios</button>
            </div>
          </div>
        </div>
      </div>

      <script>
        // ====== I18N Multilenguaje System ======
        let currentLanguage = localStorage.getItem('appLanguage') || 'es';
        let i18nData = {};

        async function loadI18nData() {
          try {
            const response = await fetch(`/i18n/${currentLanguage}.json`);
            if (!response.ok) throw new Error(`Failed to load ${currentLanguage}.json`);
            i18nData = await response.json();
          } catch (e) {
            console.error('Error loading i18n:', e);
            // Fallback: try English
            if (currentLanguage !== 'en') {
              currentLanguage = 'en';
              const fallback = await fetch('/i18n/en.json');
              i18nData = await fallback.json();
            }
          }
        }

        function t(key, defaultValue = key) {
          const keys = key.split('.');
          let value = i18nData;
          for (const k of keys) {
            value = value?.[k];
            if (!value) return defaultValue;
          }
          return value;
        }

        function updateI18n() {
          document.querySelectorAll('[data-i18n]').forEach((el) => {
            const key = el.getAttribute('data-i18n');
            const text = t(key);
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
              el.placeholder = text;
            } else {
              el.textContent = text;
            }
          });
          document.documentElement.lang = currentLanguage;
        }

        async function changeLanguage(lang) {
          currentLanguage = lang;
          localStorage.setItem('appLanguage', lang);
          await loadI18nData();
          updateI18n();
          toggleLangBar(); // Close modal after selection
          showToast(t('messages.units_replaced', 'Idioma actualizado'), 'success');
        }

        function toggleLangBar() {
          const modal = document.getElementById('language-modal');
          if (modal) {
            modal.classList.toggle('active');
          }
        }

        // ====== L√≥gica de Estado ======
        let ingredients = JSON.parse(localStorage.getItem('rpg_ing') || '[]');
        let activeRecipe = JSON.parse(localStorage.getItem('rpg_recipe_draft') || '{ "items": [] }');
        let recipeBook = JSON.parse(localStorage.getItem('rpg_book') || '[]');
        let configLoaded = false;
        let currentRecipeModal = null;

        // Constantes de color (Soft Palette)
        const RARITY_COLORS = {
          common: '#CBD5E0',
          rare: '#6A994E',
          epic: '#BC4749',
          legendary: '#212529'
        };

        // ====== Funciones de Tabs (SPA - Single Page Application) ======
        function switchTab(tabId) {
          // Hide all tabs
          document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

          // Reset Sidebar Buttons
          document.querySelectorAll('[id^="sidebar-"]').forEach(btn => {
            btn.classList.remove('bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/20');
            btn.classList.add('text-gray-400');
            btn.style.backgroundColor = '';
          });

          // Reset Bottom Nav Buttons
          document.querySelectorAll('[id^="bottom-"]').forEach(btn => {
            btn.classList.remove('text-primary');
            btn.classList.add('text-gray-400');
            btn.style.color = '';
          });

          // Show selected tab
          const targetTab = document.getElementById(tabId);
          if (targetTab) targetTab.classList.add('active');

          // Activate sidebar item
          const sidebarId = 'sidebar-' + tabId.replace('tab-', '');
          const sidebarBtn = document.getElementById(sidebarId);
          if (sidebarBtn) {
            sidebarBtn.classList.remove('text-gray-400');
            sidebarBtn.classList.add('bg-primary', 'text-white', 'shadow-md');
            sidebarBtn.style.backgroundColor = 'var(--primary)';
          }

          // Activate bottom nav item
          const bottomId = 'bottom-' + tabId.replace('tab-', '');
          const bottomBtn = document.getElementById(bottomId);
          if (bottomBtn) {
            bottomBtn.classList.remove('text-gray-400');
            bottomBtn.classList.add('text-primary');
            bottomBtn.style.color = 'var(--primary)';
          }
          // Activar bot√≥n en bottom nav si existe
          if (event && event.target) event.target.classList.add('active');
          // Actualizar URL para SPA
          const tabName = tabId.replace('tab-', '');
          history.pushState({ tab: tabName }, '', `#${tabName}`);
        }

        // Manejar navegaci√≥n con el bot√≥n atr√°s/adelante
        window.addEventListener('popstate', function (event) {
          if (event.state && event.state.tab) {
            switchTabNoHistory('tab-' + event.state.tab);
          }
        });

        // Cambiar tab sin actualizar historial
        function switchTabNoHistory(tabId) {
          document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          // Remover clases activas de sidebar
          document.querySelectorAll('[id^="sidebar-"]').forEach(btn => {
            btn.classList.remove('bg-primary', 'text-white');
            btn.classList.add('text-gray-400');
            btn.style.backgroundColor = '';
          });
          // Remover clases activas de bottom nav
          document.querySelectorAll('[id^="bottom-"]').forEach(btn => {
            btn.classList.remove('text-primary');
            btn.classList.add('text-gray-400');
            btn.style.color = '';
          });
          document.getElementById(tabId).classList.add('active');
          // Activar bot√≥n correspondiente en sidebar
          const sidebarId = 'sidebar-' + tabId.replace('tab-', '');
          const sidebarBtn = document.getElementById(sidebarId);
          if (sidebarBtn) {
            sidebarBtn.classList.remove('text-gray-400');
            sidebarBtn.classList.add('bg-primary', 'text-white');
            sidebarBtn.style.backgroundColor = 'var(--primary)';
          }
          // Activar bot√≥n correspondiente en bottom nav
          const bottomId = 'bottom-' + tabId.replace('tab-', '');
          const bottomBtn = document.getElementById(bottomId);
          if (bottomBtn) {
            bottomBtn.classList.remove('text-gray-400');
            bottomBtn.classList.add('text-primary');
            bottomBtn.style.color = 'var(--primary)';
          }
          // Buscar y activar bot√≥n correspondiente
          document.querySelectorAll('.tab-button').forEach(btn => {
            if (btn.onclick && btn.onclick.toString().includes(tabId)) {
              btn.classList.add('active');
            }
          });
        }

        // Inicializar SPA con URL
        function initSPA() {
          const hash = window.location.hash.slice(1);
          if (hash && document.getElementById('tab-' + hash)) {
            switchTabNoHistory('tab-' + hash);
            history.replaceState({ tab: hash }, '', `#${hash}`);
          }
        }

        // ====== Funciones de UI ======
        function showToast(msg, type = 'info') {
          const container = document.getElementById('toast-container');
          const t = document.createElement('div');
          t.className = `toast toast-${type}`;

          let icon = 'info-circle';
          if (type === 'success') icon = 'check-circle';
          if (type === 'error') icon = 'exclamation-circle';
          if (type === 'warning') icon = 'exclamation-triangle';

          t.innerHTML = `<i class="fas fa-${icon}"></i> <span>${msg}</span>`;
          container.appendChild(t);

          // Animation out
          setTimeout(() => {
            t.style.transform = 'translateX(120%)';
            t.style.opacity = '0';
            setTimeout(() => t.remove(), 400);
          }, 3000);
        }

        // reloj eliminado - no se usa en header

        // ====== Funciones de Modal ======
        function openRecipeModal(id) {
          const recipe = recipeBook.find(r => r.id === id);
          if (!recipe) return;

          currentRecipeModal = recipe;
          const modal = document.getElementById('recipe-modal');
          const modalName = document.getElementById('modal-recipe-name');
          const modalDetails = document.getElementById('modal-recipe-details');

          modalName.textContent = recipe.name;

          const localServicePct = recipe.servicePercentage || 0;
          const localProfitPct = recipe.profitPercentage || 0;
          const serviceCost = recipe.cost * (localServicePct / 100);
          const totalCost = recipe.cost + serviceCost;
          const suggestedPrice = totalCost * (1 + localProfitPct / 100);
          const profit = recipe.price - totalCost;
          const margin = recipe.price > 0 ? (profit / recipe.price) * 100 : 0;
          const roi = totalCost > 0 ? recipe.price / totalCost : 0;
          const portions = recipe.portions || 1;
          const pricePerPortion = portions > 0 ? recipe.price / portions : 0;

          let detailsHTML = `
        <div style="margin-bottom: 15px;">
          <h4 style="color: var(--accent); font-size: 11px; margin: 0 0 10px 0; text-transform: uppercase; font-weight: 800; letter-spacing: 0.1em;">Ingredientes</h4>
          <table style="width: 100%; border-collapse: collapse; font-size: 12px; border-radius: 12px; overflow: hidden;">
            <thead>
              <tr style="background-color: var(--bg);">
                <th style="padding: 10px; text-align: left; color: var(--text-muted); font-weight: 600;">Ingrediente</th>
                <th style="padding: 10px; text-align: center; color: var(--text-muted); font-weight: 600;">Cantidad</th>
                <th style="padding: 10px; text-align: right; color: var(--text-muted); font-weight: 600;">Costo</th>
              </tr>
            </thead>
            <tbody>
              ${recipe.items.map(i => {
            const dQty = i.displayUnit ? i.displayQty : i.qty;
            const dUnit = i.displayUnit || i.rarity;
            return `
                  <tr style="border-bottom: 1px solid var(--bg);">
                    <td style="padding: 10px; color: var(--text); font-weight: 500;">${i.name}</td>
                    <td style="padding: 10px; text-align: center; color: var(--text-muted);">${dQty} ${getUnitLabel(dUnit)}</td>
                    <td style="padding: 10px; text-align: right; color: var(--text); font-weight: 600;">${(getUnitCost(i) * i.qty).toFixed(2)}‚Ç¨</td>
                  </tr>
                `}).join('')}
            </tbody>
          </table>
        </div>
        ${recipe.instructions ? `
        <div class="divider" style="height: 1px; background: var(--bg); margin: 15px 0;"></div>
        <div style="margin-bottom: 15px;">
          <h4 style="color: var(--accent); font-size: 11px; margin: 0 0 10px 0; text-transform: uppercase; font-weight: 800; letter-spacing: 0.1em;">M√©todo de Preparaci√≥n</h4>
          <div style="font-size: 12px; line-height: 1.6; color: var(--text); white-space: pre-wrap; background: var(--bg); padding: 15px; border-radius: 12px;">${recipe.instructions}</div>
        </div>
        ` : ''}
        <div class="divider" style="height: 1px; background: var(--bg); margin: 15px 0;"></div>
        <div style="margin-bottom: 15px;">
          <h4 style="color: var(--accent); font-size: 11px; margin: 0 0 10px 0; text-transform: uppercase; font-weight: 800; letter-spacing: 0.1em;">An√°lisis Financiero</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 11px;">
            <div style="background: var(--bg); padding: 12px; border-radius: 12px; border: 1px solid var(--accent-light);">
              <strong style="color: var(--text-muted)">${t('recipe.stats.base_cost')}:</strong> <span style="color: var(--text); font-weight: 700;">${recipe.cost.toFixed(2)}‚Ç¨</span>
            </div>
            <div style="background: var(--bg); padding: 12px; border-radius: 12px; border: 1px solid var(--warning);">
              <strong style="color: var(--text-muted)">${t('recipe.stats.service_cost')} (${localServicePct}%):</strong> <span style="color: var(--text); font-weight: 700;">${serviceCost.toFixed(2)}‚Ç¨</span>
            </div>
            <div style="background: var(--bg); padding: 12px; border-radius: 12px; border: 1px solid var(--primary);">
              <strong style="color: var(--text-muted)">${t('book.total_cost')}:</strong> <span style="color: var(--primary); font-weight: 900;">${totalCost.toFixed(2)}‚Ç¨</span>
            </div>
            <div style="background: var(--bg); padding: 12px; border-radius: 12px; border: 1px solid var(--accent);">
              <strong style="color: var(--text-muted)">${t('book.sale_price')}:</strong> <span style="color: var(--accent-dark); font-weight: 900;">${recipe.price.toFixed(2)}‚Ç¨</span>
            </div>
            <div style="background: var(--bg-card); padding: 12px; border-radius: 12px; border: 1px solid var(--bg);">
              <strong style="color: var(--text-muted)">Precio Sugerido (+${localProfitPct}%):</strong> <span style="color: var(--text); font-weight: 700;">${suggestedPrice.toFixed(2)}‚Ç¨</span>
            </div>
            <div style="background: var(--bg-card); padding: 12px; border-radius: 12px; border: 1px solid var(--bg);">
              <strong style="color: var(--text-muted)">${t('stats.price_per_portion')}:</strong> <span style="color: var(--text); font-weight: 700;">${pricePerPortion.toFixed(2)}‚Ç¨</span>
            </div>
          </div>
        </div>
      `;

          modalDetails.innerHTML = detailsHTML;
          modal.classList.add('active');
        }

        function closeRecipeModal() {
          document.getElementById('recipe-modal').classList.remove('active');
          currentRecipeModal = null;
        }

        function deleteFromModalRecipe() {
          if (!currentRecipeModal) return;
          showConfirmModal(`¬øEliminar la receta "${currentRecipeModal.name}"?`, (confirmed) => {
            if (confirmed) {
              recipeBook = recipeBook.filter(r => r.id !== currentRecipeModal.id);
              localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
              renderBook();
              closeRecipeModal();
              showToast(t('toasts.recipe_deleted', `Receta "${currentRecipeModal.name}" eliminada`));
            }
          });
        }

        function editRecipe() {
          if (!currentRecipeModal) return;

          // Cargar la receta en el formulario de creaci√≥n
          activeRecipe = {
            items: [...currentRecipeModal.items],
            editingId: currentRecipeModal.id
          };

          // Llenar los campos del formulario
          document.getElementById('rec-name').value = currentRecipeModal.name;
          document.getElementById('rec-price').value = currentRecipeModal.price;
          document.getElementById('rec-portions').value = currentRecipeModal.portions || 1;
          document.getElementById('rec-instructions').value = currentRecipeModal.instructions || '';

          // Cambiar el bot√≥n de guardar a "Actualizar"
          const saveBtn = document.querySelector('#tab-receta .btn-primary');
          saveBtn.textContent = 'Actualizar Receta';
          saveBtn.onclick = updateRecipe;

          // Cambiar a la tab de crear receta
          switchTab('tab-receta');

          // Renderizar los ingredientes
          renderActiveRecipe();

          // Cerrar el modal
          closeRecipeModal();

          showToast(`Editando "${currentRecipeModal.name}"`);
        }

        async function shareRecipe() {
          if (!currentRecipeModal) return;

          const recipe = currentRecipeModal;
          const portions = recipe.portions || 1;
          const pricePerPortion = portions > 0 ? recipe.price / portions : 0;
          const profit = recipe.price - recipe.cost;
          const margin = recipe.price > 0 ? (profit / recipe.price) * 100 : 0;

          const shareText = `üç≥ ${recipe.name}\nüí∞ ${t('book.sale_price')}: ${recipe.price.toFixed(2)}‚Ç¨\nüìâ ${t('book.total_cost')}: ${recipe.cost.toFixed(2)}‚Ç¨\n\n${t('modal.ingredients')}:\n${recipe.items.map(i => `- ${i.name}: ${i.qty} ${getUnitLabel(i.rarity)}`).join('\n')}\n\n${window.location.href}`;

          if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([], 'test.png')] })) {
            try {
              const imageFile = await createShareImage(recipe);
              await navigator.share({
                title: recipe.name,
                text: shareText,
                files: [imageFile],
              });
              showToast(t('toasts.shared', '¬°Compartido con imagen!'), 'success');
            } catch (error) {
              if (error.name !== 'AbortError') shareWithoutImage(shareText);
            }
          } else if (navigator.share) {
            shareWithoutImage(shareText);
          } else {
            fallbackCopyTextToClipboard(shareText);
          }
        }

        function exportRecipeJSON() {
          if (!currentRecipeModal) return;

          const recipe = currentRecipeModal;
          const data = {
            receta: recipe,
            exportDate: new Date().toISOString()
          };

          const jsonData = JSON.stringify(data, null, 2);
          const blob = new Blob([jsonData], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `receta_${recipe.name.replace(/\s+/g, '_')}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showToast('Receta exportada como JSON');
        }

        async function shareApp() {
          const shareText = `${t('share.app_share_text')}\n\n${window.location.href}`;

          // Crear una imagen simple para compartir
          const imageBlob = await createShareImage();

          // Verificar si Web Share API est√° disponible y soporta archivos
          if (navigator.share && navigator.canShare && navigator.canShare({ files: [imageBlob] })) {
            console.log('Web Share API con soporte de archivos disponible, intentando compartir con imagen...');
            const shareData = {
              title: 'Recetario √âpico',
              text: shareText,
              url: window.location.href,
              files: [imageBlob]
            };

            try {
              await navigator.share(shareData);
              console.log('Contenido compartido exitosamente con imagen');
              showToast('¬°Compartido con imagen!');
            } catch (error) {
              console.error('Error al compartir con imagen:', error);
              // Si falla compartir con imagen, intentar sin imagen
              if (error.name !== 'AbortError') {
                shareWithoutImage(shareText);
              }
            }
          } else if (navigator.share) {
            console.log('Web Share API disponible pero sin soporte de archivos, compartiendo sin imagen...');
            shareWithoutImage(shareText);
          } else {
            console.log('Web Share API no disponible, usando fallback');
            showToast('Web Share no disponible, copiando al portapapeles...');
            fallbackCopyTextToClipboard(shareText);
          }
        }

        function shareWithoutImage(shareText) {
          navigator.share({
            title: 'Recetario √âpico',
            text: shareText,
            url: window.location.href,
          }).then(() => {
            console.log('Contenido compartido exitosamente sin imagen');
            showToast('¬°Compartido exitosamente!');
          }).catch((error) => {
            console.error('Error al compartir sin imagen:', error);
            if (error.name !== 'AbortError') {
              fallbackCopyTextToClipboard(shareText);
            }
          });
        }

        async function createShareImage(recipe) {
          return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            canvas.width = 800; // Better resolution
            canvas.height = 400;
            const ctx = canvas.getContext('2d');

            // 1. Background (Sage & Cream Gradient)
            const gradient = ctx.createLinearGradient(0, 0, 800, 400);
            gradient.addColorStop(0, '#7C9D8E'); // Primary Sage
            gradient.addColorStop(1, '#8FB5A3');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 400);

            // 2. Decorative Elements (White Circles)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.beginPath(); ctx.arc(750, 50, 150, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(50, 350, 100, 0, Math.PI * 2); ctx.fill();

            // 3. Card Container (White)
            ctx.fillStyle = '#FFFFFF';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
            ctx.shadowBlur = 40;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 20;

            const margin = 50;
            const radius = 40;
            ctx.roundRect(margin, margin, 800 - margin * 2, 400 - margin * 2, radius);
            ctx.fill();

            // 4. Header Text (Localized)
            ctx.shadowBlur = 0;
            ctx.shadowOffsetY = 0;

            ctx.fillStyle = '#7C9D8E';
            ctx.font = 'bold 16px Montserrat, Arial';
            ctx.textAlign = 'left';
            ctx.fillText(t('share.app_branding').toUpperCase(), margin + 30, margin + 45);

            // 5. Recipe Name or App Name (Increased Size)
            const mainTitle = recipe ? recipe.name.toUpperCase() : t('app_name').toUpperCase();
            ctx.fillStyle = '#12141D';
            ctx.font = 'black 48px Montserrat, Arial';
            ctx.fillText(mainTitle, margin + 30, margin + 110);

            // 6. Ingredients Count or Description (Increased Size)
            const subTitle = recipe ? `${recipe.items.length} ${t('modal.ingredients').toUpperCase()}` : t('app_description').toUpperCase();
            ctx.fillStyle = '#A9B0C2';
            ctx.font = '600 20px Montserrat, Arial';
            ctx.fillText(subTitle, margin + 30, margin + 145);

            // 7. Stats Grid (Only if recipe exists)
            if (recipe) {
              const statY = margin + 210;
              const drawStat = (label, value, x, color) => {
                ctx.fillStyle = '#A9B0C2';
                ctx.font = 'bold 14px Montserrat, Arial';
                ctx.fillText(label.toUpperCase(), x, statY);

                ctx.fillStyle = color;
                ctx.font = 'black 36px Montserrat, Arial';
                ctx.fillText(value, x, statY + 45);
              };

              drawStat(t('book.total_cost'), `${recipe.cost.toFixed(2)}‚Ç¨`, margin + 30, '#EE6262');
              drawStat(t('book.sale_price'), `${recipe.price.toFixed(2)}‚Ç¨`, margin + 250, '#7C9D8E');

              const profit = recipe.price - recipe.cost;
              drawStat(t('book.net_profit'), `${profit.toFixed(2)}‚Ç¨`, margin + 480, profit >= 0 ? '#7C9D8E' : '#EE6262');
            } else {
              // App Promo Logic (localized and larger)
              ctx.fillStyle = '#7C9D8E';
              ctx.font = 'italic 24px Montserrat, Arial';
              ctx.fillText(t('share.promo_phrase'), margin + 30, margin + 210);
            }

            // 8. Footer Branding (Localized and larger)
            ctx.fillStyle = '#F8F9F5';
            ctx.fillRect(margin, 400 - margin - 60, 800 - margin * 2, 60);

            ctx.fillStyle = '#7C9D8E';
            ctx.font = 'bold 14px Montserrat, Arial';
            ctx.textAlign = 'right';
            ctx.fillText(t('share.footer_branding').toUpperCase(), 800 - margin - 30, 400 - margin - 25);

            // Convert to blob
            canvas.toBlob((blob) => {
              const file = new File([blob], 'recetario-epico.png', { type: 'image/png' });
              resolve(file);
            }, 'image/png');
          });
        }

        function fallbackCopyTextToClipboard(text) {
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();

          try {
            const successful = document.execCommand('copy');
            if (successful) {
              showToast('Enlace copiado al portapapeles');
            } else {
              showToast('No se pudo copiar. Comparte manualmente: ' + text);
            }
          } catch (error) {
            console.error('Error en fallback copy:', error);
            showToast('No se pudo copiar. Comparte manualmente: ' + text);
          }

          document.body.removeChild(textArea);
        }

        // ====== Donaciones ======
        function openDonationModal() {
          document.getElementById('donation-modal').classList.add('active');

          // L√≥gica para mostrar el bot√≥n de instalaci√≥n en m√≥vil si el prompt est√° disponible
          const modalInstallBtn = document.getElementById('modal-install-btn');
          if (modalInstallBtn) {
            if (deferredPrompt && window.innerWidth < 768) {
              modalInstallBtn.classList.remove('hidden');
              modalInstallBtn.classList.add('flex');
            } else {
              modalInstallBtn.classList.add('hidden');
              modalInstallBtn.classList.remove('flex');
            }
          }
        }

        function closeDonationModal() {
          document.getElementById('donation-modal').classList.remove('active');
        }

        // ====== Modal de Confirmaci√≥n ======
        let confirmCallback = null;

        function showConfirmModal(message, callback) {
          confirmCallback = callback;
          document.getElementById('confirm-message').textContent = message;
          document.getElementById('confirm-modal').classList.add('active');
        }

        function closeConfirmModal(confirmed) {
          const callback = confirmCallback;
          confirmCallback = null; // Limpiar antes de ejecutar para permitir re-asignaci√≥n anidada
          document.getElementById('confirm-modal').classList.remove('active');
          if (callback) {
            callback(confirmed);
          }
        }

        function copyToClipboard(text) {
          try {
            navigator.clipboard.writeText(text.toString());
            showToast(t('toasts.copied', 'Copiado al portapapeles'), 'success');
          } catch (err) {
            // Fallback
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            ta.remove();
            showToast(t('toasts.copied', 'Copiado al portapapeles'), 'success');
          }
        }

        // ====== Manejo de Ingredientes - M√ìVIL ======
        function openIngredientModal(isEdit = false) {
          const modal = document.getElementById('ingredient-modal-form');
          const title = document.getElementById('ing-modal-title');
          const actionBtn = document.getElementById('ing-modal-action-btn');

          if (!isEdit) {
            title.textContent = t('modal.add_ingredient_title');
            actionBtn.textContent = t('common.add');
            actionBtn.onclick = addIngredient;

            // Reset form
            document.getElementById('ing-name').value = '';
            document.getElementById('ing-cost').value = '';
            if (document.getElementById('ing-price-type')) document.getElementById('ing-price-type').value = 'unit';
            if (document.getElementById('ing-pack-size')) document.getElementById('ing-pack-size').value = '1';

            renderUnitsSelector('ing-rarity'); // Refresh units
          } else {
            title.textContent = t('modal.edit_ingredient_title');
            actionBtn.textContent = t('common.update');
            // onclick is set by editIngredient before calling this
          }

          modal.classList.add('active');
        }

        function closeIngredientModal() {
          document.getElementById('ingredient-modal-form').classList.remove('active');
        }

        function addIngredient() {
          const name = document.getElementById('ing-name').value.trim();
          let cost = parseFloat(document.getElementById('ing-cost').value);
          let rarity = document.getElementById('ing-rarity').value;
          const category = document.getElementById('ing-category').value || 'food';

          const priceType = document.getElementById('ing-price-type') ? document.getElementById('ing-price-type').value : 'unit';
          let packSize = document.getElementById('ing-pack-size') ? parseFloat(document.getElementById('ing-pack-size').value) || 1 : 1;

          if (!name || isNaN(cost)) return showToast(t('toasts.error', 'Faltan datos del ingrediente'));

          // Validar pack size decimal
          if (!validatePackSizeValue(packSize, rarity)) return;

          // Si el pack size es decimal, convertir a la unidad equivalente m√°s apropiada
          if (!Number.isInteger(packSize) && priceType === 'pack') {
            const equivalent = getBestEquivalentUnit(packSize, rarity);
            if (equivalent.unit !== rarity) {
              // Convertir a la nueva unidad
              packSize = equivalent.packSize;
              rarity = equivalent.unit;
              showToast(`‚úì Convertido a ${packSize} ${equivalent.unitLabel} para mayor precisi√≥n`, 'success');
            }
          }

          ingredients.push({ id: Date.now(), name, cost, rarity, priceType, packSize, category });
          saveState();
          renderIngredients();
          closeIngredientModal();
          showToast(t('toasts.ingredient_added', `${name} a√±adido a la despensa`), 'success');
        }

        function deleteIngredient(id) {
          const ing = ingredients.find(i => i.id === id);
          showConfirmModal(`¬øEliminar "${ing.name}" de la despensa?`, (confirmed) => {
            if (confirmed) {
              ingredients = ingredients.filter(i => i.id !== id);
              saveState();
              renderIngredients();
              showToast(`${ing.name} eliminado de la despensa`);
            }
          });
        }

        function editIngredient(id) {
          const ing = ingredients.find(i => i.id === id);
          if (!ing) return;

          // Open modal in edit mode (updates title)
          openIngredientModal(true);

          // Populate form
          document.getElementById('ing-name').value = ing.name;
          document.getElementById('ing-cost').value = ing.cost;
          document.getElementById('ing-rarity').value = ing.rarity;
          if (document.getElementById('ing-category')) {
            document.getElementById('ing-category').value = ing.category || 'food';
          }
          if (document.getElementById('ing-price-type')) {
            document.getElementById('ing-price-type').value = ing.priceType || 'unit';
            togglePackInput('ing-price-type', 'ing-pack-size');
          }
          if (document.getElementById('ing-pack-size')) {
            document.getElementById('ing-pack-size').value = ing.packSize || 1;
          }

          // Update action button
          const actionBtn = document.getElementById('ing-modal-action-btn');
          actionBtn.onclick = () => updateIngredient(id);
        }

        function updateIngredient(id) {
          const name = document.getElementById('ing-name').value.trim();
          let cost = parseFloat(document.getElementById('ing-cost').value);
          let rarity = document.getElementById('ing-rarity').value;
          const category = document.getElementById('ing-category').value || 'food';
          const priceType = document.getElementById('ing-price-type') ? document.getElementById('ing-price-type').value : 'unit';
          let packSize = document.getElementById('ing-pack-size') ? parseFloat(document.getElementById('ing-pack-size').value) || 1 : 1;

          if (!name || isNaN(cost)) return showToast(t('toasts.error', 'Faltan datos del ingrediente'));

          // Validar pack size decimal
          if (!validatePackSizeValue(packSize, rarity)) return;

          // Si el pack size es decimal, convertir a la unidad equivalente m√°s apropiada
          if (!Number.isInteger(packSize) && priceType === 'pack') {
            const equivalent = getBestEquivalentUnit(packSize, rarity);
            if (equivalent.unit !== rarity) {
              // Convertir a la nueva unidad
              packSize = equivalent.packSize;
              rarity = equivalent.unit;
              showToast(`‚úì Convertido a ${packSize} ${equivalent.unitLabel} para mayor precisi√≥n`, 'success');
            }
          }

          const index = ingredients.findIndex(i => i.id === id);
          if (index !== -1) {
            ingredients[index] = { ...ingredients[index], name, cost, rarity, priceType, packSize, category };
            saveState();
            renderIngredients();
            closeIngredientModal();
            showToast(`${name} ${t('messages.ingredient_updated', 'actualizado')}`, 'success');
          }
        }

        function renderIngredients() {
          const list = document.getElementById('ing-list');
          const ingSelect = document.getElementById('rec-ing-select');
          const supplySelect = document.getElementById('rec-supply-select');
          const recipeSelect = document.getElementById('rec-recipe-select');

          list.innerHTML = '';
          const placeholder = '<option value="">' + t('recipe.select_ingredient') + '</option>';
          if (ingSelect) ingSelect.innerHTML = placeholder;
          if (supplySelect) supplySelect.innerHTML = placeholder;
          if (recipeSelect) recipeSelect.innerHTML = placeholder;

          const foodItems = ingredients.filter(i => (i.category || 'food') === 'food');
          const supplyItems = ingredients.filter(i => i.category === 'supply');

          const populateSelect = (items, container) => {
            if (!container) return;
            items.forEach(ing => {
              const opt = document.createElement('option');
              opt.value = ing.id;
              opt.innerText = `${ing.name} (${getUnitLabel(ing.rarity)})`;
              container.appendChild(opt);
            });
          };

          ingredients.forEach(ing => {
            // Listado lateral m√≥vil
            const card = document.createElement('div');
            card.className = 'bg-white rounded-2xl p-4 flex justify-between items-center shadow-sm border border-gray-100/50 hover:shadow-md transition-all ing-card-mobile';
            const unitPrice = getUnitCost(ing);

            // Convertir pack size a unidad equivalente si es decimal
            let priceExtra = '';
            if (ing.priceType === 'pack') {
              const equivalent = getBestEquivalentUnit(ing.packSize, ing.rarity);
              const packSizeDisplay = Number.isInteger(equivalent.packSize)
                ? equivalent.packSize
                : equivalent.packSize.toFixed(2);
              priceExtra = ` <span class="text-[10px] bg-gray-50 px-1.5 py-0.5 rounded ml-1" style="background-color: var(--bg)">Pack: ${ing.cost.toFixed(2)}‚Ç¨ / ${packSizeDisplay} ${equivalent.unitLabel}</span>`;
            }

            const isSupply = ing.category === 'supply';
            const categoryIcon = isSupply ? 'fas fa-box' : 'fas fa-leaf';

            card.innerHTML = `
          <div class="flex-1">
            <div class="flex items-center mb-1">
              <span class="inline-block w-2.5 h-2.5 rounded-full mr-2 shadow-sm" style="background-color:${RARITY_COLORS[ing.rarity] || '#a9b0c2'}"></span>
              <i class="${categoryIcon} text-[10px] mr-1.5 opacity-40"></i>
              <b class="text-sm font-bold" style="color: var(--text)">${ing.name}</b>
            </div>
            <div class="flex items-center flex-wrap gap-1">
              <span class="text-xs font-medium" style="color: var(--text-muted)">${unitPrice.toFixed(2)}‚Ç¨ / ${getUnitLabel(ing.rarity)}</span>
              ${priceExtra}
            </div>
          </div>
          <div class="flex gap-2 ml-2">
            <button class="w-8 h-8 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:bg-accent hover:text-white transition-all" onclick="editIngredient(${ing.id})" title="${t('ingredients.edit_button')}" data-i18n-title="ingredients.edit_button">
              <i class="fas fa-edit text-xs"></i>
            </button>
            <button class="w-8 h-8 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:bg-red-50 hover:text-red-500 transition-all font-bold" onclick="deleteIngredient(${ing.id})" title="${t('ingredients.delete_button')}" data-i18n-title="ingredients.delete_button">
              <i class="fas fa-trash text-xs"></i>
            </button>
          </div>
        `;
            list.appendChild(card);
          });

          // Llenar selectores por separado
          populateSelect(foodItems, ingSelect);
          populateSelect(supplyItems, supplySelect);

          // A√ëADIR RECETAS
          if (recipeBook.length > 0 && recipeSelect) {
            recipeBook.forEach(rec => {
              const opt = document.createElement('option');
              opt.value = `R-${rec.id}`;
              opt.innerText = `${t('common.subrecipe_prefix', '[R]')} ${rec.name} (${rec.portions} ${t('book.portions')})`;
              recipeSelect.appendChild(opt);
            });
          }

          // Actualizar selectores de unidades
          renderUnitsSelector('ing-rarity');
          renderUnitsSelector('ing-rarity-desk');

          // Sincronizar con versi√≥n desktop
          renderIngredientsDesk();
        }


        // ====== Manejo de Ingredientes - ESCRITORIO ======
        function addIngredientDesk() {
          const name = document.getElementById('ing-name-desk').value.trim();
          const cost = parseFloat(document.getElementById('ing-cost-desk').value);
          const rarity = document.getElementById('ing-rarity-desk').value;
          const category = document.getElementById('ing-category-desk').value || 'food';

          if (!name || isNaN(cost)) return showToast(t('toasts.error', 'Faltan datos del ingrediente'));

          ingredients.push({ id: Date.now(), name, cost, rarity, category });
          saveState();
          renderIngredients();
          document.getElementById('ing-name-desk').value = '';
          document.getElementById('ing-cost-desk').value = '';
          showToast(`${name} a√±adido a la despensa`);
        }

        function renderIngredientsDesk() {
          const list = document.getElementById('ing-list-desk');
          const ingSelect = document.getElementById('rec-ing-select-desk');
          const supplySelect = document.getElementById('rec-supply-select-desk');
          const recipeSelect = document.getElementById('rec-recipe-select-desk');

          if (list) list.innerHTML = '';
          const placeholder = '<option value="">' + t('recipe.select_ingredient') + '</option>';
          if (ingSelect) ingSelect.innerHTML = placeholder;
          if (supplySelect) supplySelect.innerHTML = placeholder;
          if (recipeSelect) recipeSelect.innerHTML = placeholder;

          const foodItems = ingredients.filter(i => (i.category || 'food') === 'food');
          const supplyItems = ingredients.filter(i => i.category === 'supply');

          const populateSelect = (items, container) => {
            if (!container) return;
            items.forEach(ing => {
              const opt = document.createElement('option');
              opt.value = ing.id;
              opt.innerText = `${ing.name} (${getUnitLabel(ing.rarity)})`;
              container.appendChild(opt);
            });
          };

          ingredients.forEach(ing => {
            // Listado lateral escritorio
            const card = document.createElement('div');
            card.className = 'card';
            const unitPrice = getUnitCost(ing);

            // Convertir pack size a unidad equivalente si es decimal
            let priceExtra = '';
            if (ing.priceType === 'pack') {
              const equivalent = getBestEquivalentUnit(ing.packSize, ing.rarity);
              const packSizeDisplay = Number.isInteger(equivalent.packSize)
                ? equivalent.packSize
                : equivalent.packSize.toFixed(2);
              priceExtra = ` ‚Äî Pack: ${ing.cost.toFixed(2)}‚Ç¨ / ${packSizeDisplay} ${equivalent.unitLabel}`;
            }

            const isSupply = ing.category === 'supply';
            const categoryIcon = isSupply ? 'box' : 'leaf';

            card.innerHTML = `
          <div class="card-info">
            <b style="color: var(--text)"><span class="rarity-dot" style="background:${RARITY_COLORS[ing.rarity]}"></span><i class="fas fa-${categoryIcon}" style="font-size: 8px; opacity: 0.5; margin-right: 4px; color: var(--accent)"></i>${ing.name}</b>
            <span style="color: var(--text-muted)">Precio: ${unitPrice.toFixed(2)}‚Ç¨ (${getUnitLabel(ing.rarity)})${priceExtra}</span>
          </div>
          <div style="display: flex; gap: 4px;">
            <button class="btn btn-primary" style="padding:4px 6px; font-size:8px; background-color: var(--accent); border:none;" onclick="editIngredientDesk(${ing.id})">E</button>
            <button class="btn btn-danger" style="padding:4px 6px; font-size:8px; background-color: var(--primary); border:none;" onclick="deleteIngredientDesk(${ing.id})">X</button>
          </div>
        `;
            if (list) list.appendChild(card);
          });

          // Llenar selectores escritorio
          populateSelect(foodItems, ingSelect);
          populateSelect(supplyItems, supplySelect);

          // A√ëADIR RECETAS EN ESCRITORIO
          if (recipeBook.length > 0 && recipeSelect) {
            recipeBook.forEach(rec => {
              const opt = document.createElement('option');
              opt.value = `R-${rec.id}`;
              opt.innerText = `${t('common.subrecipe_prefix', '[R]')} ${rec.name}`;
              recipeSelect.appendChild(opt);
            });
          }
        }

        function deleteIngredientDesk(id) {
          const ing = ingredients.find(i => i.id === id);
          showConfirmModal(`¬øEliminar "${ing.name}" de la despensa?`, (confirmed) => {
            if (confirmed) {
              ingredients = ingredients.filter(i => i.id !== id);
              saveState();
              renderIngredients();
              showToast(`${ing.name} eliminado de la despensa`);
            }
          });
        }

        function editIngredientDesk(id) {
          const ing = ingredients.find(i => i.id === id);
          if (!ing) return;

          // Llenar los campos del formulario con los datos del ingrediente
          document.getElementById('ing-name-desk').value = ing.name;
          document.getElementById('ing-cost-desk').value = ing.cost;
          document.getElementById('ing-rarity-desk').value = ing.rarity;
          if (document.getElementById('ing-category-desk')) {
            document.getElementById('ing-category-desk').value = ing.category || 'food';
          }

          // Cambiar el bot√≥n A√±adir a Actualizar
          const addBtn = document.querySelector('#tab-ingredientes-desk .btn-primary');
          addBtn.textContent = 'Actualizar';
          addBtn.onclick = () => updateIngredientDesk(id);

          // Cambiar a la pesta√±a de ingredientes
          switchTab('tab-ingredientes');
        }

        function updateIngredientDesk(id) {
          const name = document.getElementById('ing-name-desk').value.trim();
          const cost = parseFloat(document.getElementById('ing-cost-desk').value);
          const rarity = document.getElementById('ing-rarity-desk').value;
          const category = document.getElementById('ing-category-desk').value || 'food';

          if (!name || isNaN(cost)) return showToast(t('toasts.error', 'Faltan datos del ingrediente'));

          const index = ingredients.findIndex(i => i.id === id);
          if (index !== -1) {
            ingredients[index] = { ...ingredients[index], name, cost, rarity, category };
            saveState();
            renderIngredients();
            // Resetear formulario
            document.getElementById('ing-name-desk').value = '';
            document.getElementById('ing-cost-desk').value = '';
            const addBtn = document.querySelector('#tab-ingredientes-desk .btn-primary');
            addBtn.textContent = 'A√±adir';
            addBtn.onclick = addIngredientDesk;
            showToast(`${name} actualizado`);
          }
        }

        function clearIngredientsDesk() {
          showConfirmModal("¬øSeguro que quieres vaciar la despensa? Esta acci√≥n no se puede deshacer.", (confirmed) => {
            if (confirmed) {
              ingredients = [];
              if (!configLoaded) {
                localStorage.setItem('rpg_ing', JSON.stringify(ingredients));
              }
              renderIngredients();
              showToast(t('toasts.ingredient_deleted', 'Despensa vaciada'));
            }
          });
        }

        // ====== Manejo de Recetas - M√ìVIL ======
        function openRecipeItemModal() {
          const modal = document.getElementById('recipe-add-item-modal');
          // Reset fields
          document.getElementById('rec-qty').value = '100';
          // Ensure units are loaded
          if (document.querySelector('#rec-ing-select').options.length === 0) {
            renderIngredients();
          }
          modal.classList.add('active');
        }

        function closeRecipeItemModal() {
          document.getElementById('recipe-add-item-modal').classList.remove('active');
        }

        function updateTypeSelector(view, currentType) {
          const suffix = view === 'desk' ? '-desk' : '';
          const ingSelect = document.getElementById(`rec-ing-select${suffix}`);
          const supplySelect = document.getElementById(`rec-supply-select${suffix}`);
          const recipeSelect = document.getElementById(`rec-recipe-select${suffix}`);

          // Limpiar otros si este tiene valor
          if (currentType === 'ing' && ingSelect.value) {
            if (supplySelect) supplySelect.value = '';
            if (recipeSelect) recipeSelect.value = '';
          } else if (currentType === 'supply' && supplySelect.value) {
            if (ingSelect) ingSelect.value = '';
            if (recipeSelect) recipeSelect.value = '';
          } else if (currentType === 'recipe' && recipeSelect.value) {
            if (ingSelect) ingSelect.value = '';
            if (supplySelect) supplySelect.value = '';
          }

          updateUnitSelectorWithView(view);
        }

        function updateUnitSelector() {
          updateUnitSelectorWithView('mobile');
        }

        function updateUnitSelectorDesk() {
          updateUnitSelectorWithView('desk');
        }

        function updateUnitSelectorWithView(view) {
          const suffix = view === 'desk' ? '-desk' : '';
          const ingSelect = document.getElementById(`rec-ing-select${suffix}`);
          const supplySelect = document.getElementById(`rec-supply-select${suffix}`);
          const recipeSelect = document.getElementById(`rec-recipe-select${suffix}`);
          const unitSelect = document.getElementById(`rec-unit-select${suffix}`);

          if (!unitSelect) return;
          unitSelect.innerHTML = '';

          const selectValue = (ingSelect && ingSelect.value) || (supplySelect && supplySelect.value) || (recipeSelect && recipeSelect.value);

          if (!selectValue) return;

          if (selectValue.startsWith('R-')) {
            // Es una receta, solo permitir porciones
            const opt = document.createElement('option');
            opt.value = 'porcion';
            opt.textContent = t('book.portions', 'porciones');
            unitSelect.appendChild(opt);
            unitSelect.value = 'porcion';
            return;
          }

          const ingId = parseInt(selectValue);
          const ing = ingredients.find(i => i.id === ingId);
          if (!ing) return;

          const units = getCustomUnits();
          const availableUnits = [ing.rarity]; // Siempre incluir la unidad original

          // Agregar unidades que se puedan convertir a la unidad del ingrediente
          Object.keys(customConversions).forEach(key => {
            const [from, to] = key.split('-');
            if (to === ing.rarity) {
              if (!availableUnits.includes(from)) availableUnits.push(from);
            }
          });

          // Agregar placeholder
          const placeholderOpt = document.createElement('option');
          placeholderOpt.value = '';
          placeholderOpt.textContent = t('recipe.select_unit');
          unitSelect.appendChild(placeholderOpt);

          availableUnits.forEach(unit => {
            const opt = document.createElement('option');
            opt.value = unit;
            opt.textContent = units[unit] || unit;
            unitSelect.appendChild(opt);
          });

          // Seleccionar la unidad original por defecto
          unitSelect.value = ing.rarity;
        }

        function addToRecipe() {
          const ingVal = document.getElementById('rec-ing-select').value;
          const supplyVal = document.getElementById('rec-supply-select').value;
          const recipeVal = document.getElementById('rec-recipe-select').value;
          const selectValue = ingVal || supplyVal || recipeVal;

          const qty = parseFloat(document.getElementById('rec-qty').value);
          const selectedUnit = document.getElementById('rec-unit-select').value;

          if (!selectValue || isNaN(qty) || qty < 0.01) return showToast(t('toasts.error', 'Selecci√≥n inv√°lida'));

          let itemToAdd;

          if (selectValue.startsWith('R-')) {
            // Es una receta
            const realId = parseInt(selectValue.replace('R-', ''));
            const subRec = recipeBook.find(r => r.id === realId);
            itemToAdd = {
              id: selectValue,
              name: `${t('common.recipe_prefix', '[RECETA]')} ${subRec.name}`,
              rarity: 'porcion', // Unidad virtual
              cost: 0, // El costo se calcula din√°micamente con getUnitCost
              qty: qty
            };
          } else {
            // Es un ingrediente
            const ingId = parseInt(selectValue);
            const ing = ingredients.find(i => i.id === ingId);
            let convertedQty = qty;

            if (selectedUnit !== ing.rarity) {
              convertedQty = convertUnit(qty, selectedUnit, ing.rarity);
              if (convertedQty === qty && selectedUnit !== ing.rarity) {
                showToast(`No hay equivalencia para convertir ${selectedUnit} a ${ing.rarity}, usando unidad original`);
              }
            }

            itemToAdd = {
              ...ing,
              qty: convertedQty,
              displayUnit: selectedUnit !== ing.rarity ? selectedUnit : undefined,
              displayQty: selectedUnit !== ing.rarity ? qty : undefined
            };
          }

          const existing = activeRecipe.items.find(i => i.id === itemToAdd.id);

          if (existing) {
            existing.qty += itemToAdd.qty;
            if (itemToAdd.displayUnit && existing.displayUnit === itemToAdd.displayUnit) {
              existing.displayQty += itemToAdd.displayQty;
            } else {
              delete existing.displayUnit;
              delete existing.displayQty;
            }
          } else {
            activeRecipe.items.push(itemToAdd);
          }

          renderActiveRecipe();
          updateStats();
          closeRecipeItemModal();
          showToast(`${itemToAdd.name} en la mesa`);
        }

        function renderActiveRecipe() {
          const list = document.getElementById('rec-items-list');
          list.innerHTML = '';

          const foodItems = activeRecipe.items.filter(i => (typeof i.id === 'string' && i.id.startsWith('R-')) || (i.category || 'food') === 'food');
          const supplyItems = activeRecipe.items.filter(i => i.category === 'supply');

          const renderSection = (items, titleKey) => {
            if (items.length === 0) return;

            const h = document.createElement('div');
            h.className = "text-[10px] font-black text-primary/40 uppercase tracking-widest mb-3 mt-6 first:mt-0 px-2";
            h.textContent = t(titleKey);
            list.appendChild(h);

            items.forEach((item) => {
              const index = activeRecipe.items.indexOf(item);
              const card = document.createElement('div');
              card.className = 'bg-white rounded-2xl p-4 flex justify-between items-center shadow-sm border border-gray-50 hover:border-accent/20 transition-all mb-2';

              const displayQty = item.displayUnit ? item.displayQty : item.qty;
              const displayUnit = item.displayUnit || item.rarity;
              const isRec = typeof item.id === 'string' && item.id.startsWith('R-');
              const iconClass = isRec ? 'fas fa-utensils' : (item.category === 'supply' ? 'fas fa-box' : 'fas fa-leaf');

              card.innerHTML = `
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <i class="${iconClass} text-[10px] opacity-30" style="color: var(--accent)"></i>
                <div class="font-bold text-sm" style="color: var(--text)">${item.name}</div>
              </div>
              <div class="flex items-center gap-2">
                <input type="number" value="${displayQty.toFixed(2)}" min="0.01" step="0.1" 
                  class="w-20 px-2 py-1 bg-white border border-gray-100 rounded-lg text-xs font-bold focus:ring-2 focus:ring-primary/20 outline-none" 
                  onchange="updateRecipeItemQty(${index}, this.value)" style="background-color: var(--bg); color: var(--text)">
                <span class="text-xs font-medium" style="color: var(--text-muted)">${getUnitLabel(displayUnit)}</span>
              </div>
            </div>
            <div class="text-right mr-4">
              <div class="text-[9px] font-bold uppercase tracking-wider" style="color: var(--text-muted)">Costo</div>
              <div class="text-sm font-black" style="color: var(--text)">${(getUnitCost(item) * item.qty).toFixed(2)}‚Ç¨</div>
            </div>
            <button class="w-10 h-10 flex items-center justify-center rounded-xl bg-red-50 text-red-400 hover:bg-red-500 hover:text-white transition-all outline-none" onclick="removeFromRecipe(${index})">
              <i class="fas fa-minus text-xs"></i>
            </button>
          `;
              list.appendChild(card);
            });
          };

          renderSection(foodItems, 'recipe.ingredients_section');
          renderSection(supplyItems, 'recipe.supplies_section');

          updateStats();
          renderActiveRecipeDesk();
        }

        function removeFromRecipe(index) {
          activeRecipe.items.splice(index, 1);
          renderActiveRecipe();
        }

        function updateRecipeItemQty(index, newVal) {
          const item = activeRecipe.items[index];
          const val = parseFloat(newVal) || 0;

          if (item.displayUnit) {
            item.displayQty = val;
            item.qty = convertUnit(val, item.displayUnit, item.rarity);
          } else {
            item.qty = val;
          }

          renderActiveRecipe();
          updateStats();
        }

        function updateStats() {
          const price = parseFloat(document.getElementById('rec-price').value) || 0;
          const portions = parseInt(document.getElementById('rec-portions').value) || 1;
          const localServicePct = parseFloat(document.getElementById('rec-service-pct').value) || 0;
          const localProfitPct = parseFloat(document.getElementById('rec-profit-pct').value) || 0;

          const baseCost = activeRecipe.items.reduce((acc, curr) => acc + (getUnitCost(curr) * curr.qty), 0);

          // Nuevos c√°lculos con porcentajes locales
          const serviceCost = baseCost * (localServicePct / 100);
          const totalCost = baseCost + serviceCost;
          const suggestedPrice = totalCost * (1 + localProfitPct / 100);

          // C√°lculos existentes actualizados
          const profit = price - totalCost;
          const margin = price > 0 ? (profit / price) * 100 : 0;
          const roi = totalCost > 0 ? price / totalCost : 0;
          const pricePerPortion = portions > 0 ? price / portions : 0;

          // Actualizar UI con desglose
          document.getElementById('stat-base-cost').innerText = baseCost.toFixed(2) + '‚Ç¨';
          document.getElementById('stat-service-cost').innerText = serviceCost.toFixed(2) + '‚Ç¨';
          document.getElementById('stat-total-cost').innerText = totalCost.toFixed(2) + '‚Ç¨';
          document.getElementById('stat-suggested-price').innerText = suggestedPrice.toFixed(2) + '‚Ç¨';
          document.getElementById('stat-profit').innerText = profit.toFixed(2) + '‚Ç¨';
          document.getElementById('stat-profit').style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
          document.getElementById('stat-price-per-portion').innerText = pricePerPortion.toFixed(2) + '‚Ç¨';

          // Actualizar displays de porcentajes en el resumen
          document.getElementById('display-service-pct-val').innerText = localServicePct.toFixed(1);
          document.getElementById('display-profit-pct-val').innerText = localProfitPct.toFixed(1);

          saveDraftRecipe();
        }

        function saveDraftRecipe() {
          const draft = {
            ...activeRecipe,
            name: document.getElementById('rec-name').value,
            price: parseFloat(document.getElementById('rec-price').value) || 0,
            portions: parseInt(document.getElementById('rec-portions').value) || 1,
            instructions: document.getElementById('rec-instructions').value,
            servicePercentage: parseFloat(document.getElementById('rec-service-pct').value) || 0,
            profitPercentage: parseFloat(document.getElementById('rec-profit-pct').value) || 0
          };
          localStorage.setItem('rpg_recipe_draft', JSON.stringify(draft));
        }

        function restoreDraftRecipe() {
          if (!activeRecipe.items) activeRecipe.items = [];

          document.getElementById('rec-name').value = activeRecipe.name || '';
          document.getElementById('rec-price').value = activeRecipe.price || '';
          document.getElementById('rec-portions').value = activeRecipe.portions || '1';
          document.getElementById('rec-instructions').value = activeRecipe.instructions || '';
          document.getElementById('rec-service-pct').value = activeRecipe.servicePercentage || 0;
          document.getElementById('rec-profit-pct').value = activeRecipe.profitPercentage || 0;

          document.getElementById('display-rec-name').textContent = activeRecipe.name || t('common.new_recipe');
          document.getElementById('display-rec-price').textContent = (activeRecipe.price || 0).toFixed(2) + '‚Ç¨';
          document.getElementById('display-rec-portions').textContent = activeRecipe.portions || 1;
          document.getElementById('display-service-pct-val').textContent = (activeRecipe.servicePercentage || 0).toFixed(1);
          document.getElementById('display-profit-pct-val').textContent = (activeRecipe.profitPercentage || 0).toFixed(1);

          if (activeRecipe.editingId) {
            const saveBtn = document.getElementById('btn-save-recipe');
            saveBtn.textContent = t('common.update');
            saveBtn.onclick = updateRecipe;
          }

          renderActiveRecipe();
          updateStats();
        }

        function openRecipeDetailsModal() {
          const modal = document.getElementById('recipe-details-modal');
          modal.classList.add('active');
        }

        function closeRecipeDetailsModal() {
          document.getElementById('recipe-details-modal').classList.remove('active');
        }

        function saveRecipeDetails() {
          const name = document.getElementById('rec-name').value.trim() || t('common.new_recipe');
          const price = parseFloat(document.getElementById('rec-price').value) || 0;
          const portions = parseInt(document.getElementById('rec-portions').value) || 1;
          const servicePct = parseFloat(document.getElementById('rec-service-pct').value) || 0;
          const profitPct = parseFloat(document.getElementById('rec-profit-pct').value) || 0;

          document.getElementById('display-rec-name').textContent = name;
          document.getElementById('display-rec-price').textContent = price.toFixed(2) + '‚Ç¨';
          document.getElementById('display-rec-portions').textContent = portions;
          document.getElementById('display-service-pct-val').textContent = servicePct.toFixed(1);
          document.getElementById('display-profit-pct-val').textContent = profitPct.toFixed(1);

          updateStats();
          closeRecipeDetailsModal();
        }

        function resetActiveRecipe() {
          showConfirmModal("¬øRestablecer la receta actual desde cero?", (confirmed) => {
            if (confirmed) {
              clearActiveRecipe();
              showToast("Receta restablecida");
            }
          });
        }

        function clearActiveRecipe() {
          activeRecipe = { items: [] };
          localStorage.removeItem('rpg_recipe_draft');

          // Reset Modal Fields
          document.getElementById('rec-name').value = '';
          document.getElementById('rec-price').value = '';
          document.getElementById('rec-portions').value = '1';
          document.getElementById('rec-instructions').value = '';
          document.getElementById('rec-service-pct').value = 0;
          document.getElementById('rec-profit-pct').value = 0;

          // Reset Display Fields
          document.getElementById('display-rec-name').textContent = t('common.new_recipe');
          document.getElementById('display-rec-price').textContent = '0.00‚Ç¨';
          document.getElementById('display-rec-portions').textContent = '1';
          document.getElementById('display-service-pct-val').textContent = '0.0';
          document.getElementById('display-profit-pct-val').textContent = '0.0';

          // Resetear el bot√≥n a guardar
          const saveBtn = document.getElementById('btn-save-recipe');
          saveBtn.textContent = t('recipe.save_button');
          saveBtn.onclick = saveRecipe;

          renderActiveRecipe();
          updateStats();
        }

        function editRecipe() {
          if (!currentRecipeModal) return;

          // Cargar la receta en el objeto activo
          activeRecipe = {
            items: [...currentRecipeModal.items],
            editingId: currentRecipeModal.id
          };

          // Llenar los campos del modal
          document.getElementById('rec-name').value = currentRecipeModal.name;
          document.getElementById('rec-price').value = currentRecipeModal.price;
          document.getElementById('rec-portions').value = currentRecipeModal.portions || 1;
          document.getElementById('rec-instructions').value = currentRecipeModal.instructions || '';

          // Actualizar la vista de resumen
          document.getElementById('display-rec-name').textContent = currentRecipeModal.name;
          document.getElementById('display-rec-price').textContent = currentRecipeModal.price.toFixed(2) + '‚Ç¨';
          document.getElementById('display-rec-portions').textContent = currentRecipeModal.portions || 1;

          // Llenar porcentajes
          document.getElementById('rec-service-pct').value = currentRecipeModal.servicePercentage || 0;
          document.getElementById('rec-profit-pct').value = currentRecipeModal.profitPercentage || 0;
          document.getElementById('display-service-pct-val').textContent = (currentRecipeModal.servicePercentage || 0).toFixed(1);
          document.getElementById('display-profit-pct-val').textContent = (currentRecipeModal.profitPercentage || 0).toFixed(1);

          // Cambiar el bot√≥n de guardar a "Actualizar"
          const saveBtn = document.getElementById('btn-save-recipe');
          saveBtn.textContent = t('common.update');
          saveBtn.onclick = updateRecipe;

          // Cambiar a la tab de crear receta
          switchTab('tab-receta');

          // Renderizar los ingredientes
          renderActiveRecipe();

          // Cerrar el modal de visualizaci√≥n
          closeRecipeModal();

          showToast(`Editando "${currentRecipeModal.name}"`);
        }

        function saveRecipe() {
          const name = document.getElementById('rec-name').value.trim();
          const price = parseFloat(document.getElementById('rec-price').value) || 0;
          const portions = parseInt(document.getElementById('rec-portions').value) || 1;
          const instructions = document.getElementById('rec-instructions').value.trim();

          if (!name || activeRecipe.items.length === 0) return showToast("Escribe un nombre y a√±ade ingredientes");

          // USAR RECURSI√ìN PARA EL COSTO TOTAL
          const cost = activeRecipe.items.reduce((acc, curr) => acc + (getUnitCost(curr) * curr.qty), 0);

          recipeBook.unshift({
            id: Date.now(),
            name,
            items: [...activeRecipe.items],
            price,
            portions,
            instructions,
            cost,
            servicePercentage: parseFloat(document.getElementById('rec-service-pct').value) || 0,
            profitPercentage: parseFloat(document.getElementById('rec-profit-pct').value) || 0
          });

          localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
          renderBook();
          clearActiveRecipe();
          showToast(t('toasts.recipe_added', 'Receta guardada'));
        }

        function updateRecipe() {
          const name = document.getElementById('rec-name').value.trim();
          const price = parseFloat(document.getElementById('rec-price').value) || 0;
          const portions = parseInt(document.getElementById('rec-portions').value) || 1;
          const instructions = document.getElementById('rec-instructions').value.trim();

          if (!name || activeRecipe.items.length === 0) return showToast("Escribe un nombre y a√±ade ingredientes");

          const cost = activeRecipe.items.reduce((acc, curr) => acc + (getUnitCost(curr) * curr.qty), 0);

          // Encontrar la receta existente y actualizarla
          const index = recipeBook.findIndex(r => r.id === activeRecipe.editingId);
          if (index !== -1) {
            recipeBook[index] = {
              ...recipeBook[index],
              name,
              items: [...activeRecipe.items],
              price,
              portions,
              instructions,
              cost,
              servicePercentage: parseFloat(document.getElementById('rec-service-pct').value) || 0,
              profitPercentage: parseFloat(document.getElementById('rec-profit-pct').value) || 0
            };
          }

          localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
          renderBook();
          clearActiveRecipe();
          showToast(t('toasts.recipe_updated', 'Receta actualizada'));
        }

        // ====== Manejo de Recetas - ESCRITORIO ======
        function updateUnitSelectorDesk() {
          const selectValue = document.getElementById('rec-ing-select-desk').value;
          const unitSelect = document.getElementById('rec-unit-select-desk');
          unitSelect.innerHTML = '';

          if (!selectValue) return;

          if (selectValue.startsWith('R-')) {
            const opt = document.createElement('option');
            opt.value = 'porcion';
            opt.textContent = t('book.portions', 'porciones');
            unitSelect.appendChild(opt);
            unitSelect.value = 'porcion';
            return;
          }

          const ingId = parseInt(selectValue);
          const ing = ingredients.find(i => i.id === ingId);
          if (!ing) return;

          const units = getCustomUnits();
          const availableUnits = [ing.rarity]; // Siempre incluir la unidad original

          // Agregar unidades que se puedan convertir a la unidad del ingrediente
          Object.keys(customConversions).forEach(key => {
            const [from, to] = key.split('-');
            if (to === ing.rarity) {
              if (!availableUnits.includes(from)) availableUnits.push(from);
            }
          });

          // Agregar placeholder
          const placeholderOpt = document.createElement('option');
          placeholderOpt.value = '';
          placeholderOpt.textContent = t('recipe.select_unit');
          unitSelect.appendChild(placeholderOpt);

          availableUnits.forEach(unit => {
            const opt = document.createElement('option');
            opt.value = unit;
            opt.textContent = units[unit] || unit;
            unitSelect.appendChild(opt);
          });

          // Seleccionar la unidad original por defecto
          unitSelect.value = ing.rarity;
        }

        function addToRecipeDesk() {
          const ingVal = document.getElementById('rec-ing-select-desk').value;
          const supplyVal = document.getElementById('rec-supply-select-desk').value;
          const recipeVal = document.getElementById('rec-recipe-select-desk').value;
          const selectValue = ingVal || supplyVal || recipeVal;

          const qty = parseFloat(document.getElementById('rec-qty-desk').value);
          const selectedUnit = document.getElementById('rec-unit-select-desk').value;

          if (!selectValue || isNaN(qty) || qty < 0.01) return showToast(t('toasts.error', 'Selecci√≥n inv√°lida'));

          let itemToAdd;

          if (selectValue.startsWith('R-')) {
            const realId = parseInt(selectValue.replace('R-', ''));
            const subRec = recipeBook.find(r => r.id === realId);
            itemToAdd = {
              id: selectValue,
              name: `${t('common.recipe_prefix', '[RECETA]')} ${subRec.name}`,
              rarity: 'porcion',
              cost: 0,
              qty: qty
            };
          } else {
            const ingId = parseInt(selectValue);
            const ing = ingredients.find(i => i.id === ingId);
            let convertedQty = qty;

            if (selectedUnit !== ing.rarity) {
              convertedQty = convertUnit(qty, selectedUnit, ing.rarity);
            }

            itemToAdd = {
              ...ing,
              qty: convertedQty,
              displayUnit: selectedUnit !== ing.rarity ? selectedUnit : undefined,
              displayQty: selectedUnit !== ing.rarity ? qty : undefined
            };
          }

          const existing = activeRecipe.items.find(i => i.id === itemToAdd.id);

          if (existing) {
            existing.qty += itemToAdd.qty;
            if (itemToAdd.displayUnit && existing.displayUnit === itemToAdd.displayUnit) {
              existing.displayQty += itemToAdd.displayQty;
            } else {
              delete existing.displayUnit;
              delete existing.displayQty;
            }
          } else {
            activeRecipe.items.push(itemToAdd);
          }

          renderActiveRecipe();
          updateStats();
          showToast(`${itemToAdd.name} en la mesa`);
        }

        function renderActiveRecipeDesk() {
          const list = document.getElementById('rec-items-list-desk');
          list.innerHTML = '';

          const foodItems = activeRecipe.items.filter(i => (typeof i.id === 'string' && i.id.startsWith('R-')) || (i.category || 'food') === 'food');
          const supplyItems = activeRecipe.items.filter(i => i.category === 'supply');

          const renderSection = (items, titleKey) => {
            if (items.length === 0) return;

            const h = document.createElement('div');
            h.style = "font-size: 9px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 0.1em; margin: 15px 0 8px 0; border-bottom: 1px solid #eee; padding-bottom: 4px;";
            h.textContent = t(titleKey);
            list.appendChild(h);

            items.forEach((item) => {
              const index = activeRecipe.items.indexOf(item);
              const card = document.createElement('div');
              card.className = 'card';
              const unitPrice = getUnitCost(item);
              const isRec = typeof item.id === 'string' && item.id.startsWith('R-');
              const icon = isRec ? 'utensils' : (item.category === 'supply' ? 'box' : 'leaf');

              card.innerHTML = `
            <div class="card-info">
              <div style="display:flex; align-items:center; gap:5px">
                <i class="fas fa-${icon}" style="font-size:8px; opacity:0.4"></i>
                <b>${item.name}</b>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                <input type="number" value="${item.qty}" min="0.01" step="0.1" style="width: 80px; font-size: 10px; padding: 4px;" onchange="updateRecipeItemQty(${index}, this.value)">
                <span style="font-size:10px; color:#999">${getUnitLabel(item.rarity)}</span>
              </div>
              <span style="font-size:10px">Costo: ${(unitPrice * item.qty).toFixed(2)}‚Ç¨</span>
            </div>
            <button class="btn btn-danger" style="padding:4px 8px; font-size:8px" onclick="removeFromRecipeDesk(${index})">-</button>
          `;
              list.appendChild(card);
            });
          }

          renderSection(foodItems, 'recipe.ingredients_section');
          renderSection(supplyItems, 'recipe.supplies_section');

          updateStatsDesk();
        }

        function removeFromRecipeDesk(index) {
          activeRecipe.items.splice(index, 1);
          renderActiveRecipe();
        }

        function updateStatsDesk() {
          const price = parseFloat(document.getElementById('rec-price-desk').value) || 0;
          const portions = parseInt(document.getElementById('rec-portions-desk').value) || 1;
          const cost = activeRecipe.items.reduce((acc, curr) => acc + (getUnitCost(curr) * curr.qty), 0);

          const profit = price - cost;
          const margin = price > 0 ? (profit / price) * 100 : 0;
          const roi = cost > 0 ? price / cost : 0;
          const pricePerPortion = portions > 0 ? price / portions : 0;

          document.getElementById('stat-cost-desk').innerText = cost.toFixed(2) + '‚Ç¨';
          document.getElementById('stat-profit-desk').innerText = profit.toFixed(2) + '‚Ç¨';
          document.getElementById('stat-profit-desk').style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
          document.getElementById('stat-price-per-portion-desk').innerText = pricePerPortion.toFixed(2) + '‚Ç¨';
          document.getElementById('stat-margin-desk').innerText = margin.toFixed(1) + '%';
          document.getElementById('stat-roi-desk').innerText = roi.toFixed(2) + 'x';
        }

        function clearActiveRecipeDesk() {
          activeRecipe = { items: [] };
          document.getElementById('rec-name-desk').value = '';
          document.getElementById('rec-price-desk').value = '';
          document.getElementById('rec-portions-desk').value = '1';
          document.getElementById('rec-instructions-desk').value = '';

          // Resetear el bot√≥n a guardar
          const saveBtn = document.querySelector('#desktop-view .btn-primary');
          saveBtn.textContent = 'Guardar Receta';
          saveBtn.onclick = saveRecipeDesk;

          renderActiveRecipe();
        }

        function saveRecipeDesk() {
          const name = document.getElementById('rec-name-desk').value.trim();
          const price = parseFloat(document.getElementById('rec-price-desk').value) || 0;
          const portions = parseInt(document.getElementById('rec-portions-desk').value) || 1;
          const instructions = document.getElementById('rec-instructions-desk').value.trim();

          if (!name || activeRecipe.items.length === 0) return showToast("Escribe un nombre y a√±ade ingredientes");

          const cost = activeRecipe.items.reduce((acc, curr) => acc + (getUnitCost(curr) * curr.qty), 0);

          recipeBook.unshift({
            id: Date.now(),
            name,
            items: [...activeRecipe.items],
            price,
            portions,
            instructions,
            cost
          });

          localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
          renderBook();
          clearActiveRecipeDesk();
          showToast(t('toasts.recipe_added', 'Receta guardada'));
        }

        // ====== Libro de Recetas ======
        function renderBook() {
          const container = document.getElementById('recipe-book');
          if (!container) return;
          container.innerHTML = '';

          recipeBook.forEach(rec => {
            const div = document.createElement('div');
            // Same classes as pantry cards
            div.className = 'bg-white rounded-2xl p-4 flex justify-between items-center shadow-sm border border-gray-100/50 hover:shadow-md transition-all ing-card-mobile';

            div.innerHTML = `
          <div class="flex-1 cursor-pointer" onclick="openRecipeModal(${rec.id})">
            <div class="flex items-center mb-1">
              <span class="inline-block w-2.5 h-2.5 rounded-full mr-2 shadow-sm" style="background-color: var(--accent)"></span>
              <i class="fas fa-utensils text-[10px] mr-1.5 opacity-40"></i>
              <b class="text-sm font-bold" style="color: var(--text)">${rec.name}</b>
            </div>
            <div class="flex items-center flex-wrap gap-1">
              <span class="text-xs font-medium" style="color: var(--text-muted)">${rec.portions || 1} ${t('book.portions')} ¬∑ ${rec.price.toFixed(2)}‚Ç¨</span>
            </div>
          </div>
          <div class="flex gap-2 ml-2">
            <button class="w-8 h-8 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:bg-accent hover:text-white transition-all" onclick="editRecipeFromList(${rec.id})" title="${t('desktop.edit')}">
              <i class="fas fa-edit text-xs"></i>
            </button>
            <button class="w-8 h-8 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:bg-red-50 hover:text-red-500 transition-all font-bold" onclick="deleteFromBook(${rec.id})" title="${t('book.delete')}">
              <i class="fas fa-trash text-xs"></i>
            </button>
          </div>
        `;
            container.appendChild(div);
          });

          // Sincronizar con escritorio
          renderBookDesk();
        }

        function editRecipeFromList(id) {
          const rec = recipeBook.find(r => r.id === id);
          if (!rec) return;
          currentRecipeModal = rec;
          editRecipe();
          switchTab('tab-receta');
        }


        function renderBookDesk() {
          const container = document.getElementById('recipe-book-desk');
          if (!container) return;

          container.innerHTML = '';

          recipeBook.forEach(rec => {
            const div = document.createElement('div');
            div.className = 'card cursor-pointer'; // Use pantry desk classes
            div.innerHTML = `
          <div class="card-info" onclick="openRecipeModal(${rec.id})">
            <b><span class="rarity-dot" style="background: var(--primary)"></span><i class="fas fa-utensils" style="font-size: 8px; opacity: 0.5; margin-right: 4px;"></i>${rec.name}</b>
            <span>${rec.portions || 1} ${t('book.portions')} ¬∑ Venta: ${rec.price.toFixed(2)}‚Ç¨</span>
          </div>
          <div style="display: flex; gap: 4px;">
            <button class="btn btn-primary" style="padding:4px 6px; font-size:8px" onclick="editRecipeFromList(${rec.id})">E</button>
            <button class="btn btn-danger" style="padding:4px 6px; font-size:8px" onclick="deleteFromBook(${rec.id})">X</button>
          </div>
        `;
            container.appendChild(div);
          });
        }

        function deleteFromBook(id) {
          const rec = recipeBook.find(r => r.id === id);
          showConfirmModal(`¬øEliminar la receta "${rec.name}"?`, (confirmed) => {
            if (confirmed) {
              recipeBook = recipeBook.filter(r => r.id !== id);
              localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
              renderBook();
              showToast(`Receta "${rec.name}" eliminada`);
            }
          });
        }

        // ====== Exportar/Importar Bulk ======
        function exportBulkData() {
          if (recipeBook.length === 0 && Object.keys(ingredients).length === 0) return showToast(t('toasts.no_data_export', "No hay datos para exportar"));

          const data = {
            recetas: recipeBook,
            ingredientes: ingredients,
            unidades: customUnits,
            conversiones: customConversions,
            configuracion: {
              servicePercentage: servicePercentage,
              profitPercentage: profitPercentage,
              language: currentLanguage
            },
            exportDate: new Date().toISOString(),
            version: "1.0"
          };

          const jsonData = JSON.stringify(data, null, 2);
          const blob = new Blob([jsonData], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `recetario_bulk_${new Date().toISOString().slice(0, 10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showToast(t('toasts.full_config_exported', 'Configuraci√≥n completa exportada'));
        }

        function importBulkData() {
          document.getElementById('file-input').click();
        }

        function handleFileImport() {
          const file = document.getElementById('file-input').files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const imported = JSON.parse(e.target.result);

              // Validar que sea un bulk o al menos tenga algo
              if (!imported.recetas && !imported.ingredientes && !Array.isArray(imported)) {
                return showToast(t('messages.invalid_json', "Formato JSON inv√°lido"));
              }

              showConfirmModal(
                t('confirm.bulk_import_replace', "¬øDeseas reemplazar TODOS los datos actuales con la informaci√≥n de este archivo? Esta acci√≥n no se puede deshacer."),
                (confirmed) => {
                  if (confirmed) {
                    // Soporte para formato antiguo (solo array de recetas) y nuevo bulk
                    recipeBook = Array.isArray(imported) ? imported : (imported.recetas || []);
                    ingredients = imported.ingredientes || [];
                    customUnits = imported.unidades || {};
                    customConversions = imported.conversiones || {};

                    if (imported.configuracion) {
                      servicePercentage = imported.configuracion.servicePercentage || 0;
                      profitPercentage = imported.configuracion.profitPercentage || 0;
                      if (imported.configuracion.language) {
                        currentLanguage = imported.configuracion.language;
                        localStorage.setItem('appLanguage', currentLanguage);
                      }
                    }

                    // Guardar todo en localStorage
                    localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
                    localStorage.setItem('rpg_ing', JSON.stringify(ingredients));
                    localStorage.setItem('rpg_units', JSON.stringify(customUnits));
                    localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));
                    localStorage.setItem('rpg_service_pct', servicePercentage.toString());
                    localStorage.setItem('rpg_profit_pct', profitPercentage.toString());

                    // Actualizar UI
                    document.getElementById('service-percentage').value = servicePercentage;
                    document.getElementById('profit-percentage').value = profitPercentage;

                    renderIngredients();
                    renderBook();
                    renderUnitsList();
                    renderConversionsList();
                    loadI18nData().then(() => {
                      updateI18n();
                      showToast(t('toasts.data_imported', "Datos importados correctamente"));
                    });
                  }
                }
              );
            } catch (err) {
              showToast(t('messages.error_reading_file', "Error al leer el archivo JSON"));
            }
          };
          reader.readAsText(file);
          document.getElementById('file-input').value = '';
        }


        // ====== Utilidades ======
        function getUnitLabel(rarity) {
          if (rarity === 'porcion') return t('book.portions', 'porciones');
          const units = getCustomUnits();
          return units[rarity] || rarity;
        }

        // Devuelve el coste por 1 unidad f√≠sica o por porci√≥n de receta
        function getUnitCost(item) {
          if (!item) return 0;

          // Si es una sub-receta (detectado por ID string con R-)
          if (typeof item.id === 'string' && item.id.startsWith('R-')) {
            const realId = parseInt(item.id.replace('R-', ''));
            const subRecipe = recipeBook.find(r => r.id === realId);
            if (!subRecipe) return 0;

            // Recalcular costo de la sub-receta recursivamente
            const totalSubCost = subRecipe.items.reduce((acc, curr) => acc + (getUnitCost(curr) * curr.qty), 0);
            const portions = subRecipe.portions || 1;
            return totalSubCost / portions; // Precio por porci√≥n
          }

          // Si es un ingrediente normal
          const priceType = item.priceType || 'unit';
          const packSize = parseFloat(item.packSize) || 1;
          const cost = parseFloat(item.cost) || 0;
          if (priceType === 'pack' && packSize > 0) return cost / packSize;
          return cost;
        }

        // Muestra u oculta el input de tama√±o de pack seg√∫n tipo de precio
        function togglePackInput(selectId, packInputId) {
          const sel = document.getElementById(selectId);
          const pack = document.getElementById(packInputId);
          if (!sel || !pack) return;
          if (sel.value === 'pack') {
            pack.parentElement.style.display = 'block';
          } else {
            pack.parentElement.style.display = 'block'; // lo mantenemos visible por simplicidad
          }
        }

        function saveState() {
          if (!configLoaded) {
            localStorage.setItem('rpg_ing', JSON.stringify(ingredients));
          }
        }

        function seedData() {
          if (ingredients.length > 0) {
            showConfirmModal("¬øReemplazar ingredientes actuales con datos de demo?", (confirmed) => {
              if (!confirmed) return;
              loadDemoData();
            });
          } else {
            loadDemoData();
          }

          function loadDemoData() {
            ingredients = [
              { id: 1, name: "Pechuga de Pollo", cost: 8.5, rarity: "common" },
              { id: 2, name: "Filete de Res Premium", cost: 16.0, rarity: "rare" },
              { id: 3, name: "Salm√≥n Noruego", cost: 24.0, rarity: "epic" },
              { id: 4, name: "Jam√≥n Ib√©rico", cost: 42.0, rarity: "legendary" },
              { id: 5, name: "Tomates", cost: 2.0, rarity: "common" },
              { id: 6, name: "Queso Parmesano", cost: 18.0, rarity: "rare" },
              { id: 7, name: "Champi√±ones Silvestres", cost: 12.0, rarity: "epic" },
              { id: 8, name: "Trufa Negra", cost: 85.0, rarity: "legendary" }
            ];
            if (!configLoaded) {
              localStorage.setItem('rpg_ing', JSON.stringify(ingredients));
            }
            renderIngredients();
            showToast("Ingredientes de demo cargados");
          }
        }

        function clearIngredients() {
          showConfirmModal("¬øSeguro que quieres vaciar la despensa? Esta acci√≥n no se puede deshacer.", (confirmed) => {
            if (confirmed) {
              ingredients = [];
              if (!configLoaded) {
                localStorage.setItem('rpg_ing', JSON.stringify(ingredients));
              }
              renderIngredients();
              showToast("Despensa vaciada");
            }
          });
        }

        // ====== Gesti√≥n de Unidades de Medida ======
        let customUnits = JSON.parse(localStorage.getItem('rpg_units') || '{}');
        let customConversions = JSON.parse(localStorage.getItem('rpg_conversions') || '{}');

        // Inicializar conversiones por defecto si no existen
        const DEFAULT_CONVERSIONS = {
          'kilogramo-gramo': 1000,
          'gramo-kilogramo': 0.001,
          'litro-mililitro': 1000,
          'mililitro-litro': 0.001
        };

        // Agregar conversiones por defecto si no existen
        Object.keys(DEFAULT_CONVERSIONS).forEach(key => {
          if (!customConversions[key]) {
            customConversions[key] = DEFAULT_CONVERSIONS[key];
          }
        });
        localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));

        // ====== Porcentajes de C√°lculo Contable ======
        let servicePercentage = parseFloat(localStorage.getItem('rpg_service_pct') || '0');
        let profitPercentage = parseFloat(localStorage.getItem('rpg_profit_pct') || '0');

        const DEFAULT_UNITS = {
          'kilogramo': 'kg',
          'gramo': 'g',
          'litro': 'L',
          'mililitro': 'ml',
          'unidad': 'Unidad'
        };

        // Helper para obtener el nombre traducido de una unidad
        function getUnitName(key) {
          return t(`settings.units.${key}`, key);
        }

        function getCustomUnits() {
          return Object.assign({}, DEFAULT_UNITS, customUnits);
        }

        function renderUnitsSelector(selectId) {
          const select = document.getElementById(selectId);
          if (!select) return;

          const units = getCustomUnits();
          const currentVal = select.value;
          select.innerHTML = '<option value="">' + t('ingredients.select_unit') + '</option>';

          Object.entries(units).forEach(([key, value]) => {
            const opt = document.createElement('option');
            opt.value = key;
            opt.innerText = `${getUnitName(key)} (${value})`;
            select.appendChild(opt);
          });

          if (currentVal) select.value = currentVal;
        }

        // Nueva funci√≥n centralizada para refrescar TODO lo que use unidades
        function refreshAllUnitSelectors() {
          // 1. Selectores de "rareza" (unidad base) en los modales de ingrediente
          renderUnitsSelector('ing-rarity');
          renderUnitsSelector('ing-rarity-desk');

          // 2. Selectores de conversi√≥n en el modal de a√±adir ingrediente a receta
          updateUnitSelector();
          updateUnitSelectorDesk();

          // 3. Selectores de "De" y "A" en el modal de a√±adir equivalencia
          renderConversionsList();
        }

        function renderUnitsList() {
          const list = document.getElementById('units-list');
          if (!list) return;

          list.innerHTML = '';
          const units = getCustomUnits();

          Object.entries(units).forEach(([key, value]) => {
            const isCustom = !!customUnits[key];
            const div = document.createElement('div');
            div.className = 'bg-white rounded-2xl p-4 flex justify-between items-center shadow-sm border border-gray-100/50 hover:shadow-md transition-all ing-card-mobile';
            if (!isCustom) div.classList.add('opacity-70');

            div.innerHTML = `
              <div class="flex-1">
                <div class="flex items-center mb-1">
                  <div class="w-2.5 h-2.5 rounded-full mr-2 shadow-sm ${isCustom ? 'bg-primary' : 'bg-gray-300'}" style="${isCustom ? 'background-color: var(--primary)' : ''}"></div>
                  <b class="text-sm font-bold uppercase tracking-tight" style="color: var(--text)">${getUnitName(key)}</b>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-xs font-medium" style="color: var(--text-muted)">1 ${t('common.unit')} = ${value}</span>
                </div>
              </div>
              <div class="flex gap-2 ml-2">
                ${isCustom
                ? `<button class="w-8 h-8 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:bg-red-50 hover:text-red-500 transition-all font-bold delete-unit-btn">
                       <i class="fas fa-trash text-xs"></i>
                     </button>`
                : `<span class="bg-gray-50 text-gray-400 px-2 py-1 rounded-lg text-[10px] font-bold" style="background-color: var(--bg)">${t('common.default')}</span>`
              }
              </div>
            `;

            if (isCustom) {
              div.querySelector('.delete-unit-btn').onclick = () => deleteCustomUnit(key);
            }
            list.appendChild(div);
          });
        }

        function openUnitModal() {
          document.getElementById('unit-modal').classList.add('active');
          document.getElementById('unit-key').value = '';
          document.getElementById('unit-value').value = '';
        }

        function closeUnitModal() {
          document.getElementById('unit-modal').classList.remove('active');
        }

        function addCustomUnit() {
          const key = document.getElementById('unit-key').value.trim();
          const value = document.getElementById('unit-value').value.trim();

          if (!key || !value) return showToast("Completa todos los campos");

          customUnits[key] = value;
          localStorage.setItem('rpg_units', JSON.stringify(customUnits));
          renderUnitsList();
          // REFRESCAR TODO
          refreshAllUnitSelectors();
          document.getElementById('unit-key').value = '';
          document.getElementById('unit-value').value = '';
          closeUnitModal();
          showToast(t('toasts.ingredient_added', `Unidad "${key}" agregada`));

          // Renderizar de nuevo los ingredientes para actualizar unidades
          renderIngredients();
        }

        function deleteCustomUnit(key) {
          showConfirmModal(`¬øEliminar la unidad personalizada "${key}"?`, (confirmed) => {
            if (confirmed) {
              delete customUnits[key];
              localStorage.setItem('rpg_units', JSON.stringify(customUnits));
              renderUnitsList();
              renderIngredients();
              refreshAllUnitSelectors();
              showToast(t('toasts.ingredient_deleted', `Unidad "${key}" eliminada`));
            }
          });
        }

        function resetUnits() {
          showConfirmModal("¬øRestaurar las unidades por defecto? Se perder√°n las personalizadas.", (confirmed) => {
            if (confirmed) {
              customUnits = {};
              localStorage.setItem('rpg_units', JSON.stringify(customUnits));
              renderUnitsList();
              renderIngredients();
              refreshAllUnitSelectors();
              showToast(t('toasts.ingredient_updated', 'Unidades restauradas a valores por defecto'));
            }
          });
        }

        // ====== Gesti√≥n de Conversiones ======
        function renderConversionsList() {
          const list = document.getElementById('conversions-list');
          const units = getCustomUnits();
          const unitKeys = Object.keys(units);

          // Populate selects
          const fromSelect = document.getElementById('conv-from');
          const toSelect = document.getElementById('conv-to');
          if (fromSelect && toSelect) {
            fromSelect.innerHTML = '';
            toSelect.innerHTML = '';
            unitKeys.forEach(key => {
              const opt1 = document.createElement('option');
              opt1.value = key;
              opt1.textContent = getUnitName(key);
              fromSelect.appendChild(opt1);
              const opt2 = document.createElement('option');
              opt2.value = key;
              opt2.textContent = getUnitName(key);
              toSelect.appendChild(opt2);
            });
          }

          if (!list) return;
          list.innerHTML = '';

          Object.keys(customConversions).forEach(key => {
            const [from, to] = key.split('-');
            const factor = customConversions[key];
            const div = document.createElement('div');
            div.className = 'bg-white rounded-2xl p-4 flex justify-between items-center shadow-sm border border-gray-100/50 hover:shadow-md transition-all ing-card-mobile';

            div.innerHTML = `
              <div class="flex-1">
                <div class="flex items-center mb-1">
                  <div class="w-2.5 h-2.5 rounded-full mr-2 shadow-sm bg-accent" style="background-color: var(--accent)"></div>
                  <b class="text-sm font-bold uppercase tracking-tight" style="color: var(--text)">${getUnitName(from)} ‚Üí ${getUnitName(to)}</b>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-xs font-medium" style="color: var(--text-muted)">${t('settings.factor')}: ${factor}</span>
                </div>
              </div>
              <div class="flex gap-2 ml-2">
                <button class="w-8 h-8 flex items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:bg-red-50 hover:text-red-500 transition-all font-bold delete-conv-btn">
                  <i class="fas fa-trash text-xs"></i>
                </button>
              </div>
            `;

            div.querySelector('.delete-conv-btn').onclick = () => deleteConversion(key);
            list.appendChild(div);
          });
        }

        function openConversionModal() {
          document.getElementById('conversion-modal').classList.add('active');
          renderConversionsList(); // ensures dropdowns are populated
        }

        function closeConversionModal() {
          document.getElementById('conversion-modal').classList.remove('active');
        }

        function addConversion() {
          const from = document.getElementById('conv-from').value;
          const to = document.getElementById('conv-to').value;
          const factor = parseFloat(document.getElementById('conv-factor').value);

          if (!from || !to || isNaN(factor) || factor <= 0) return showToast("Completa todos los campos correctamente");

          const key = `${from}-${to}`;
          const reverseKey = `${to}-${from}`;
          const reverseFactor = 1 / factor;

          customConversions[key] = factor;
          customConversions[reverseKey] = reverseFactor; // Agregar conversi√≥n inversa
          localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));

          // REFRESCAR SELECTORES
          refreshAllUnitSelectors();

          document.getElementById('conv-factor').value = '';
          closeConversionModal();
          showToast(t('toasts.conversions_replaced', `Conversiones ${from} ‚Üî ${to} agregadas`));
        }

        function deleteConversion(key) {
          const [from, to] = key.split('-');
          showConfirmModal(`¬øEliminar la conversi√≥n "${getUnitName(from)} ‚Üî ${getUnitName(to)}"?`, (confirmed) => {
            if (confirmed) {
              const reverseKey = `${to}-${from}`;
              delete customConversions[key];
              delete customConversions[reverseKey];

              localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));

              // Revertir ingredientes en recetas que usen esta conversi√≥n
              const revertItems = (items) => {
                items.forEach(item => {
                  if (item.displayUnit === from || item.displayUnit === to) {
                    delete item.displayUnit;
                    delete item.displayQty;
                  }
                });
              };

              revertItems(activeRecipe.items);
              recipeBook.forEach(rec => revertItems(rec.items));

              localStorage.setItem('rpg_book', JSON.stringify(recipeBook));

              renderConversionsList();
              renderActiveRecipe();
              renderBook();
              refreshAllUnitSelectors();
              showToast(t('toasts.conversions_deleted', 'Conversiones eliminadas y unidades actualizadas'));
            }
          });
        }

        function resetConversions() {
          showConfirmModal("¬øRestaurar las conversiones por defecto? Se perder√°n las personalizadas.", (confirmed) => {
            if (confirmed) {
              customConversions = {};
              localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));

              const clearDisplay = (items) => {
                items.forEach(item => {
                  delete item.displayUnit;
                  delete item.displayQty;
                });
              };

              clearDisplay(activeRecipe.items);
              recipeBook.forEach(rec => clearDisplay(rec.items));
              localStorage.setItem('rpg_book', JSON.stringify(recipeBook));

              renderConversionsList();
              renderActiveRecipe();
              renderBook();
              refreshAllUnitSelectors();
              showToast(t('toasts.conversions_replaced', 'Conversiones restauradas'));
            }
          });
        }

        function convertUnit(value, fromUnit, toUnit) {
          if (fromUnit === toUnit) return value;

          const key = `${fromUnit}-${toUnit}`;
          if (customConversions[key]) {
            return value * customConversions[key];
          }

          const reverseKey = `${toUnit}-${fromUnit}`;
          if (customConversions[reverseKey]) {
            return value / customConversions[reverseKey];
          }

          return value; // Sin conversi√≥n
        }

        // Verificar si una unidad tiene equivalencias definidas
        function hasConversions(unit) {
          return Object.keys(customConversions).some(key => {
            const [from, to] = key.split('-');
            return from === unit || to === unit;
          });
        }

        // Obtener la mejor unidad equivalente para mostrar un pack decimal
        function getBestEquivalentUnit(packSize, unit) {
          // Si es entero, no necesitamos conversi√≥n
          if (Number.isInteger(packSize)) {
            return { packSize, unit, unitLabel: getUnitLabel(unit) };
          }

          // Buscar conversiones disponibles para esta unidad
          const conversions = Object.keys(customConversions).filter(key => {
            const [from] = key.split('-');
            return from === unit;
          });

          // Si no hay conversiones, devolver tal cual
          if (conversions.length === 0) {
            return { packSize, unit, unitLabel: getUnitLabel(unit) };
          }

          // Probar cada conversi√≥n y ver cu√°l da un n√∫mero m√°s "limpio"
          let bestConversion = { packSize, unit, unitLabel: getUnitLabel(unit), score: 0 };

          conversions.forEach(key => {
            const [from, to] = key.split('-');
            const factor = customConversions[key];
            const convertedSize = packSize * factor;

            // Calcular "score" - preferimos n√∫meros enteros o con pocos decimales
            let score = 0;
            if (Number.isInteger(convertedSize)) {
              score = 1000; // Entero es lo mejor
            } else if (convertedSize >= 1) {
              // Contar decimales significativos
              const decimals = convertedSize.toString().split('.')[1]?.length || 0;
              score = 100 - decimals; // Menos decimales = mejor score
            }

            // Si este es mejor que el actual, usarlo
            if (score > bestConversion.score) {
              bestConversion = {
                packSize: convertedSize,
                unit: to,
                unitLabel: getUnitLabel(to),
                score: score
              };
            }
          });

          return bestConversion;
        }

        // Validar pack size en tiempo real
        function validatePackSize(packSizeId, rarityId) {
          const packSizeInput = document.getElementById(packSizeId);
          const raritySelect = document.getElementById(rarityId);

          if (!packSizeInput || !raritySelect) return;

          const packSize = parseFloat(packSizeInput.value);
          const rarity = raritySelect.value;

          // Si es un n√∫mero entero o la unidad tiene equivalencias, es v√°lido
          if (Number.isInteger(packSize) || hasConversions(rarity)) {
            packSizeInput.style.borderColor = '';
            packSizeInput.style.backgroundColor = '';
          } else {
            // Mostrar feedback visual
            packSizeInput.style.borderColor = '#f59e0b';
            packSizeInput.style.backgroundColor = '#fffbeb';
          }
        }

        // Validar pack size al guardar
        function validatePackSizeValue(packSize, rarity) {
          // Si es un n√∫mero entero, siempre es v√°lido
          if (Number.isInteger(packSize)) return true;

          // Si tiene decimales, verificar que la unidad tenga equivalencias
          if (!hasConversions(rarity)) {
            const unitName = getUnitName(rarity);
            showToast(`‚ö†Ô∏è No se pueden usar decimales en "${unitName}" sin equivalencias definidas. Agrega una equivalencia primero.`, 'warning');
            return false;
          }

          return true;
        }

        function resetAllData() {
          showConfirmModal("‚ö†Ô∏è ¬øSEGURO? Esto eliminar√° TODOS los datos (recetas e ingredientes). Esta acci√≥n NO se puede deshacer.", (confirmed) => {
            if (confirmed) {
              showConfirmModal("Confirma una vez m√°s para estar completamente seguro...", (confirmed2) => {
                if (confirmed2) {
                  ingredients = [];
                  recipeBook = [];
                  customUnits = {};
                  customConversions = {};
                  servicePercentage = 0;
                  profitPercentage = 0;
                  localStorage.setItem('rpg_ing', JSON.stringify(ingredients));
                  localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
                  localStorage.setItem('rpg_units', JSON.stringify(customUnits));
                  localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));
                  localStorage.setItem('rpg_service_pct', '0');
                  localStorage.setItem('rpg_profit_pct', '0');
                  document.getElementById('service-percentage').value = '0';
                  document.getElementById('profit-percentage').value = '0';
                  renderIngredients();
                  renderBook();
                  renderUnitsList();
                  renderConversionsList();
                  showToast(t('toasts.data_cleared', 'Todos los datos han sido eliminados'));
                }
              });
            }
          });
        }

        // ====== Funciones de Porcentajes Contables ======
        function updateServicePercentage(value) {
          servicePercentage = parseFloat(value) || 0;
          localStorage.setItem('rpg_service_pct', servicePercentage.toString());
          updateStats();
          updateStatsDesk();
        }

        function updateProfitPercentage(value) {
          profitPercentage = parseFloat(value) || 0;
          localStorage.setItem('rpg_profit_pct', profitPercentage.toString());
          updateStats();
          updateStatsDesk();
        }

        // Cerrar modal al hacer click fuera
        window.addEventListener('click', (event) => {
          const modal = document.getElementById('recipe-modal');
          if (event.target === modal) {
            closeRecipeModal();
          }
        });

        // ====== PWA Install Prompt ======
        let deferredPrompt = null;
        let installPromptShown = false;

        window.addEventListener('beforeinstallprompt', (e) => {
          console.log('beforeinstallprompt event fired');
          e.preventDefault();
          deferredPrompt = e;

          // Re-check donation modal button if it's already open
          const modalInstallBtn = document.getElementById('modal-install-btn');
          if (modalInstallBtn && document.getElementById('donation-modal').classList.contains('active')) {
            if (window.innerWidth < 768) {
              modalInstallBtn.classList.remove('hidden');
              modalInstallBtn.classList.add('flex');
            }
          }

          if (localStorage.getItem('pwa_dismissed') !== 'true') {
            showInstallBanner();
          }
        });

        window.addEventListener('appinstalled', (e) => {
          console.log('App installed');
          showToast('App instalada correctamente');
          dismissInstallBanner();
          localStorage.setItem('pwa_dismissed', 'true');
          deferredPrompt = null;
        });

        function showInstallBanner() {
          const banner = document.getElementById('install-banner');
          if (banner && !installPromptShown) {
            banner.classList.remove('hidden');
            banner.classList.add('flex');
            installPromptShown = true;
            // Ajustar el padding del container para dejar espacio al banner
            const container = document.querySelector('.container');
            if (container) {
              container.style.marginTop = '80px';
            }
          }
        }

        function installApp() {
          console.log('installApp called, deferredPrompt:', deferredPrompt);
          if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
              if (choiceResult.outcome === 'accepted') {
                showToast('App instalada correctamente');
                dismissInstallBanner();
                localStorage.setItem('pwa_dismissed', 'true');
              }
              deferredPrompt = null;
            });
          } else {
            console.log('deferredPrompt is null, cannot install');
            showToast('La app no se puede instalar en este momento. Aseg√∫rate de estar en un navegador compatible.');
          }
        }

        function dismissInstallBanner() {
          const banner = document.getElementById('install-banner');
          if (banner) {
            banner.style.display = 'none';
          }
          const container = document.querySelector('.container');
          if (container) {
            container.style.marginTop = '0';
          }
          localStorage.setItem('pwa_dismissed', 'true');
        }

        // Init
        window.onload = async () => {
          await loadI18nData();
          updateI18n();
          renderUnitsSelector('ing-rarity');
          renderUnitsSelector('ing-rarity-desk');
          renderIngredients();
          renderBook();
          renderUnitsList();
          renderConversionsList();
          initSPA();
          restoreDraftRecipe();

          // Inicializar valores de porcentajes
          document.getElementById('service-percentage').value = servicePercentage.toFixed(1);
          document.getElementById('profit-percentage').value = profitPercentage.toFixed(1);

          // Registrar Service Worker para PWA
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
              .then((registration) => {
                console.log('Service Worker registrado:', registration);
              })
              .catch((error) => {
                console.log('Error al registrar Service Worker:', error);
              });
          }
        };
      </script>
      <div style="position: absolute; z-index: 99999">
        <input autocomplete="off" type="checkbox" id="aadsstickymkajrk5k" hidden />
        <div style="padding-top: 0; padding-bottom: auto;">
          <div
            style="width:100%;height:auto;position:fixed;text-align:center;font-size:0;bottom:0;left:0;right:0;margin:auto">
            <label for="aadsstickymkajrk5k"
              style="top: 50%;transform: translateY(-50%);right:24px;; position: absolute;border-radius: 4px; background: rgba(248, 248, 249, 0.70); padding: 4px;z-index: 99999;cursor:pointer">
              <svg fill="#000000" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 490 490">
                <polygon
                  points="456.851,0 245,212.564 33.149,0 0.708,32.337 212.669,245.004 0.708,457.678 33.149,490 245,277.443 456.851,490 489.292,457.678 277.331,245.004 489.292,32.337 " />
              </svg>
            </label>
            <div id="frame" style="width: 100%;margin: auto;position: relative; z-index: 99998;">
              <div style="width: 70%;margin:auto;text-align:left;position: absolute;left: 0;right: 0; top:-24px">
                <a style="display:inline-block;font-size: 13px;color: #263238;padding: 4px 10px;background: #F8F8F9;text-decoration: none; border-radius: 4px 4px 0 0;"
                  id="frame-link" target="_blank"
                  href="https://aads.com/campaigns/new?source_id=2423892&source_type=ad_unit&partner=2423892">
                  Advertise here
                </a>
              </div>
              <iframe data-aa=2423892 src=//acceptable.a-ads.com/2423892/?size=Adaptive
                style='border:0; padding:0; width:70%; height:auto; overflow:hidden; margin: auto'></iframe>
            </div>
          </div>
          <style>
            #aadsstickymkajrk5k:checked+div {
              display: none;
            }
          </style>
        </div>
      </div>
      <div id="toast-container"></div>
</body>

</html>