<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#12141d">
  <meta name="description" content="Gestor de recetas con análisis de costos y rentabilidad">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23e0c36c' width='192' height='192'/><path fill='%2312141d' d='M96 48c-26.5 0-48 21.5-48 48s21.5 48 48 48 48-21.5 48-48-21.5-48-48-48zm0 80c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z'/><circle cx='96' cy='96' r='12' fill='%23e0c36c'/></svg>">
  <title>Recetario Épico — Daniel E. F. G.</title>
  <style>
    /* Custom styles for toast and modal */
    * {
      box-sizing: border-box;
    }
    #toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 200;
    }
    .toast {
      background: #333;
      color: white;
      padding: 12px;
      margin-top: 10px;
      border-radius: 4px;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 15px;
      width: 90%;
      max-width: 900px;
      border-radius: 8px;
      font-size: 14px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>

<body>

  <!-- PWA Install Banner + Language Selector -->
  <!-- Install banner -->
  <div id="install-banner" style="display: none;" class="fixed top-0 left-0 right-0 bg-gradient-to-r from-yellow-400 via-yellow-450 to-amber-400 p-4 shadow-xl text-gray-800 z-50">
    <div class="max-w-full mx-auto flex items-center justify-between gap-4 text-sm">
      <div class="flex items-center gap-3 flex-1">
        <div class="text-2xl flex-shrink-0">📱</div>
        <div class="flex-1">
          <div class="font-bold" data-i18n="donation.install_app">Instalar como App</div>
          <div class="text-xs opacity-90" data-i18n="donation.install_description">Acceso rápido sin necesidad de navegador</div>
        </div>
      </div>
      <div class="flex gap-2 flex-shrink-0">
        <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium text-xs transition-colors" onclick="installApp()" data-i18n="donation.install_button">Instalar</button>
        <button class="bg-white hover:bg-gray-100 text-gray-700 px-3 py-2 rounded-lg font-medium text-xs transition-colors" onclick="dismissInstallBanner()">✕</button>
      </div>
    </div>
  </div>

  <!-- Main container -->
  <div class="container mx-auto px-2 py-4 max-w-6xl">
  <div id="lang-bar" class="hidden fixed top-20 right-4 bg-white border-2 border-yellow-400 p-3 rounded shadow z-40">
    <div class="flex gap-2 items-center">
      <select id="lang-select" class="flex-1 bg-white text-yellow-600 border border-yellow-400 px-2 py-1 text-xs cursor-pointer rounded" onchange="changeLanguage(this.value)">
        <option value="es">Español</option>
        <option value="en">English</option>
        <option value="fr">Français</option>
        <option value="de">Deutsch</option>
        <option value="it">Italiano</option>
        <option value="pt">Português</option>
        <option value="nl">Nederlands</option>
        <option value="srn">Sranantongo</option>
      </select>
      <button class="text-gray-500 hover:text-gray-700 text-lg font-bold cursor-pointer flex-shrink-0" onclick="closeLangBar()" title="Cerrar">×</button>
    </div>
  </div>

  <div class="flex h-screen bg-yellow-50 overflow-x-hidden">
    <aside class="hidden md:flex flex-col items-center py-4 w-20 bg-gray-100">
      <button id="sidebar-ingredientes" class="w-16 h-16 flex items-center justify-center rounded hover:bg-gray-200 text-gray-600 mb-2" onclick="switchTab('tab-ingredientes')" title="Ingredientes">
        <i class="fas fa-list"></i>
      </button>
      <button id="sidebar-receta" class="w-16 h-16 flex items-center justify-center rounded hover:bg-gray-200 text-gray-600 mb-2" onclick="switchTab('tab-receta')" title="Crear Receta">
        <i class="fas fa-plus"></i>
      </button>
      <button id="sidebar-libro" class="w-16 h-16 flex items-center justify-center rounded bg-yellow-300 text-gray-800 mb-2" onclick="switchTab('tab-libro')" title="Mis Recetas">
        <i class="fas fa-book"></i>
      </button>
      <button id="sidebar-config" class="w-16 h-16 flex items-center justify-center rounded hover:bg-gray-200 text-gray-600" onclick="switchTab('tab-config')" title="Configuración">
        <i class="fas fa-cog"></i>
      </button>
    </aside>
    <main class="flex-1 md:ml-0 flex flex-col">
      <header class="bg-white shadow p-4 flex justify-between items-center">
        <div class="flex items-center">
          <div class="w-6 h-6 bg-yellow-400 rounded-full mr-2"></div>
          <h1 class="text-xl font-bold text-gray-800" data-i18n="app_name">RECETARIO ÉPICO</h1>
        </div>
        <div class="flex gap-2">
          <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm" onclick="toggleLangBar()" title="Cambiar idioma">
            <i class="fas fa-globe"></i>
          </button>
          <button class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-3 py-1 rounded text-sm" onclick="shareApp()" title="Compartir App">
            <i class="fas fa-share"></i>
          </button>
          <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm donate-btn" onclick="openDonationModal()" data-i18n="donation.title">Donar</button>
        </div>
      </header>

      <!-- Bottom Nav for Mobile -->
      <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around py-2">
        <button id="bottom-ingredientes" class="flex flex-col items-center text-gray-600 py-3 px-4" onclick="switchTab('tab-ingredientes')">
          <i class="fas fa-list"></i>
        </button>
        <button id="bottom-receta" class="flex flex-col items-center text-gray-600 py-3 px-4" onclick="switchTab('tab-receta')">
          <i class="fas fa-plus"></i>
        </button>
        <button id="bottom-libro" class="flex flex-col items-center text-yellow-600 py-3 px-4" onclick="switchTab('tab-libro')">
          <i class="fas fa-book"></i>
        </button>
        <button id="bottom-config" class="flex flex-col items-center text-gray-600 py-3 px-4" onclick="switchTab('tab-config')">
          <i class="fas fa-cog"></i>
        </button>
      </div>

      <div class="flex-1 overflow-y-auto p-4 pb-16 md:pb-4 overflow-x-hidden">

        <!-- TAB 1: INGREDIENTES -->
        <div id="tab-ingredientes" class="tab-content">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <section class="bg-white rounded-lg shadow p-6">
              <h2 class="text-lg font-semibold text-gray-800 mb-4" data-i18n="ingredients.title">Ingredientes</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700" data-i18n="ingredients.ingredient_name">Nombre del Ingrediente</label>
                  <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400" type="text" id="ing-name" placeholder="Ej: Carne de Res, Ajo, Tomate" data-i18n="ingredients.ingredient_name_placeholder">
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700" data-i18n="ingredients.price">Precio (€)</label>
                    <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400" type="number" id="ing-cost" placeholder="0.00" step="0.01">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700" data-i18n="ingredients.unit">Unidad</label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400" id="ing-rarity"></select>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700" data-i18n="ingredients.price_type">Tipo de Precio</label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400" id="ing-price-type" onchange="togglePackInput('ing-price-type','ing-pack-size')">
                      <option value="unit" data-i18n="ingredients.per_unit">Por unidad</option>
                      <option value="pack" data-i18n="ingredients.per_pack">Por pack</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700" data-i18n="ingredients.pack_size">Tamaño del Pack (cantidad)</label>
                    <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400" type="number" id="ing-pack-size" placeholder="1" value="1" min="1" step="1">
                  </div>
                </div>
                <div class="flex gap-2">
                  <button class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-4 py-2 rounded" onclick="addIngredient()" data-i18n="ingredients.add_button">Añadir</button>
                  <button class="bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded" onclick="clearIngredients()">Vaciar</button>
                </div>
              </div>
            </section>
            <section class="bg-white rounded-lg shadow p-6">
              <h3 class="text-md font-semibold text-gray-800 mb-4" data-i18n="ingredients.list_title">Despensa</h3>
              <div class="space-y-2" id="ing-list">
                <!-- Listado de ingredientes -->
              </div>
            </section>
          </div>
        </div>

    <!-- TAB 2: CREAR RECETA -->
    <div id="tab-receta" class="tab-content">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- COLUMNA IZQUIERDA: FORMULARIO -->
        <section class="bg-white rounded-lg shadow p-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-4" data-i18n="recipe.title">Creador de Recetas</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700" data-i18n="recipe.recipe_name">Nombre del Plato</label>
              <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400" type="text" id="rec-name" placeholder="Pasta a la Carbonara" data-i18n="recipe.recipe_name_placeholder">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700" data-i18n="recipe.ingredient">Ingrediente</label>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400" id="rec-ing-select" onchange="updateUnitSelector()"></select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700" data-i18n="recipe.quantity">Cantidad</label>
                <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400" type="number" id="rec-qty" value="100" min="0.01" step="0.1">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700" data-i18n="recipe.unit">Unidad</label>
              <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400" id="rec-unit-select"></select>
            </div>
            
            <div class="flex gap-2">
              <button class="flex-1 bg-green-400 hover:bg-green-500 text-white px-4 py-2 rounded" onclick="addToRecipe()" data-i18n="recipe.add_button">Añadir</button>
              <button class="flex-1 bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded" onclick="clearActiveRecipe()" data-i18n="recipe.clear_button">Limpiar</button>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700" data-i18n="recipe.price">Precio del Plato (€)</label>
                <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400" type="number" id="rec-price" placeholder="0.00" step="0.01" oninput="updateStats()">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700" data-i18n="recipe.portions">Porciones</label>
                <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400" type="number" id="rec-portions" placeholder="1" value="1" min="1" step="1" oninput="updateStats()">
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700" data-i18n="recipe.instructions">Método de Preparación</label>
              <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400" id="rec-instructions" placeholder="Describe los pasos para preparar la receta..." rows="3"></textarea>
            </div>

            <button class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-4 py-2 rounded font-semibold" onclick="saveRecipe()" data-i18n="recipe.save_button">Guardar Receta</button>
          </div>
        </section>

        <!-- COLUMNA DERECHA: INGREDIENTES Y ESTADÍSTICAS -->
        <section class="bg-white rounded-lg shadow p-6 space-y-4">
          <div>
            <h3 class="text-sm font-semibold text-gray-800 mb-2" data-i18n="recipe.selected_ingredients">Ingredientes Seleccionados</h3>
            <div class="max-h-32 overflow-y-auto border rounded p-2 bg-gray-50 text-sm" id="rec-items-list">
              <!-- Ingredientes seleccionados -->
            </div>
          </div>

          <div class="border-t pt-3">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Análisis Financiero</h3>
            <div class="space-y-1">
              <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-2 rounded border border-green-200">
                <div class="text-xs text-gray-600" data-i18n="recipe.stats.cost">Costo Ingredientes</div>
                <div class="text-lg font-bold text-green-700" id="stat-cost">0.00€</div>
              </div>
              <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-2 rounded border border-blue-200">
                <div class="text-xs text-gray-600">Precio Venta</div>
                <div class="text-lg font-bold text-blue-700" id="stat-price">0.00€</div>
              </div>
              <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-2 rounded border border-purple-200">
                <div class="text-xs text-gray-600" data-i18n="recipe.stats.profit">Beneficio Neto</div>
                <div class="text-lg font-bold text-purple-700" id="stat-profit">0.00€</div>
              </div>
              <div class="grid grid-cols-2 gap-1">
                <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                  <div class="text-xs text-gray-600" data-i18n="recipe.stats.price_per_portion">Precio/Porción</div>
                  <div class="text-base font-bold text-yellow-700" id="stat-price-per-portion">0.00€</div>
                </div>
                <div class="bg-orange-50 p-2 rounded border border-orange-200">
                  <div class="text-xs text-gray-600" data-i18n="recipe.stats.margin">Margen %</div>
                  <div class="text-base font-bold text-orange-700" id="stat-margin">0%</div>
                </div>
              </div>
              <div class="bg-red-50 p-2 rounded border border-red-200">
                <div class="text-xs text-gray-600" data-i18n="recipe.stats.roi">Rentabilidad (ROI)</div>
                <div class="text-base font-bold text-red-700" id="stat-roi">0.00x</div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- TAB 3: LIBRO DE RECETAS -->
    <div id="tab-libro" class="tab-content active">
      <section class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4" data-i18n="book.title">Mis Recetas</h2>
        <div id="recipe-book" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
          <!-- Recetas guardadas -->
        </div>
        <div class="flex gap-2 mt-4">
          <button class="flex-1 bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-3 py-2 rounded text-sm" onclick="exportRecipeBook()">Exportar JSON</button>
          <button class="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-3 py-2 rounded text-sm" onclick="importRecipeBook()">Importar JSON</button>
        </div>
        <input type="file" id="file-input" class="hidden" accept=".json" onchange="handleFileImport()">
        <input type="file" id="recipe-file-input" class="hidden" accept=".json" onchange="handleRecipeImport()">
        <input type="file" id="units-file-input" class="hidden" accept=".json" onchange="handleUnitsImport()">
      </section>
    </div>

    <!-- TAB 4: CONFIGURACIÓN -->
    <div id="tab-config" class="tab-content">
      <section class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4" data-i18n="settings.title">Configuración</h2>

        <h3 class="text-yellow-600 text-sm font-semibold uppercase mb-3" data-i18n="settings.units_title">Unidades de Medida</h3>
        <div id="units-list" class="mb-4 max-h-48 overflow-y-auto"></div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.unit_name">Nombre de Unidad</label>
            <input class="w-full px-2 py-1 border border-gray-300 rounded text-sm" type="text" id="unit-key" placeholder="kilogramo">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.symbol">Símbolo</label>
            <input class="w-full px-2 py-1 border border-gray-300 rounded text-sm" type="text" id="unit-value" placeholder="kg">
          </div>
        </div>
        <div class="flex gap-2 mb-6">
          <button class="flex-1 bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-3 py-2 rounded text-sm" onclick="addCustomUnit()" data-i18n="settings.add_unit">Agregar</button>
          <button class="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-3 py-2 rounded text-sm" onclick="resetUnits()" data-i18n="settings.reset_units">Restaurar</button>
        </div>

        <div class="border-t pt-6 mb-6"></div>

        <h3 class="text-yellow-600 text-sm font-semibold uppercase mb-3" data-i18n="settings.conversions_title">Equivalencias de Unidades</h3>
        <div id="conversions-list" class="mb-4 max-h-48 overflow-y-auto"></div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.from">De</label>
            <select class="w-full px-2 py-1 border border-gray-300 rounded text-sm" id="conv-from"></select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.to">A</label>
            <select class="w-full px-2 py-1 border border-gray-300 rounded text-sm" id="conv-to"></select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.factor">Factor</label>
            <input class="w-full px-2 py-1 border border-gray-300 rounded text-sm" type="number" id="conv-factor" placeholder="1.0" step="0.01">
          </div>
        </div>
        <div class="flex gap-2 mb-4">
          <button class="flex-1 bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-3 py-2 rounded text-sm" onclick="addConversion()" data-i18n="settings.add_conversion">Agregar Conversión</button>
          <button class="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-3 py-2 rounded text-sm" onclick="resetConversions()" data-i18n="settings.reset_conversions">Restaurar</button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
          <button class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-3 py-2 rounded text-sm" onclick="exportUnitsAndConversions()" data-i18n="settings.export_units">Exportar Unidades</button>
          <button class="bg-gray-400 hover:bg-gray-500 text-white px-3 py-2 rounded text-sm" onclick="importUnitsAndConversions()" data-i18n="settings.import_units">Importar Unidades</button>
        </div>

        <div class="border-t pt-6"></div>

        <h3 class="text-yellow-600 text-sm font-semibold uppercase mb-3" data-i18n="settings.data_title">Datos</h3>
        <div class="space-y-2">
          <button class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-3 py-2 rounded" onclick="exportRecipeBook()" data-i18n="settings.export_all">Exportar Todo (Recetas + Ingredientes)</button>
          <button class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-3 py-2 rounded" onclick="importRecipeBook()" data-i18n="settings.import_data">Importar Datos</button>
          <button class="w-full bg-red-400 hover:bg-red-500 text-white px-3 py-2 rounded" onclick="resetAllData()" data-i18n="settings.clear_all">Limpiar Todo (⚠️)</button>
        </div>
      </section>
    </div>

    <!-- VISTA ORIGINAL ESCRITORIO -->
    <div class="main-grid" id="desktop-view" style="display: none;">
      <!-- PANEL IZQUIERDO: INGREDIENTES -->
      <section class="panel">
        <h2 data-i18n="desktop.ingredients">Ingredientes</h2>
        <div class="form-group">
          <label data-i18n="ingredients.ingredient_name">Nombre del Ingrediente</label>
          <input type="text" id="ing-name-desk" placeholder="Ej: Carne de Res, Ajo, Tomate" data-i18n="ingredients.ingredient_name_placeholder">
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
          <div class="form-group">
            <label data-i18n="ingredients.price">Precio (€)</label>
            <input type="number" id="ing-cost-desk" placeholder="0.00" step="0.01">
          </div>
          <div class="form-group">
            <label data-i18n="ingredients.unit">Unidad</label>
            <select id="ing-rarity-desk"></select>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px">
          <div class="form-group">
            <label data-i18n="ingredients.price_type">Tipo de Precio</label>
            <select id="ing-price-type-desk" onchange="togglePackInput('ing-price-type-desk','ing-pack-size-desk')">
              <option value="unit" data-i18n="ingredients.per_unit">Por unidad</option>
              <option value="pack" data-i18n="ingredients.per_pack">Por pack</option>
            </select>
          </div>
          <div class="form-group">
            <label data-i18n="ingredients.pack_size">Tamaño del Pack (cantidad)</label>
            <input type="number" id="ing-pack-size-desk" placeholder="1" value="1" min="1" step="1">
          </div>
        </div>
        <div class="btn-grid">
          <button class="btn btn-primary" onclick="addIngredientDesk()" data-i18n="desktop.add_ingredient">Añadir</button>
          <button class="btn btn-danger" onclick="clearIngredientsDesk()">Vaciar</button>
        </div>

        <div class="divider"></div>
        <label data-i18n="ingredients.list_title">Despensa</label>
        <div class="list-container" id="ing-list-desk">
          <!-- Listado de ingredientes -->
        </div>
      </section>

      <!-- PANEL DERECHO: COCINA -->
      <section class="panel">
        <h2 data-i18n="recipe.title">Creador de Recetas</h2>
        <div class="form-group">
          <label data-i18n="recipe.recipe_name">Nombre del Plato</label>
          <input type="text" id="rec-name-desk" placeholder="Pasta a la Carbonara" data-i18n="recipe.recipe_name_placeholder">
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
          <div class="form-group">
            <label data-i18n="recipe.ingredient">Ingrediente</label>
            <select id="rec-ing-select-desk" onchange="updateUnitSelectorDesk()"></select>
          </div>
          <div class="form-group">
            <label data-i18n="recipe.quantity">Cantidad</label>
            <input type="number" id="rec-qty-desk" value="100" min="0.01" step="0.1">
          </div>
        </div>
        <div class="form-group">
          <label data-i18n="recipe.unit">Unidad</label>
          <select id="rec-unit-select-desk"></select>
        </div>

        <div class="btn-grid">
          <button class="btn btn-success" onclick="addToRecipeDesk()" data-i18n="recipe.add_button">Añadir</button>
          <button class="btn btn-danger" onclick="clearActiveRecipeDesk()" data-i18n="desktop.clear_recipe">Limpiar</button>
        </div>

        <div class="divider"></div>
        <label data-i18n="recipe.selected_ingredients">Ingredientes Seleccionados</label>
        <div class="list-container" id="rec-items-list-desk" style="max-height: 180px;"></div>

        <div class="form-group" style="margin-top:15px">
          <label data-i18n="recipe.price">Precio del Plato (€)</label>
          <input type="number" id="rec-price-desk" placeholder="0.00" step="0.01" oninput="updateStatsDesk()">
        </div>

        <div class="form-group">
          <label data-i18n="recipe.portions">Porciones</label>
          <input type="number" id="rec-portions-desk" placeholder="1" value="1" min="1" step="1" oninput="updateStatsDesk()">
        </div>

        <div class="form-group">
          <label data-i18n="recipe.instructions">Método de Preparación</label>
          <textarea id="rec-instructions-desk" placeholder="Describe los pasos para preparar la receta..." rows="4"></textarea>
        </div>

        <div class="stats-box">
          <div class="stat-card">
            <span class="stat-label" data-i18n="recipe.stats.cost">Costo Ingredientes</span>
            <div class="stat-val" id="stat-cost-desk">0.00€</div>
          </div>
          <div class="stat-card">
            <span class="stat-label" data-i18n="recipe.stats.profit">Beneficio Neto</span>
            <div class="stat-val" id="stat-profit-desk">0.00€</div>
          </div>
          <div class="stat-card">
            <span class="stat-label" data-i18n="recipe.stats.price_per_portion">Precio por Porción</span>
            <div class="stat-val" id="stat-price-per-portion-desk">0.00€</div>
          </div>
          <div class="stat-card">
            <span class="stat-label" data-i18n="recipe.stats.margin">Margen %</span>
            <div class="stat-val" id="stat-margin-desk">0%</div>
          </div>
          <div class="stat-card">
            <span class="stat-label" data-i18n="recipe.stats.roi">Rentabilidad</span>
            <div class="stat-val" id="stat-roi-desk">0.00x</div>
          </div>
        </div>

        <div class="btn-grid" style="margin-top:20px">
          <button class="btn btn-primary" style="flex:1" onclick="saveRecipeDesk()" data-i18n="desktop.save_recipe">Guardar Receta</button>
        </div>
      </section>
    </div>

    <!-- RECETAS GUARDADAS ESCRITORIO -->
    <section class="panel" style="margin-top:20px; display: none;" id="recipe-book-section-desk">
      <h2 data-i18n="desktop.my_recipes">Mis Recetas
        <div style="display:flex; gap:5px; justify-self:end">
          <button class="btn btn-secondary" style="padding:5px 10px; font-size:9px"
            onclick="exportRecipeBook()">Exportar JSON</button>
          <button class="btn btn-secondary" style="padding:5px 10px; font-size:9px"
            onclick="importRecipeBook()">Importar JSON</button>
          <button class="btn btn-info" style="padding:5px 10px; font-size:9px"
            onclick="importSingleRecipe()">Importar Receta</button>
        </div>
      </h2>
      <div id="recipe-book-desk" class="list-container"
        style="max-height: 400px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px;">
        <!-- Recetas guardadas -->
      </div>
      <input type="file" id="recipe-file-input-desk" style="display:none;" accept=".json" onchange="handleRecipeImport()">
    </section>
  </div>

  <!-- MODAL para ver detalles de receta -->
  <div id="recipe-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header flex justify-between items-center mb-4">
        <h3 id="modal-recipe-name" class="text-lg font-semibold text-gray-800">Nombre de la Receta</h3>
        <button class="text-gray-500 hover:text-gray-700 text-xl" onclick="closeRecipeModal()">×</button>
      </div>
      <div id="modal-recipe-details" class="recipe-details mb-4"></div>
      <div class="flex gap-2">
        <button class="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-3 py-2 rounded" onclick="closeRecipeModal()">Cerrar</button>
        <button class="flex-1 bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-3 py-2 rounded" onclick="editRecipe()">Editar</button>
        <button class="flex-1 bg-blue-400 hover:bg-blue-500 text-white px-3 py-2 rounded" onclick="shareRecipe()">Compartir</button>
        <button class="flex-1 bg-purple-400 hover:bg-purple-500 text-white px-3 py-2 rounded" onclick="exportRecipeJSON()">Exportar JSON</button>
        <button class="flex-1 bg-red-400 hover:bg-red-500 text-white px-3 py-2 rounded" onclick="deleteFromModalRecipe()">Borrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL de Donaciones -->
  <!-- Modal de Donaciones -->
  <div id="donation-modal" class="modal">
    <div class="modal-content max-w-6xl w-full flex flex-col">
      <!-- Header Fijo -->
      <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-200 flex-shrink-0">
        <h2 class="text-2xl font-bold text-gray-800" data-i18n="donation.title">Donaciones</h2>
        <button class="text-gray-400 hover:text-gray-600 text-2xl font-light transition-colors" onclick="closeDonationModal()">×</button>
      </div>

      <!-- Grid Principal - Scrolleable -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-1 overflow-y-auto pr-2">
        <!-- Columna Izquierda: Contenido -->
        <div class="space-y-6">
          <!-- Sección: Apoya el Proyecto -->
          <div class="bg-gradient-to-br from-yellow-50 to-amber-50 border border-yellow-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center gap-2">
              <span class="text-2xl">💡</span>
              <span data-i18n="donation.support_project">Apoya el Proyecto</span>
            </h3>
            <p class="text-sm text-gray-700 leading-relaxed" data-i18n="donation.support_description">Soy un desarrollador independiente y necesito tu ayuda. Puedes donar mediante el widget o usando estos métodos P2P</p>
          </div>

          <!-- Sección: Instalar App -->
          <div id="install-prompt" class="hidden bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center gap-2">
              <span class="text-2xl">📱</span>
              <span data-i18n="donation.install_app">Instalar como App</span>
            </h3>
            <p class="text-sm text-gray-700 mb-4 leading-relaxed" data-i18n="donation.install_description">Guarda Recetario en tu dispositivo para acceso rápido sin conexión</p>
            <div class="flex gap-3">
              <button class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium px-4 py-2 rounded-lg transition-colors text-sm" onclick="installApp()" data-i18n="donation.install_button">Instalar</button>
              <button class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium px-4 py-2 rounded-lg transition-colors text-sm" onclick="dismissInstallBanner()" data-i18n="donation.later">Ahora no</button>
            </div>
          </div>

          <!-- Sección: Métodos de Pago -->
          <div class="space-y-4">
            <!-- Digicel -->
            <div class="bg-white border border-gray-200 rounded-lg p-5 hover:shadow-md transition-shadow">
              <h4 class="text-base font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <span class="text-xl">📱</span>
                <span data-i18n="donation.digicel_label">Digicel Mobile Money</span>
              </h4>
              <div class="bg-gray-50 border border-gray-200 rounded px-3 py-2 mb-4 font-mono text-sm text-gray-700 text-center">+5977479759</div>
              <div class="flex gap-2">
                <button class="flex-1 bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-medium px-3 py-2 rounded-lg transition-colors text-sm" onclick="copyToClipboard('+5977479759')" data-i18n="donation.copy_button">Copiar</button>
                <a class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium px-3 py-2 rounded-lg text-center no-underline transition-colors text-sm" href="https://topup.digicelgroup.com/" target="_blank" data-i18n="donation.digicel_topup">Recargar</a>
              </div>
            </div>

            <!-- Crypto -->
            <div class="bg-white border border-gray-200 rounded-lg p-5 hover:shadow-md transition-shadow">
              <h4 class="text-base font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <span class="text-xl">₿</span>
                <span data-i18n="donation.crypto_label">USDC (Polygon Network)</span>
              </h4>
              <div id="crypto-address" class="bg-gray-50 border border-gray-200 rounded px-3 py-2 mb-4 font-mono text-xs text-gray-700 text-center break-all leading-relaxed">0xFeedf38871ee992CF91d2e2A722b8c3073F81a32</div>
              <div class="flex gap-2">
                <button class="flex-1 bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-medium px-3 py-2 rounded-lg transition-colors text-sm" onclick="copyToClipboard(document.getElementById('crypto-address').innerText)" data-i18n="donation.copy_button">Copiar</button>
                <a class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-medium px-3 py-2 rounded-lg text-center no-underline transition-colors text-sm" href="#" onclick="(function(){ const u = document.getElementById('crypto-address').innerText; window.open('https://polygonscan.com/address/'+u,'_blank'); return false; })()" data-i18n="donation.view_on_explorer">Ver</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Columna Derecha: Widget -->
        <div class="flex items-center justify-center">
          <div class="bg-white border border-gray-200 rounded-lg p-4 w-full h-full">
            <iframe src="https://nowpayments.io/embeds/donation-widget?api_key=fdda84fb-c7f9-409f-9f7d-bde15b5ab352" width="100%" height="100%" frameborder="0" class="border-none rounded">No se puede cargar el widget</iframe>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL de Confirmación -->
  <div id="confirm-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="text-lg font-semibold text-gray-800">Confirmar Acción</h3>
      </div>
      <div id="confirm-message" class="mb-4 text-sm leading-relaxed"></div>
      <div class="flex gap-3">
        <button class="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded" onclick="closeConfirmModal(false)">Cancelar</button>
        <button class="flex-1 bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded" onclick="closeConfirmModal(true)">Confirmar</button>
      </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== I18N Multilenguaje System ======
    let currentLanguage = localStorage.getItem('appLanguage') || 'es';
    let i18nData = {};

    async function loadI18nData() {
      try {
        const response = await fetch(`/i18n/${currentLanguage}.json`);
        if (!response.ok) throw new Error(`Failed to load ${currentLanguage}.json`);
        i18nData = await response.json();
      } catch (e) {
        console.error('Error loading i18n:', e);
        // Fallback: try English
        if (currentLanguage !== 'en') {
          currentLanguage = 'en';
          const fallback = await fetch('/i18n/en.json');
          i18nData = await fallback.json();
        }
      }
    }

    function t(key, defaultValue = key) {
      const keys = key.split('.');
      let value = i18nData;
      for (const k of keys) {
        value = value?.[k];
        if (!value) return defaultValue;
      }
      return value;
    }

    function updateI18n() {
      document.querySelectorAll('[data-i18n]').forEach((el) => {
        const key = el.getAttribute('data-i18n');
        const text = t(key);
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.placeholder = text;
        } else {
          el.textContent = text;
        }
      });
      // Preseleccionar el idioma actual en el selector
      const langSelect = document.getElementById('lang-select');
      if (langSelect) langSelect.value = currentLanguage;
      document.documentElement.lang = currentLanguage;
    }

    async function changeLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem('appLanguage', lang);
      await loadI18nData();
      updateI18n();
      closeLangBar();
    }

    function toggleLangBar() {
      const bar = document.getElementById('lang-bar');
      if (bar) {
        bar.classList.toggle('hidden');
      }
    }

    function closeLangBar() {
      const bar = document.getElementById('lang-bar');
      if (bar) {
        bar.classList.add('hidden');
      }
    }

    // ====== Lógica de Estado ======
    let ingredients = JSON.parse(localStorage.getItem('rpg_ing') || '[]');
    let activeRecipe = { items: [] };
    let recipeBook = JSON.parse(localStorage.getItem('rpg_book') || '[]');
    let configLoaded = false;
    let currentRecipeModal = null;

    // Constantes de color
    const RARITY_COLORS = {
      common: '#a9b0c2',
      rare: '#4fa3ff',
      epic: '#a335ee',
      legendary: '#ff8000'
    };

    // ====== Funciones de Tabs (SPA - Single Page Application) ======
    function switchTab(tabId) {
      // Esconder todos los tabs
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      // Remover clase active de botones
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      // Remover clases activas de sidebar
      document.querySelectorAll('[id^="sidebar-"]').forEach(btn => {
        btn.classList.remove('bg-yellow-300', 'text-gray-800');
        btn.classList.add('hover:bg-gray-200', 'text-gray-600');
      });
      // Remover clases activas de bottom nav
      document.querySelectorAll('[id^="bottom-"]').forEach(btn => {
        btn.classList.remove('text-yellow-600');
        btn.classList.add('text-gray-600');
      });
      // Mostrar tab seleccionado
      document.getElementById(tabId).classList.add('active');
      // Activar botón correspondiente en sidebar
      const sidebarId = 'sidebar-' + tabId.replace('tab-', '');
      const sidebarBtn = document.getElementById(sidebarId);
      if (sidebarBtn) {
        sidebarBtn.classList.remove('hover:bg-gray-200', 'text-gray-600');
        sidebarBtn.classList.add('bg-yellow-300', 'text-gray-800');
      }
      // Activar botón correspondiente en bottom nav
      const bottomId = 'bottom-' + tabId.replace('tab-', '');
      const bottomBtn = document.getElementById(bottomId);
      if (bottomBtn) {
        bottomBtn.classList.remove('text-gray-600');
        bottomBtn.classList.add('text-yellow-600');
      }
      // Activar botón en bottom nav si existe
      if (event && event.target) event.target.classList.add('active');
      // Actualizar URL para SPA
      const tabName = tabId.replace('tab-', '');
      history.pushState({ tab: tabName }, '', `#${tabName}`);
    }

    // Manejar navegación con el botón atrás/adelante
    window.addEventListener('popstate', function (event) {
      if (event.state && event.state.tab) {
        switchTabNoHistory('tab-' + event.state.tab);
      }
    });

    // Cambiar tab sin actualizar historial
    function switchTabNoHistory(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      // Remover clases activas de sidebar
      document.querySelectorAll('[id^="sidebar-"]').forEach(btn => {
        btn.classList.remove('bg-yellow-300', 'text-gray-800');
        btn.classList.add('hover:bg-gray-200', 'text-gray-600');
      });
      // Remover clases activas de bottom nav
      document.querySelectorAll('[id^="bottom-"]').forEach(btn => {
        btn.classList.remove('text-yellow-600');
        btn.classList.add('text-gray-600');
      });
      document.getElementById(tabId).classList.add('active');
      // Activar botón correspondiente en sidebar
      const sidebarId = 'sidebar-' + tabId.replace('tab-', '');
      const sidebarBtn = document.getElementById(sidebarId);
      if (sidebarBtn) {
        sidebarBtn.classList.remove('hover:bg-gray-200', 'text-gray-600');
        sidebarBtn.classList.add('bg-yellow-300', 'text-gray-800');
      }
      // Activar botón correspondiente en bottom nav
      const bottomId = 'bottom-' + tabId.replace('tab-', '');
      const bottomBtn = document.getElementById(bottomId);
      if (bottomBtn) {
        bottomBtn.classList.remove('text-gray-600');
        bottomBtn.classList.add('text-yellow-600');
      }
      // Buscar y activar botón correspondiente
      document.querySelectorAll('.tab-button').forEach(btn => {
        if (btn.onclick && btn.onclick.toString().includes(tabId)) {
          btn.classList.add('active');
        }
      });
    }

    // Inicializar SPA con URL
    function initSPA() {
      const hash = window.location.hash.slice(1);
      if (hash && document.getElementById('tab-' + hash)) {
        switchTabNoHistory('tab-' + hash);
        history.replaceState({ tab: hash }, '', `#${hash}`);
      }
    }

    // ====== Funciones de UI ======
    function showToast(msg) {
      const container = document.getElementById('toast-container');
      const t = document.createElement('div');
      t.className = 'toast';
      t.innerText = `> ${msg}`;
      container.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    // reloj eliminado - no se usa en header

    // ====== Funciones de Modal ======
    function openRecipeModal(id) {
      const recipe = recipeBook.find(r => r.id === id);
      if (!recipe) return;

      currentRecipeModal = recipe;
      const modal = document.getElementById('recipe-modal');
      const modalName = document.getElementById('modal-recipe-name');
      const modalDetails = document.getElementById('modal-recipe-details');

      modalName.textContent = recipe.name;

      const profit = recipe.price - recipe.cost;
      const margin = recipe.price > 0 ? (profit / recipe.price) * 100 : 0;
      const roi = recipe.cost > 0 ? recipe.price / recipe.cost : 0;
      const portions = recipe.portions || 1;
      const pricePerPortion = portions > 0 ? recipe.price / portions : 0;

      let detailsHTML = `
        <div style="margin-bottom: 15px;">
          <h4 style="color: var(--accent); font-size: 11px; margin: 0 0 10px 0; text-transform: uppercase;">Ingredientes</h4>
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
              <tr style="background-color: #f9f9f9;">
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Ingrediente</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Cantidad</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Costo</th>
              </tr>
            </thead>
            <tbody>
              ${recipe.items.map(i => `
                <tr>
                  <td style="border: 1px solid #ddd; padding: 8px;">${i.name}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${i.qty} ${getUnitLabel(i.rarity)}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${(getUnitCost(i) * i.qty).toFixed(2)}€</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        ${recipe.instructions ? `
        <div class="divider"></div>
        <div style="margin-bottom: 15px;">
          <h4 style="color: var(--accent); font-size: 11px; margin: 0 0 10px 0; text-transform: uppercase;">Método de Preparación</h4>
          <div style="font-size: 10px; line-height: 1.5; color: var(--text); white-space: pre-wrap;">${recipe.instructions}</div>
        </div>
        ` : ''}
        <div class="divider"></div>
        <div style="margin-bottom: 15px;">
          <h4 style="color: var(--accent); font-size: 11px; margin: 0 0 10px 0; text-transform: uppercase;">Análisis Financiero</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
            <div style="background: #f0f0f0; padding: 10px; border-radius: 5px;">
              <strong>Costo Total:</strong> <span style="color: var(--danger)">${recipe.cost.toFixed(2)}€</span>
            </div>
            <div style="background: #f0f0f0; padding: 10px; border-radius: 5px;">
              <strong>Precio Venta:</strong> <span style="color: var(--success)">${recipe.price.toFixed(2)}€</span>
            </div>
            <div style="background: #f0f0f0; padding: 10px; border-radius: 5px;">
              <strong>Precio por Porción:</strong> ${pricePerPortion.toFixed(2)}€ (${portions} porciones)
            </div>
            <div style="background: #f0f0f0; padding: 10px; border-radius: 5px;">
              <strong>Ganancia Neta:</strong> <span style="color: ${profit >= 0 ? 'var(--success)' : 'var(--danger)'}">${profit.toFixed(2)}€</span>
            </div>
            <div style="background: #f0f0f0; padding: 10px; border-radius: 5px;">
              <strong>Margen de Ganancia:</strong> ${margin.toFixed(1)}%
            </div>
            <div style="background: #f0f0f0; padding: 10px; border-radius: 5px;">
              <strong>Rentabilidad (ROI):</strong> ${roi.toFixed(2)}x
            </div>
          </div>
        </div>
      `;

      modalDetails.innerHTML = detailsHTML;
      modal.classList.add('active');
    }

    function closeRecipeModal() {
      document.getElementById('recipe-modal').classList.remove('active');
      currentRecipeModal = null;
    }

    function deleteFromModalRecipe() {
      if (!currentRecipeModal) return;
      showConfirmModal(`¿Eliminar la receta "${currentRecipeModal.name}"?`, (confirmed) => {
        if (confirmed) {
          recipeBook = recipeBook.filter(r => r.id !== currentRecipeModal.id);
          localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
          renderBook();
          closeRecipeModal();
          showToast(t('toasts.recipe_deleted', `Receta "${currentRecipeModal.name}" eliminada`));
        }
      });
    }

    function editRecipe() {
      if (!currentRecipeModal) return;

      // Cargar la receta en el formulario de creación
      activeRecipe = {
        items: [...currentRecipeModal.items],
        editingId: currentRecipeModal.id
      };

      // Llenar los campos del formulario
      document.getElementById('rec-name').value = currentRecipeModal.name;
      document.getElementById('rec-price').value = currentRecipeModal.price;
      document.getElementById('rec-portions').value = currentRecipeModal.portions || 1;
      document.getElementById('rec-instructions').value = currentRecipeModal.instructions || '';

      // Cambiar el botón de guardar a "Actualizar"
      const saveBtn = document.querySelector('#tab-receta .btn-primary');
      saveBtn.textContent = 'Actualizar Receta';
      saveBtn.onclick = updateRecipe;

      // Cambiar a la tab de crear receta
      switchTab('tab-receta');

      // Renderizar los ingredientes
      renderActiveRecipe();

      // Cerrar el modal
      closeRecipeModal();

      showToast(`Editando "${currentRecipeModal.name}"`);
    }

    function shareRecipe() {
      if (!currentRecipeModal) return;

      const recipe = currentRecipeModal;
      const portions = recipe.portions || 1;
      const pricePerPortion = portions > 0 ? recipe.price / portions : 0;
      const profit = recipe.price - recipe.cost;
      const margin = recipe.price > 0 ? (profit / recipe.price) * 100 : 0;

      let shareText = `🍽️ Receta: ${recipe.name}\n\n`;
      shareText += `Ingredientes:\n`;
      recipe.items.forEach(item => {
        shareText += `- ${item.name}: ${item.qty} ${getUnitLabel(item.rarity)}\n`;
      });
      shareText += `\n💰 Costo Total: ${recipe.cost.toFixed(2)}€\n`;
      shareText += `💰 Precio Venta: ${recipe.price.toFixed(2)}€\n`;
      shareText += `💰 Precio por Porción (${portions}): ${pricePerPortion.toFixed(2)}€\n`;
      shareText += `💰 Ganancia: ${profit.toFixed(2)}€ (${margin.toFixed(1)}% margen)\n\n`;
      shareText += `Compartido desde Recetario Épico`;

      if (navigator.share) {
        navigator.share({
          title: `Receta: ${recipe.name}`,
          text: shareText,
        }).catch(console.error);
      } else {
        // Fallback: copiar al portapapeles
        navigator.clipboard.writeText(shareText).then(() => {
          showToast(t('toasts.recipe_copied', 'Receta copiada al portapapeles'));
        }).catch(() => {
          showToast(t('toasts.share_error', 'Error al compartir'));
        });
      }
    }

    function exportRecipeJSON() {
      if (!currentRecipeModal) return;

      const recipe = currentRecipeModal;
      const data = {
        receta: recipe,
        exportDate: new Date().toISOString()
      };

      const jsonData = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `receta_${recipe.name.replace(/\s+/g, '_')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast(t('toasts.recipe_exported', 'Receta exportada como JSON'));
    }

    async function shareApp() {
      const shareText = `🍽️ Descubre Recetario Épico: Gestor de recetas con análisis de costos y rentabilidad. ¡Prueba esta app increíble para chefs y amantes de la cocina!\n\n${window.location.href}`;

      // Crear una imagen simple para compartir
      const imageBlob = await createShareImage();

      // Verificar si Web Share API está disponible y soporta archivos
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [imageBlob] })) {
        console.log('Web Share API con soporte de archivos disponible, intentando compartir con imagen...');
        const shareData = {
          title: 'Recetario Épico',
          text: shareText,
          url: window.location.href,
          files: [imageBlob]
        };

        try {
          await navigator.share(shareData);
          console.log('Contenido compartido exitosamente con imagen');
          showToast(t('toasts.shared_with_image', '¡Compartido con imagen!'));
        } catch (error) {
          console.error('Error al compartir con imagen:', error);
          // Si falla compartir con imagen, intentar sin imagen
          if (error.name !== 'AbortError') {
            shareWithoutImage(shareText);
          }
        }
      } else if (navigator.share) {
        console.log('Web Share API disponible pero sin soporte de archivos, compartiendo sin imagen...');
        shareWithoutImage(shareText);
      } else {
        console.log('Web Share API no disponible, usando fallback');
        showToast(t('toasts.web_share_unavailable', 'Web Share no disponible, copiando al portapapeles...'));
        fallbackCopyTextToClipboard(shareText);
      }
    }

    function shareWithoutImage(shareText) {
      navigator.share({
        title: 'Recetario Épico',
        text: shareText,
        url: window.location.href,
      }).then(() => {
        console.log('Contenido compartido exitosamente sin imagen');
        showToast(t('toasts.shared', '¡Compartido exitosamente!'));
      }).catch((error) => {
        console.error('Error al compartir sin imagen:', error);
        if (error.name !== 'AbortError') {
          fallbackCopyTextToClipboard(shareText);
        }
      });
    }

    async function createShareImage() {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        canvas.width = 400;
        canvas.height = 200;
        const ctx = canvas.getContext('2d');

        // Fondo con gradiente
        const gradient = ctx.createLinearGradient(0, 0, 400, 200);
        gradient.addColorStop(0, '#e0c36c');
        gradient.addColorStop(1, '#6cd0e0');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 400, 200);

        // Texto del título
        ctx.fillStyle = '#12141d';
        ctx.font = 'bold 24px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('RECETARIO ÉPICO', 200, 80);

        // Texto descriptivo
        ctx.font = '16px Arial';
        ctx.fillText('Gestor de Recetas', 200, 110);
        ctx.fillText('con Análisis de Costos', 200, 130);

        // Icono simple (gema)
        ctx.fillStyle = '#e0c36c';
        ctx.beginPath();
        ctx.moveTo(200, 150);
        ctx.lineTo(180, 170);
        ctx.lineTo(180, 190);
        ctx.lineTo(220, 190);
        ctx.lineTo(220, 170);
        ctx.closePath();
        ctx.fill();

        // Convertir a blob
        canvas.toBlob((blob) => {
          const file = new File([blob], 'recetario-epico.png', { type: 'image/png' });
          resolve(file);
        }, 'image/png');
      });
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showToast(t('toasts.link_copied', 'Enlace copiado al portapapeles'));
        } else {
          showToast(t('toasts.copy_failed', 'No se pudo copiar. Comparte manualmente: ') + text);
        }
      } catch (error) {
        console.error('Error en fallback copy:', error);
        showToast(t('toasts.copy_failed', 'No se pudo copiar. Comparte manualmente: ') + text);
      }

      document.body.removeChild(textArea);
    }

    // ====== Donaciones ======
    function openDonationModal() {
      document.getElementById('donation-modal').classList.add('active');
      const installPrompt = document.getElementById('install-prompt');
      if (deferredPrompt) {
        installPrompt.classList.remove('hidden');
      } else {
        installPrompt.classList.add('hidden');
      }
    }

    function closeDonationModal() {
      document.getElementById('donation-modal').classList.remove('active');
    }

    // ====== Modal de Confirmación ======
    let confirmCallback = null;

    function showConfirmModal(message, callback) {
      confirmCallback = callback;
      document.getElementById('confirm-message').textContent = message;
      document.getElementById('confirm-modal').classList.add('active');
    }

    function closeConfirmModal(confirmed) {
      document.getElementById('confirm-modal').classList.remove('active');
      if (confirmCallback) {
        confirmCallback(confirmed);
        confirmCallback = null;
      }
    }

    function copyToClipboard(text) {
      try {
        navigator.clipboard.writeText(text.toString());
        showToast(t('toasts.data_exported', 'Copiado al portapapeles'));
      } catch (err) {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        showToast(t('toasts.data_exported', 'Copiado al portapapeles'));
      }
    }

    // ====== Manejo de Ingredientes - MÓVIL ======
    function addIngredient() {
      const name = document.getElementById('ing-name').value.trim();
      const cost = parseFloat(document.getElementById('ing-cost').value);
      const rarity = document.getElementById('ing-rarity').value;

      const priceType = document.getElementById('ing-price-type') ? document.getElementById('ing-price-type').value : 'unit';
      const packSize = document.getElementById('ing-pack-size') ? parseInt(document.getElementById('ing-pack-size').value) || 1 : 1;

      if (!name || isNaN(cost)) return showToast(t('toasts.error', 'Faltan datos del ingrediente'));

      ingredients.push({ id: Date.now(), name, cost, rarity, priceType, packSize });
      saveState();
      renderIngredients();
      document.getElementById('ing-name').value = '';
      document.getElementById('ing-cost').value = '';
      if (document.getElementById('ing-price-type')) document.getElementById('ing-price-type').value = 'unit';
      if (document.getElementById('ing-pack-size')) document.getElementById('ing-pack-size').value = '1';
      showToast(t('toasts.ingredient_added', `${name} añadido a la despensa`));
    }

    function deleteIngredient(id) {
      const ing = ingredients.find(i => i.id === id);
      showConfirmModal(`¿Eliminar "${ing.name}" de la despensa?`, (confirmed) => {
        if (confirmed) {
          ingredients = ingredients.filter(i => i.id !== id);
          saveState();
          renderIngredients();
          showToast(`${ing.name} eliminado de la despensa`);
        }
      });
    }

    function editIngredient(id) {
      const ing = ingredients.find(i => i.id === id);
      if (!ing) return;

      // Llenar los campos del formulario con los datos del ingrediente
      document.getElementById('ing-name').value = ing.name;
      document.getElementById('ing-cost').value = ing.cost;
      document.getElementById('ing-rarity').value = ing.rarity;
      if (document.getElementById('ing-price-type')) {
        document.getElementById('ing-price-type').value = ing.priceType || 'unit';
        togglePackInput('ing-price-type', 'ing-pack-size');
      }
      if (document.getElementById('ing-pack-size')) {
        document.getElementById('ing-pack-size').value = ing.packSize || 1;
      }

      // Cambiar el botón Añadir a Actualizar
      const addBtn = document.querySelector('#tab-ingredientes .btn-primary');
      addBtn.textContent = 'Actualizar';
      addBtn.onclick = () => updateIngredient(id);

      // Cambiar a la pestaña de ingredientes
      switchTab('tab-ingredientes');
    }

    function updateIngredient(id) {
      const name = document.getElementById('ing-name').value.trim();
      const cost = parseFloat(document.getElementById('ing-cost').value);
      const rarity = document.getElementById('ing-rarity').value;
      const priceType = document.getElementById('ing-price-type') ? document.getElementById('ing-price-type').value : 'unit';
      const packSize = document.getElementById('ing-pack-size') ? parseInt(document.getElementById('ing-pack-size').value) || 1 : 1;

      if (!name || isNaN(cost)) return showToast(t('toasts.error', 'Faltan datos del ingrediente'));

      const index = ingredients.findIndex(i => i.id === id);
      if (index !== -1) {
        ingredients[index] = { ...ingredients[index], name, cost, rarity, priceType, packSize };
        saveState();
        renderIngredients();
        // Resetear formulario
        document.getElementById('ing-name').value = '';
        document.getElementById('ing-cost').value = '';
        if (document.getElementById('ing-price-type')) document.getElementById('ing-price-type').value = 'unit';
        if (document.getElementById('ing-pack-size')) document.getElementById('ing-pack-size').value = '1';
        const addBtn = document.querySelector('#tab-ingredientes .btn-primary');
        addBtn.textContent = 'Añadir';
        addBtn.onclick = addIngredient;
        showToast(`${name} actualizado`);
      }
    }

    function renderIngredients() {
      const list = document.getElementById('ing-list');
      const select = document.getElementById('rec-ing-select');

      list.innerHTML = '';
      select.innerHTML = '<option value="">' + t('recipe.select_ingredient') + '</option>';

      ingredients.forEach(ing => {
        // Listado lateral móvil
        const card = document.createElement('div');
        card.className = 'bg-white border border-gray-300 rounded p-3 mb-2 flex justify-between items-center';
        const unitPrice = getUnitCost(ing);
        const priceExtra = ing.priceType === 'pack' ? ` — Pack: ${ing.cost.toFixed(2)}€ / ${ing.packSize}` : '';
        card.innerHTML = `
          <div class="flex-1">
            <div class="flex items-center mb-1">
              <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color:${RARITY_COLORS[ing.rarity] || '#a9b0c2'}"></span>
              <b class="text-sm text-gray-800">${ing.name}</b>
            </div>
            <span class="text-xs text-gray-600">Precio: ${unitPrice.toFixed(2)}€ (${getUnitLabel(ing.rarity)})${priceExtra}</span>
          </div>
          <div class="flex gap-2 ml-2">
            <button class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs" onclick="editIngredient(${ing.id})">Editar</button>
            <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" onclick="deleteIngredient(${ing.id})">X</button>
          </div>
        `;
        list.appendChild(card);

        // Selector en receta - Mostrar UNIDAD DE MEDIDA
        const opt = document.createElement('option');
        opt.value = ing.id;
        opt.innerText = `${ing.name} (${getUnitLabel(ing.rarity)})`;
        select.appendChild(opt);
      });

      // Actualizar selectores de unidades
      renderUnitsSelector('ing-rarity');
      renderUnitsSelector('ing-rarity-desk');

      // Sincronizar con versión desktop
      renderIngredientsDesk();
    }

    // ====== Manejo de Ingredientes - ESCRITORIO ======
    function addIngredientDesk() {
      const name = document.getElementById('ing-name-desk').value.trim();
      const cost = parseFloat(document.getElementById('ing-cost-desk').value);
      const rarity = document.getElementById('ing-rarity-desk').value;

      if (!name || isNaN(cost)) return showToast(t('toasts.error', 'Faltan datos del ingrediente'));

      ingredients.push({ id: Date.now(), name, cost, rarity });
      saveState();
      renderIngredients();
      document.getElementById('ing-name-desk').value = '';
      document.getElementById('ing-cost-desk').value = '';
      showToast(`${name} añadido a la despensa`);
    }

    function renderIngredientsDesk() {
      const list = document.getElementById('ing-list-desk');
      const select = document.getElementById('rec-ing-select-desk');

      list.innerHTML = '';
      select.innerHTML = '<option value="">' + t('recipe.select_ingredient') + '</option>';

      ingredients.forEach(ing => {
        // Listado lateral escritorio
        const card = document.createElement('div');
        card.className = 'card';
        const unitPrice = getUnitCost(ing);
        const priceExtra = ing.priceType === 'pack' ? ` — Pack: ${ing.cost.toFixed(2)}€ / ${ing.packSize}` : '';
        card.innerHTML = `
          <div class="card-info">
            <b><span class="rarity-dot" style="background:${RARITY_COLORS[ing.rarity]}"></span>${ing.name}</b>
            <span>Precio: ${unitPrice.toFixed(2)}€ (${getUnitLabel(ing.rarity)})${priceExtra}</span>
          </div>
          <div style="display: flex; gap: 4px;">
            <button class="btn btn-primary" style="padding:4px 6px; font-size:8px" onclick="editIngredientDesk(${ing.id})">E</button>
            <button class="btn btn-danger" style="padding:4px 6px; font-size:8px" onclick="deleteIngredientDesk(${ing.id})">X</button>
          </div>
        `;
        list.appendChild(card);

        // Selector en receta - Mostrar UNIDAD DE MEDIDA
        const opt = document.createElement('option');
        opt.value = ing.id;
        opt.innerText = `${ing.name} (${getUnitLabel(ing.rarity)})`;
        select.appendChild(opt);
      });
    }

    function deleteIngredientDesk(id) {
      const ing = ingredients.find(i => i.id === id);
      showConfirmModal(`¿Eliminar "${ing.name}" de la despensa?`, (confirmed) => {
        if (confirmed) {
          ingredients = ingredients.filter(i => i.id !== id);
          saveState();
          renderIngredients();
          showToast(`${ing.name} eliminado de la despensa`);
        }
      });
    }

    function editIngredientDesk(id) {
      const ing = ingredients.find(i => i.id === id);
      if (!ing) return;

      // Llenar los campos del formulario con los datos del ingrediente
      document.getElementById('ing-name-desk').value = ing.name;
      document.getElementById('ing-cost-desk').value = ing.cost;
      document.getElementById('ing-rarity-desk').value = ing.rarity;

      // Cambiar el botón Añadir a Actualizar
      const addBtn = document.querySelector('#tab-ingredientes-desk .btn-primary');
      addBtn.textContent = 'Actualizar';
      addBtn.onclick = () => updateIngredientDesk(id);

      // Cambiar a la pestaña de ingredientes
      switchTab('tab-ingredientes');
    }

    function updateIngredientDesk(id) {
      const name = document.getElementById('ing-name-desk').value.trim();
      const cost = parseFloat(document.getElementById('ing-cost-desk').value);
      const rarity = document.getElementById('ing-rarity-desk').value;

      if (!name || isNaN(cost)) return showToast(t('toasts.error', 'Faltan datos del ingrediente'));

      const index = ingredients.findIndex(i => i.id === id);
      if (index !== -1) {
        ingredients[index] = { ...ingredients[index], name, cost, rarity };
        saveState();
        renderIngredients();
        // Resetear formulario
        document.getElementById('ing-name-desk').value = '';
        document.getElementById('ing-cost-desk').value = '';
        const addBtn = document.querySelector('#tab-ingredientes-desk .btn-primary');
        addBtn.textContent = 'Añadir';
        addBtn.onclick = addIngredientDesk;
        showToast(`${name} actualizado`);
      }
    }

    function clearIngredientsDesk() {
      showConfirmModal("¿Seguro que quieres vaciar la despensa? Esta acción no se puede deshacer.", (confirmed) => {
        if (confirmed) {
          ingredients = [];
          if (!configLoaded) {
            localStorage.setItem('rpg_ing', JSON.stringify(ingredients));
          }
          renderIngredients();
          showToast(t('toasts.ingredient_deleted', 'Despensa vaciada'));
        }
      });
    }

    // ====== Manejo de Recetas - MÓVIL ======
    function updateUnitSelector() {
      const ingId = parseInt(document.getElementById('rec-ing-select').value);
      const unitSelect = document.getElementById('rec-unit-select');
      unitSelect.innerHTML = '';

      if (!ingId) return;

      const ing = ingredients.find(i => i.id === ingId);
      if (!ing) return;

      const units = getCustomUnits();
      const availableUnits = [ing.rarity]; // Siempre incluir la unidad original

      // Agregar unidades que se puedan convertir a la unidad del ingrediente
      Object.keys(customConversions).forEach(key => {
        const [from, to] = key.split('-');
        if (to === ing.rarity) {
          if (!availableUnits.includes(from)) availableUnits.push(from);
        }
      });

      // Agregar placeholder
      const placeholderOpt = document.createElement('option');
      placeholderOpt.value = '';
      placeholderOpt.textContent = t('recipe.select_unit');
      unitSelect.appendChild(placeholderOpt);

      availableUnits.forEach(unit => {
        const opt = document.createElement('option');
        opt.value = unit;
        opt.textContent = units[unit] || unit;
        unitSelect.appendChild(opt);
      });

      // Seleccionar la unidad original por defecto
      unitSelect.value = ing.rarity;
    }

    function addToRecipe() {
      const ingId = parseInt(document.getElementById('rec-ing-select').value);
      const qty = parseFloat(document.getElementById('rec-qty').value);
      const selectedUnit = document.getElementById('rec-unit-select').value;

      if (!ingId || isNaN(qty) || qty < 1) return showToast(t('toasts.error', 'Selección inválida'));

      const ing = ingredients.find(i => i.id === ingId);
      let convertedQty = qty;

      if (selectedUnit !== ing.rarity) {
        // Convertir la cantidad a la unidad del ingrediente
        convertedQty = convertUnit(qty, selectedUnit, ing.rarity);
        if (convertedQty === qty) {
          // No se pudo convertir, usar original
          showToast(`No hay equivalencia para convertir ${selectedUnit} a ${ing.rarity}, usando unidad original`);
        }
      }

      const existing = activeRecipe.items.find(i => i.id === ingId);

      if (existing) {
        existing.qty += convertedQty;
      } else {
        activeRecipe.items.push({ ...ing, qty: convertedQty });
      }

      renderActiveRecipe();
      updateStats();
      showToast(`${ing.name} x${convertedQty.toFixed(2)} ${getUnitLabel(ing.rarity)} en la mesa`);
    }

    function renderActiveRecipe() {
      const list = document.getElementById('rec-items-list');
      list.innerHTML = '';

      activeRecipe.items.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'card';
        const unitPrice = getUnitCost(item);
        card.innerHTML = `
          <div class="card-info">
            <b>${item.name}</b>
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
              <input type="number" value="${item.qty}" min="0.01" step="0.1" style="width: 80px; font-size: 10px; padding: 4px;" onchange="updateRecipeItemQty(${index}, this.value)">
              <span>${getUnitLabel(item.rarity)}</span>
            </div>
            <span>Costo: ${(unitPrice * item.qty).toFixed(2)}€ (${unitPrice.toFixed(2)}€/u)</span>
          </div>
          <button class="btn btn-danger" style="padding:4px 8px; font-size:8px" onclick="removeFromRecipe(${index})">-</button>
        `;
        list.appendChild(card);
      });
      updateStats();

      // Sincronizar con escritorio
      renderActiveRecipeDesk();
    }

    function removeFromRecipe(index) {
      activeRecipe.items.splice(index, 1);
      renderActiveRecipe();
    }

    function updateRecipeItemQty(index, newQty) {
      const qty = parseFloat(newQty);
      if (isNaN(qty) || qty <= 0) return;
      activeRecipe.items[index].qty = qty;
      renderActiveRecipe();
    }

    function updateStats() {
      const price = parseFloat(document.getElementById('rec-price').value) || 0;
      const portions = parseInt(document.getElementById('rec-portions').value) || 1;
      const cost = activeRecipe.items.reduce((acc, curr) => acc + (getUnitCost(curr) * curr.qty), 0);

      const profit = price - cost;
      const margin = price > 0 ? (profit / price) * 100 : 0;
      const roi = cost > 0 ? price / cost : 0;
      const pricePerPortion = portions > 0 ? price / portions : 0;

      document.getElementById('stat-cost').innerText = cost.toFixed(2) + '€';
      document.getElementById('stat-profit').innerText = profit.toFixed(2) + '€';
      document.getElementById('stat-profit').style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
      document.getElementById('stat-price-per-portion').innerText = pricePerPortion.toFixed(2) + '€';
      document.getElementById('stat-margin').innerText = margin.toFixed(1) + '%';
      document.getElementById('stat-roi').innerText = roi.toFixed(2) + 'x';
    }

    function clearActiveRecipe() {
      activeRecipe = { items: [] };
      document.getElementById('rec-name').value = '';
      document.getElementById('rec-price').value = '';
      document.getElementById('rec-portions').value = '1';
      document.getElementById('rec-instructions').value = '';

      // Resetear el botón a guardar
      const saveBtn = document.querySelector('#tab-receta .btn-primary');
      saveBtn.textContent = 'Guardar Receta';
      saveBtn.onclick = saveRecipe;

      renderActiveRecipe();
    }

    function saveRecipe() {
      const name = document.getElementById('rec-name').value.trim();
      const price = parseFloat(document.getElementById('rec-price').value) || 0;
      const portions = parseInt(document.getElementById('rec-portions').value) || 1;
      const instructions = document.getElementById('rec-instructions').value.trim();

      if (!name || activeRecipe.items.length === 0) return showToast("Escribe un nombre y añade ingredientes");

      const cost = activeRecipe.items.reduce((acc, curr) => acc + (getUnitCost(curr) * curr.qty), 0);

      recipeBook.unshift({
        id: Date.now(),
        name,
        items: [...activeRecipe.items],
        price,
        portions,
        instructions,
        cost
      });

      localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
      renderBook();
      clearActiveRecipe();
      showToast(t('toasts.recipe_added', 'Receta guardada'));
    }

    function updateRecipe() {
      const name = document.getElementById('rec-name').value.trim();
      const price = parseFloat(document.getElementById('rec-price').value) || 0;
      const portions = parseInt(document.getElementById('rec-portions').value) || 1;
      const instructions = document.getElementById('rec-instructions').value.trim();

      if (!name || activeRecipe.items.length === 0) return showToast("Escribe un nombre y añade ingredientes");

      const cost = activeRecipe.items.reduce((acc, curr) => acc + (getUnitCost(curr) * curr.qty), 0);

      // Encontrar la receta existente y actualizarla
      const index = recipeBook.findIndex(r => r.id === activeRecipe.editingId);
      if (index !== -1) {
        recipeBook[index] = {
          ...recipeBook[index],
          name,
          items: [...activeRecipe.items],
          price,
          portions,
          instructions,
          cost
        };
      }

      localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
      renderBook();
      clearActiveRecipe();
      showToast(t('toasts.recipe_updated', 'Receta actualizada'));
    }

    // ====== Manejo de Recetas - ESCRITORIO ======
    function updateUnitSelectorDesk() {
      const ingId = parseInt(document.getElementById('rec-ing-select-desk').value);
      const unitSelect = document.getElementById('rec-unit-select-desk');
      unitSelect.innerHTML = '';

      if (!ingId) return;

      const ing = ingredients.find(i => i.id === ingId);
      if (!ing) return;

      const units = getCustomUnits();
      const availableUnits = [ing.rarity]; // Siempre incluir la unidad original

      // Agregar unidades que se puedan convertir a la unidad del ingrediente
      Object.keys(customConversions).forEach(key => {
        const [from, to] = key.split('-');
        if (to === ing.rarity) {
          if (!availableUnits.includes(from)) availableUnits.push(from);
        }
      });

      // Agregar placeholder
      const placeholderOpt = document.createElement('option');
      placeholderOpt.value = '';
      placeholderOpt.textContent = t('recipe.select_unit');
      unitSelect.appendChild(placeholderOpt);

      availableUnits.forEach(unit => {
        const opt = document.createElement('option');
        opt.value = unit;
        opt.textContent = units[unit] || unit;
        unitSelect.appendChild(opt);
      });

      // Seleccionar la unidad original por defecto
      unitSelect.value = ing.rarity;
    }

    function addToRecipeDesk() {
      const ingId = parseInt(document.getElementById('rec-ing-select-desk').value);
      const qty = parseFloat(document.getElementById('rec-qty-desk').value);
      const selectedUnit = document.getElementById('rec-unit-select-desk').value;

      if (!ingId || isNaN(qty) || qty < 1) return showToast(t('toasts.error', 'Selección inválida'));

      const ing = ingredients.find(i => i.id === ingId);
      let convertedQty = qty;

      if (selectedUnit !== ing.rarity) {
        // Convertir la cantidad a la unidad del ingrediente
        convertedQty = convertUnit(qty, selectedUnit, ing.rarity);
        if (convertedQty === qty) {
          // No se pudo convertir, usar original
          showToast(`No hay equivalencia para convertir ${selectedUnit} a ${ing.rarity}, usando unidad original`);
        }
      }

      const existing = activeRecipe.items.find(i => i.id === ingId);

      if (existing) {
        existing.qty += convertedQty;
      } else {
        activeRecipe.items.push({ ...ing, qty: convertedQty });
      }

      renderActiveRecipe();
      updateStats();
      showToast(`${ing.name} x${convertedQty.toFixed(2)} ${getUnitLabel(ing.rarity)} en la mesa`);
    }

    function renderActiveRecipeDesk() {
      const list = document.getElementById('rec-items-list-desk');
      list.innerHTML = '';

      activeRecipe.items.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'card';
        const unitPrice = getUnitCost(item);
        card.innerHTML = `
          <div class="card-info">
            <b>${item.name}</b>
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
              <input type="number" value="${item.qty}" min="0.01" step="0.1" style="width: 80px; font-size: 10px; padding: 4px;" onchange="updateRecipeItemQty(${index}, this.value)">
              <span>${getUnitLabel(item.rarity)}</span>
            </div>
            <span>Costo: ${(unitPrice * item.qty).toFixed(2)}€ (${unitPrice.toFixed(2)}€/u)</span>
          </div>
          <button class="btn btn-danger" style="padding:4px 8px; font-size:8px" onclick="removeFromRecipeDesk(${index})">-</button>
        `;
        list.appendChild(card);
      });
      updateStatsDesk();
    }

    function removeFromRecipeDesk(index) {
      activeRecipe.items.splice(index, 1);
      renderActiveRecipe();
    }

    function updateStatsDesk() {
      const price = parseFloat(document.getElementById('rec-price-desk').value) || 0;
      const portions = parseInt(document.getElementById('rec-portions-desk').value) || 1;
      const cost = activeRecipe.items.reduce((acc, curr) => acc + (getUnitCost(curr) * curr.qty), 0);

      const profit = price - cost;
      const margin = price > 0 ? (profit / price) * 100 : 0;
      const roi = cost > 0 ? price / cost : 0;
      const pricePerPortion = portions > 0 ? price / portions : 0;

      document.getElementById('stat-cost-desk').innerText = cost.toFixed(2) + '€';
      document.getElementById('stat-profit-desk').innerText = profit.toFixed(2) + '€';
      document.getElementById('stat-profit-desk').style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
      document.getElementById('stat-price-per-portion-desk').innerText = pricePerPortion.toFixed(2) + '€';
      document.getElementById('stat-margin-desk').innerText = margin.toFixed(1) + '%';
      document.getElementById('stat-roi-desk').innerText = roi.toFixed(2) + 'x';
    }

    function clearActiveRecipeDesk() {
      activeRecipe = { items: [] };
      document.getElementById('rec-name-desk').value = '';
      document.getElementById('rec-price-desk').value = '';
      document.getElementById('rec-portions-desk').value = '1';
      document.getElementById('rec-instructions-desk').value = '';

      // Resetear el botón a guardar
      const saveBtn = document.querySelector('#desktop-view .btn-primary');
      saveBtn.textContent = 'Guardar Receta';
      saveBtn.onclick = saveRecipeDesk;

      renderActiveRecipe();
    }

    function saveRecipeDesk() {
      const name = document.getElementById('rec-name-desk').value.trim();
      const price = parseFloat(document.getElementById('rec-price-desk').value) || 0;
      const portions = parseInt(document.getElementById('rec-portions-desk').value) || 1;
      const instructions = document.getElementById('rec-instructions-desk').value.trim();

      if (!name || activeRecipe.items.length === 0) return showToast("Escribe un nombre y añade ingredientes");

      const cost = activeRecipe.items.reduce((acc, curr) => acc + (getUnitCost(curr) * curr.qty), 0);

      recipeBook.unshift({
        id: Date.now(),
        name,
        items: [...activeRecipe.items],
        price,
        portions,
        instructions,
        cost
      });

      localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
      renderBook();
      clearActiveRecipeDesk();
      showToast(t('toasts.recipe_added', 'Receta guardada'));
    }

    // ====== Libro de Recetas ======
    function renderBook() {
      const container = document.getElementById('recipe-book');
      container.innerHTML = '';

      recipeBook.forEach(rec => {
        const div = document.createElement('div');
        div.className = 'bg-white border border-gray-300 rounded p-4 cursor-pointer hover:shadow-md transition-shadow';
        div.innerHTML = `
          <div class="text-yellow-600 font-semibold mb-2 text-sm">${rec.name}</div>
          <div class="text-gray-500 text-xs leading-relaxed mb-2">
            ${rec.items.map(i => `${i.name} ${i.qty} ${getUnitLabel(i.rarity)}`).join('<br>')}
          </div>
          <div class="border-t pt-2 mb-2"></div>
          <div class="flex justify-between text-xs">
            <span class="text-green-600">Venta: ${rec.price.toFixed(2)}€</span>
            <span class="text-red-600">Costo: ${rec.cost.toFixed(2)}€</span>
          </div>
          <div class="text-xs text-gray-400 mt-1">Pulsa para ver detalles</div>
        `;
        div.onclick = () => openRecipeModal(rec.id);
        container.appendChild(div);
      });

      // Sincronizar con escritorio
      renderBookDesk();
    }

    function renderBookDesk() {
      const container = document.getElementById('recipe-book-desk');
      if (!container) return;

      container.innerHTML = '';

      recipeBook.forEach(rec => {
        const div = document.createElement('div');
        div.className = 'bg-white border border-gray-300 rounded p-4 cursor-pointer hover:shadow-md transition-shadow';
        div.innerHTML = `
          <div class="text-yellow-600 font-semibold mb-2 text-sm">${rec.name}</div>
          <div class="text-gray-500 text-xs leading-relaxed mb-2">
            ${rec.items.map(i => `${i.name} ${i.qty} ${getUnitLabel(i.rarity)}`).join('<br>')}
          </div>
          <div class="border-t pt-2"></div>
          <div class="flex justify-between text-xs">
            <span class="text-green-600">Venta: ${rec.price.toFixed(2)}€</span>
            <span class="text-red-600">Costo: ${rec.cost.toFixed(2)}€</span>
          </div>
        `;
        div.onclick = () => openRecipeModal(rec.id);
        container.appendChild(div);
      });
    }

    function deleteFromBook(id) {
      const rec = recipeBook.find(r => r.id === id);
      showConfirmModal(`¿Eliminar la receta "${rec.name}"?`, (confirmed) => {
        if (confirmed) {
          recipeBook = recipeBook.filter(r => r.id !== id);
          localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
          renderBook();
          showToast(`Receta "${rec.name}" eliminada`);
        }
      });
    }

    // ====== Exportar/Importar ======
    function exportRecipeBook() {
      // Exportar TODA la configuración: recetas, ingredientes, unidades y equivalencias
      if (recipeBook.length === 0 && Object.keys(ingredients).length === 0 && Object.keys(customUnits).length === 0 && Object.keys(customConversions).length === 0) {
        return showToast(t('toasts.no_data_export', 'No hay datos para exportar'));
      }

      const data = {
        recetas: recipeBook,
        ingredientes: ingredients,
        unidades: customUnits,
        equivalencias: customConversions,
        exportDate: new Date().toISOString(),
        version: '1.0'
      };

      const jsonData = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `recetario-completo_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast(t('toasts.full_config_exported', 'Configuración completa exportada (recetas, ingredientes, unidades y equivalencias)'));
    }

    function exportUnitsAndConversions() {
      // Exportar solo unidades y equivalencias
      if (Object.keys(customUnits).length === 0 && Object.keys(customConversions).length === 0) {
        return showToast(t('toasts.no_data_export', 'No hay unidades o equivalencias personalizadas para exportar'));
      }

      const data = {
        unidades: customUnits,
        equivalencias: customConversions,
        exportDate: new Date().toISOString(),
        version: '1.0'
      };

      const jsonData = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `unidades-equivalencias_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast(t('toasts.units_conversions_exported', 'Unidades y equivalencias exportadas'));
    }

    function importRecipeBook() {
      document.getElementById('file-input').click();
    }

    function importUnitsAndConversions() {
      document.getElementById('units-file-input').click();
    }

    function importSingleRecipe() {
      document.getElementById('recipe-file-input').click();
    }

    function handleFileImport() {
      const file = document.getElementById('file-input').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);

          // Soporte para formato antiguo (solo array) y nuevo (objeto con recetas e ingredientes)
          let importedRecipes = Array.isArray(imported) ? imported : (imported.recetas || []);
          let importedIngredients = imported.ingredientes || [];
          let importedUnits = imported.unidades || {};
          let importedConversions = imported.conversiones || imported.equivalencias || {};

          if (!Array.isArray(importedRecipes)) return showToast("Formato JSON inválido");

          // Importar ingredientes
          if (importedIngredients.length > 0) {
            showConfirmModal(
              `Se encontraron ${importedIngredients.length} ingredientes.\n\n¿Unificar (OK) o reemplazar (Cancelar)?`,
              (mergeIngs) => {
                if (mergeIngs) {
                  // Unificar ingredientes (evitar duplicados por nombre)
                  const existingNames = new Set(ingredients.map(i => i.name.toLowerCase()));
                  importedIngredients.forEach(newIng => {
                    if (!existingNames.has(newIng.name.toLowerCase())) {
                      ingredients.push(newIng);
                      existingNames.add(newIng.name.toLowerCase());
                    }
                  });
                  showToast(`${importedIngredients.length} ingrediente(s) importado(s)`);
                } else {
                  ingredients = importedIngredients;
                  showToast("Ingredientes reemplazados");
                }
                saveState();
                renderIngredients();
              }
            );
          }

          // Importar unidades personalizadas
          if (Object.keys(importedUnits).length > 0) {
            showConfirmModal(
              `Se encontraron ${Object.keys(importedUnits).length} unidades personalizadas.\n\n¿Unificar (OK) o reemplazar (Cancelar)?`,
              (mergeUnitsChoice) => {
                if (mergeUnitsChoice) {
                  // Unificar unidades
                  customUnits = Object.assign({}, customUnits, importedUnits);
                  showToast("Unidades unificadas");
                } else {
                  customUnits = importedUnits;
                  showToast("Unidades reemplazadas");
                }
                localStorage.setItem('rpg_units', JSON.stringify(customUnits));
                renderUnitsList();
                renderIngredients();
              }
            );
          }

          // Importar conversiones personalizadas
          if (Object.keys(importedConversions).length > 0) {
            showConfirmModal(
              `Se encontraron ${Object.keys(importedConversions).length} conversiones personalizadas.\n\n¿Unificar (OK) o reemplazar (Cancelar)?`,
              (mergeConvs) => {
                if (mergeConvs) {
                  // Unificar conversiones
                  customConversions = Object.assign({}, customConversions, importedConversions);
                  showToast("Conversiones unificadas");
                } else {
                  customConversions = importedConversions;
                  showToast("Conversiones reemplazadas");
                }
                localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));
                renderConversionsList();
              }
            );
          }

          // Importar recetas
          if (recipeBook.length > 0 && importedRecipes.length > 0) {
            showConfirmModal(
              "Ya tienes recetas guardadas.\n\n¿Reemplazar (OK) o unificar (Cancelar)?",
              (mergeChoice) => {
                if (mergeChoice) {
                  recipeBook = importedRecipes;
                } else {
                  const mergedNames = new Set(recipeBook.map(r => r.name.toLowerCase()));
                  importedRecipes.forEach(newRec => {
                    if (!mergedNames.has(newRec.name.toLowerCase())) {
                      recipeBook.push(newRec);
                      mergedNames.add(newRec.name.toLowerCase());
                    }
                  });
                  showToast("Recetas unificadas (duplicados eliminados)");
                }
                localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
                renderBook();
              }
            );
          } else if (importedRecipes.length > 0) {
            recipeBook = importedRecipes;
            localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
            renderBook();
          }

          configLoaded = true;
          localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
          renderBook();
          showToast(`${importedRecipes.length} receta(s) importada(s)`);
        } catch (err) {
          showToast("Error al leer el archivo JSON");
        }
      };
      reader.readAsText(file);
      document.getElementById('file-input').value = '';
    }

    function importSingleRecipe() {
      document.getElementById('recipe-file-input').click();
    }

    function handleRecipeImport() {
      const file = document.getElementById('recipe-file-input').files[0] || document.getElementById('recipe-file-input-desk').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          const importedRecipe = imported.receta;

          if (!importedRecipe || !importedRecipe.name) return showToast("Formato JSON de receta inválido");

          // Verificar si ya existe
          const existing = recipeBook.find(r => r.name.toLowerCase() === importedRecipe.name.toLowerCase());
          if (existing) {
            showConfirmModal(`Ya existe una receta con el nombre "${importedRecipe.name}". ¿Reemplazar?`, (replace) => {
              if (replace) {
                const index = recipeBook.findIndex(r => r.id === existing.id);
                recipeBook[index] = importedRecipe;
                localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
                renderBook();
                showToast(`Receta "${importedRecipe.name}" reemplazada`);
              }
            });
          } else {
            recipeBook.unshift(importedRecipe);
            localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
            renderBook();
            showToast(`Receta "${importedRecipe.name}" importada`);
          }
        } catch (err) {
          showToast("Error al leer el archivo JSON de receta");
        }
      };
      reader.readAsText(file);
      document.getElementById('recipe-file-input').value = '';
      if (document.getElementById('recipe-file-input-desk')) document.getElementById('recipe-file-input-desk').value = '';
    }

    function handleUnitsImport() {
      const file = document.getElementById('units-file-input').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);

          // Verificar formato
          if (!imported.unidades && !imported.conversiones) {
            return showToast("El archivo no contiene unidades o equivalencias válidas");
          }

          let importedUnits = imported.unidades || {};
          let importedConversions = imported.conversiones || {};

          let hasUnits = Object.keys(importedUnits).length > 0;
          let hasConversions = Object.keys(importedConversions).length > 0;

          if (hasUnits && hasConversions) {
            showConfirmModal(
              `Se encontraron ${Object.keys(importedUnits).length} unidades y ${Object.keys(importedConversions).length} equivalencias.\n\n¿Unificar (OK) o reemplazar (Cancelar)?`,
              (mergeChoice) => {
                if (mergeChoice) {
                  // Unificar unidades
                  Object.keys(importedUnits).forEach(key => {
                    if (!customUnits[key]) {
                      customUnits[key] = importedUnits[key];
                    }
                  });
                  // Unificar conversiones
                  Object.keys(importedConversions).forEach(key => {
                    if (!customConversions[key]) {
                      customConversions[key] = importedConversions[key];
                    }
                  });
                  showToast(t('toasts.units_merged', 'Unidades y equivalencias unificadas'));
                } else {
                  customUnits = importedUnits;
                  customConversions = importedConversions;
                  showToast(t('toasts.units_replaced', 'Unidades y equivalencias reemplazadas'));
                }
                localStorage.setItem('rpg_units', JSON.stringify(customUnits));
                localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));
                renderUnitsList();
                renderConversionsList();
                renderIngredients();
              }
            );
          } else if (hasUnits) {
            showConfirmModal(
              `Se encontraron ${Object.keys(importedUnits).length} unidades.\n\n¿Unificar (OK) o reemplazar (Cancelar)?`,
              (mergeChoice) => {
                if (mergeChoice) {
                  Object.keys(importedUnits).forEach(key => {
                    if (!customUnits[key]) {
                      customUnits[key] = importedUnits[key];
                    }
                  });
                  showToast(t('toasts.units_merged', 'Unidades unificadas'));
                } else {
                  customUnits = importedUnits;
                  showToast(t('toasts.units_replaced', 'Unidades reemplazadas'));
                }
                localStorage.setItem('rpg_units', JSON.stringify(customUnits));
                renderUnitsList();
                renderIngredients();
              }
            );
          } else if (hasConversions) {
            showConfirmModal(
              `Se encontraron ${Object.keys(importedConversions).length} equivalencias.\n\n¿Unificar (OK) o reemplazar (Cancelar)?`,
              (mergeChoice) => {
                if (mergeChoice) {
                  Object.keys(importedConversions).forEach(key => {
                    if (!customConversions[key]) {
                      customConversions[key] = importedConversions[key];
                    }
                  });
                  showToast(t('toasts.conversions_merged', 'Equivalencias unificadas'));
                } else {
                  customConversions = importedConversions;
                  showToast(t('toasts.conversions_replaced', 'Equivalencias reemplazadas'));
                }
                localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));
                renderConversionsList();
              }
            );
          }

          showToast(t('toasts.import_completed', 'Importación completada'));
        } catch (err) {
          showToast(t('toasts.error', 'Error al leer el archivo JSON de unidades'));
        }
      };
      reader.readAsText(file);
      document.getElementById('units-file-input').value = '';
    }

    // ====== Utilidades ======
    function getUnitLabel(rarity) {
      const units = getCustomUnits();
      return units[rarity] || 'kg';
    }

    // Devuelve el coste por 1 unidad del ingrediente (tiene en cuenta packs)
    function getUnitCost(item) {
      if (!item) return 0;
      const priceType = item.priceType || 'unit';
      const packSize = parseFloat(item.packSize) || 1;
      const cost = parseFloat(item.cost) || 0;
      if (priceType === 'pack' && packSize > 0) return cost / packSize;
      return cost;
    }

    // Muestra u oculta el input de tamaño de pack según tipo de precio
    function togglePackInput(selectId, packInputId) {
      const sel = document.getElementById(selectId);
      const pack = document.getElementById(packInputId);
      if (!sel || !pack) return;
      if (sel.value === 'pack') {
        pack.parentElement.style.display = 'block';
      } else {
        pack.parentElement.style.display = 'block'; // lo mantenemos visible por simplicidad
      }
    }

    function saveState() {
      if (!configLoaded) {
        localStorage.setItem('rpg_ing', JSON.stringify(ingredients));
      }
    }

    function seedData() {
      if (ingredients.length > 0) {
        showConfirmModal("¿Reemplazar ingredientes actuales con datos de demo?", (confirmed) => {
          if (!confirmed) return;
          loadDemoData();
        });
      } else {
        loadDemoData();
      }

      function loadDemoData() {
        ingredients = [
          { id: 1, name: "Pechuga de Pollo", cost: 8.5, rarity: "common" },
          { id: 2, name: "Filete de Res Premium", cost: 16.0, rarity: "rare" },
          { id: 3, name: "Salmón Noruego", cost: 24.0, rarity: "epic" },
          { id: 4, name: "Jamón Ibérico", cost: 42.0, rarity: "legendary" },
          { id: 5, name: "Tomates", cost: 2.0, rarity: "common" },
          { id: 6, name: "Queso Parmesano", cost: 18.0, rarity: "rare" },
          { id: 7, name: "Champiñones Silvestres", cost: 12.0, rarity: "epic" },
          { id: 8, name: "Trufa Negra", cost: 85.0, rarity: "legendary" }
        ];
        if (!configLoaded) {
          localStorage.setItem('rpg_ing', JSON.stringify(ingredients));
        }
        renderIngredients();
        showToast("Ingredientes de demo cargados");
      }
    }

    function clearIngredients() {
      showConfirmModal("¿Seguro que quieres vaciar la despensa? Esta acción no se puede deshacer.", (confirmed) => {
        if (confirmed) {
          ingredients = [];
          if (!configLoaded) {
            localStorage.setItem('rpg_ing', JSON.stringify(ingredients));
          }
          renderIngredients();
          showToast("Despensa vaciada");
        }
      });
    }

    // ====== Gestión de Unidades de Medida ======
    let customUnits = JSON.parse(localStorage.getItem('rpg_units') || '{}');
    let customConversions = JSON.parse(localStorage.getItem('rpg_conversions') || '{}');

    const DEFAULT_UNITS = {
      'kilogramo': 'kg',
      'gramo': 'g',
      'litro': 'L',
      'mililitro': 'ml',
      'unidad': 'Unidad'
    };

    // Helper para obtener el nombre traducido de una unidad
    function getUnitName(key) {
      return t(`settings.units.${key}`, key);
    }

    function getCustomUnits() {
      return Object.assign({}, DEFAULT_UNITS, customUnits);
    }

    function renderUnitsSelector(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;

      const units = getCustomUnits();
      select.innerHTML = '<option value="">' + t('ingredients.select_unit') + '</option>';

      Object.entries(units).forEach(([key, value]) => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.innerText = `${getUnitName(key)} (${value})`;
        select.appendChild(opt);
      });
    }

    function renderUnitsList() {
      const list = document.getElementById('units-list');
      if (!list) return;

      list.innerHTML = '';
      const units = getCustomUnits();

      Object.entries(units).forEach(([key, value]) => {
        const div = document.createElement('div');
        div.className = 'bg-gray-50 border border-gray-300 p-2 mb-2 flex justify-between items-center text-sm';
        div.innerHTML = `
          <div>
            <span class="text-yellow-600 font-bold">${getUnitName(key)}</span>
            <span class="text-gray-500 ml-2">= ${value}</span>
          </div>
          ${customUnits[key] ? `<button class="bg-red-400 hover:bg-red-500 text-white px-2 py-1 rounded text-xs">X</button>` : '<span class="text-gray-500 text-xs">Por defecto</span>'}
        `;
        if (customUnits[key]) {
          div.querySelector('button').onclick = () => deleteCustomUnit(key);
        }
        list.appendChild(div);
      });
    }

    function addCustomUnit() {
      const key = document.getElementById('unit-key').value.trim();
      const value = document.getElementById('unit-value').value.trim();

      if (!key || !value) return showToast("Completa todos los campos");

      customUnits[key] = value;
      localStorage.setItem('rpg_units', JSON.stringify(customUnits));
      renderUnitsList();
      renderConversionsList(); // Actualizar dropdowns de equivalencias
      document.getElementById('unit-key').value = '';
      document.getElementById('unit-value').value = '';
      showToast(t('toasts.ingredient_added', `Unidad "${key}" agregada`));

      // Renderizar de nuevo los ingredientes para actualizar unidades
      renderIngredients();
    }

    function deleteCustomUnit(key) {
      showConfirmModal(`¿Eliminar la unidad personalizada "${key}"?`, (confirmed) => {
        if (confirmed) {
          delete customUnits[key];
          localStorage.setItem('rpg_units', JSON.stringify(customUnits));
          renderUnitsList();
          renderIngredients();
          showToast(t('toasts.ingredient_deleted', `Unidad "${key}" eliminada`));
        }
      });
    }

    function resetUnits() {
      showConfirmModal("¿Restaurar las unidades por defecto? Se perderán las personalizadas.", (confirmed) => {
        if (confirmed) {
          customUnits = {};
          localStorage.setItem('rpg_units', JSON.stringify(customUnits));
          renderUnitsList();
          renderIngredients();
          showToast(t('toasts.ingredient_updated', 'Unidades restauradas a valores por defecto'));
        }
      });
    }

    // ====== Gestión de Conversiones ======
    function renderConversionsList() {
      const list = document.getElementById('conversions-list');
      const units = getCustomUnits();
      const unitKeys = Object.keys(units);

      // Poblar selects
      const fromSelect = document.getElementById('conv-from');
      const toSelect = document.getElementById('conv-to');
      fromSelect.innerHTML = '';
      toSelect.innerHTML = '';
      unitKeys.forEach(key => {
        const opt1 = document.createElement('option');
        opt1.value = key;
        opt1.textContent = units[key];
        fromSelect.appendChild(opt1);
        const opt2 = document.createElement('option');
        opt2.value = key;
        opt2.textContent = units[key];
        toSelect.appendChild(opt2);
      });

      list.innerHTML = '';
      Object.keys(customConversions).forEach(key => {
        const [from, to] = key.split('-');
        const factor = customConversions[key];
        const div = document.createElement('div');
        div.className = 'bg-gray-50 border border-gray-300 p-2 mb-2 flex justify-between items-center text-sm';
        div.innerHTML = `
          <span class="text-yellow-600 font-bold">${units[from] || from}</span>
          <span class="text-gray-700">→</span>
          <span class="text-yellow-600 font-bold">${units[to] || to}</span>
          <span class="text-gray-500 ml-2">x${factor}</span>
          <button class="bg-red-400 hover:bg-red-500 text-white px-2 py-1 rounded text-xs" onclick="deleteConversion('${key}')">X</button>
        `;
        list.appendChild(div);
      });
    }

    function addConversion() {
      const from = document.getElementById('conv-from').value;
      const to = document.getElementById('conv-to').value;
      const factor = parseFloat(document.getElementById('conv-factor').value);

      if (!from || !to || isNaN(factor) || factor <= 0) return showToast("Completa todos los campos correctamente");

      const key = `${from}-${to}`;
      const reverseKey = `${to}-${from}`;
      const reverseFactor = 1 / factor;

      customConversions[key] = factor;
      customConversions[reverseKey] = reverseFactor; // Agregar conversión inversa
      localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));
      renderConversionsList();
      document.getElementById('conv-factor').value = '';
      showToast(`Conversiones ${from} ↔ ${to} agregadas`);
    }

    function deleteConversion(key) {
      showConfirmModal(`¿Eliminar la conversión "${key}"?`, (confirmed) => {
        if (confirmed) {
          const [from, to] = key.split('-');
          const reverseKey = `${to}-${from}`;
          delete customConversions[key];
          delete customConversions[reverseKey]; // Eliminar también la conversión inversa
          localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));
          renderConversionsList();
          showToast(t('toasts.conversions_deleted', 'Conversiones eliminadas'));
        }
      });
    }

    function resetConversions() {
      showConfirmModal("¿Restaurar las conversiones por defecto? Se perderán las personalizadas.", (confirmed) => {
        if (confirmed) {
          customConversions = {};
          localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));
          renderConversionsList();
          showToast(t('toasts.conversions_restored', 'Conversiones restauradas'));
        }
      });
    }

    function convertUnit(value, fromUnit, toUnit) {
      if (fromUnit === toUnit) return value;

      const key = `${fromUnit}-${toUnit}`;
      if (customConversions[key]) {
        return value * customConversions[key];
      }

      const reverseKey = `${toUnit}-${fromUnit}`;
      if (customConversions[reverseKey]) {
        return value / customConversions[reverseKey];
      }

      return value; // Sin conversión
    }

    function resetAllData() {
      showConfirmModal("⚠️ ¿SEGURO? Esto eliminará TODOS los datos (recetas e ingredientes). Esta acción NO se puede deshacer.", (confirmed) => {
        if (confirmed) {
          showConfirmModal("Confirma una vez más para estar completamente seguro...", (confirmed2) => {
            if (confirmed2) {
              ingredients = [];
              recipeBook = [];
              customUnits = {};
              customConversions = {};
              
              // Limpiar datos de recetas en localStorage
              localStorage.setItem('rpg_ing', JSON.stringify(ingredients));
              localStorage.setItem('rpg_book', JSON.stringify(recipeBook));
              localStorage.setItem('rpg_units', JSON.stringify(customUnits));
              localStorage.setItem('rpg_conversions', JSON.stringify(customConversions));
              
              // Limpiar todas las otras claves de localStorage
              localStorage.removeItem('install_banner_dismissed');
              localStorage.removeItem('currentLanguage');
              
              // Limpiar cualquier otra clave que no sea de recetas
              const keysToKeep = ['rpg_ing', 'rpg_book', 'rpg_units', 'rpg_conversions'];
              for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && !keysToKeep.includes(key)) {
                  console.log('[DATA] Eliminando:', key);
                  localStorage.removeItem(key);
                }
              }
              
              renderIngredients();
              renderBook();
              renderUnitsList();
              renderConversionsList();
              showToast(t('toasts.data_cleared', 'Todos los datos han sido eliminados'));
              console.log('[DATA] ✓ Todos los datos limpiados');
            }
          });
        }
      });
    }

    // Cerrar modal al hacer click fuera
    window.addEventListener('click', (event) => {
      const modal = document.getElementById('recipe-modal');
      if (event.target === modal) {
        closeRecipeModal();
      }
    });

    // ====== PWA Install Prompt ======
    let deferredPrompt = null;
    let isHttps = window.location.protocol === 'https:';
    let isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

    console.log('[PWA] ========== INICIALIZANDO PWA ==========');
    console.log('[PWA] HTTPS:', isHttps);
    console.log('[PWA] Localhost:', isLocalhost);
    console.log('[PWA] Protocolo:', window.location.protocol);

    // Capturar el evento beforeinstallprompt (solo en HTTPS)
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('[PWA] beforeinstallprompt disparado');
      e.preventDefault();
      deferredPrompt = e;
      
      if (!localStorage.getItem('install_banner_dismissed')) {
        console.log('[PWA] Mostrando banner desde beforeinstallprompt');
        showInstallBanner();
      } else {
        console.log('[PWA] Banner descartado previamente');
      }
    });

    // Cuando la app se instala correctamente
    window.addEventListener('appinstalled', (e) => {
      console.log('[PWA] App instalada correctamente');
      dismissInstallBanner();
      localStorage.setItem('install_banner_dismissed', 'true');
      deferredPrompt = null;
    });

    // Mostrar banner de instalación
    function showInstallBanner() {
      console.log('[PWA] showInstallBanner() ejecutada');
      const banner = document.getElementById('install-banner');
      if (banner) {
        banner.style.display = 'block';
        console.log('[PWA] ✓ Banner mostrado');
      } else {
        console.error('[PWA] ERROR: install-banner no encontrado');
      }
    }

    // Ocultar banner de instalación
    function dismissInstallBanner() {
      console.log('[PWA] dismissInstallBanner() ejecutada');
      const banner = document.getElementById('install-banner');
      if (banner) {
        banner.style.display = 'none';
        localStorage.setItem('install_banner_dismissed', 'true');
        console.log('[PWA] ✓ Banner ocultado');
      }
    }

    // Instalar app
    function installApp() {
      console.log('[PWA] installApp() ejecutada');
      
      if (deferredPrompt) {
        console.log('[PWA] Usando beforeinstallprompt');
        deferredPrompt.prompt();
        
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('[PWA] ✓ Usuario aceptó instalar');
            showToast(t('toasts.pwa_installed', 'App instalada correctamente'));
          } else {
            console.log('[PWA] Usuario rechazó');
          }
          deferredPrompt = null;
        }).catch((err) => {
          console.error('[PWA] Error:', err);
        });
      } else {
        // Mostrar instrucciones manuales si no hay deferredPrompt
        console.log('[PWA] No hay deferredPrompt, mostrando instrucciones manuales');
        const isChrome = /Chrome|Chromium|CriOS/.test(navigator.userAgent);
        const isEdge = /Edg/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        
        let instructions = 'Para instalar la app:\n\n';
        
        if (isAndroid) {
          instructions += '1. Abre el menú (⋮)\n2. Selecciona "Instalar app"';
        } else if (isChrome || isEdge) {
          instructions += '1. Haz clic en el ícono de instalación en la barra de direcciones\n2. O usa el menú (⋮) → "Instalar app"';
        } else {
          instructions += 'Tu navegador puede no soportar la instalación como app.\nIntenta con Chrome, Edge o navegador en Android.';
        }
        
        showToast(instructions);
      }
    }

    // Función para testing
    window.forceShowInstallBanner = function() {
      console.log('[PWA] FORCE: Mostrando banner');
      localStorage.removeItem('install_banner_dismissed');
      showInstallBanner();
    };

    // Init
    window.onload = async () => {
      await loadI18nData();
      updateI18n();
      renderUnitsSelector('ing-rarity');
      renderUnitsSelector('ing-rarity-desk');
      renderIngredients();
      renderBook();
      renderUnitsList();
      renderConversionsList();
      initSPA();

      // Test automático del banner PWA
      console.log('[PWA] ========== TEST AUTOMÁTICO DE BANNER ==========');
      console.log('[PWA] 1. Elemento install-banner existe:', !!document.getElementById('install-banner'));
      console.log('[PWA] 2. localStorage install_banner_dismissed:', localStorage.getItem('install_banner_dismissed'));
      console.log('[PWA] 3. beforeinstallprompt evento soportado:', 'beforeinstallprompt' in window);
      console.log('[PWA] 4. Navegador:', navigator.userAgent);
      console.log('[PWA] 5. Protocolo:', window.location.protocol);
      console.log('[PWA] ========== FIN TEST AUTOMÁTICO ==========');

      // Registrar Service Worker para PWA
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('[PWA] Service Worker registrado:', registration);
          })
          .catch((error) => {
            console.log('[PWA] Error al registrar Service Worker:', error);
          });
      }
      
      console.log('[PWA] Aplicación cargada');
    };
  </script>
<div style="position: absolute; z-index: 99999">
      <input autocomplete="off" type="checkbox" id="aadsstickymkajrk5k" hidden />
      <div style="padding-top: 0; padding-bottom: auto;">
        <div style="width:100%;height:auto;position:fixed;text-align:center;font-size:0;bottom:0;left:0;right:0;margin:auto">
          <label for="aadsstickymkajrk5k" style="top: 50%;transform: translateY(-50%);right:24px;; position: absolute;border-radius: 4px; background: rgba(248, 248, 249, 0.70); padding: 4px;z-index: 99999;cursor:pointer">
            <svg fill="#000000" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 490 490">
              <polygon points="456.851,0 245,212.564 33.149,0 0.708,32.337 212.669,245.004 0.708,457.678 33.149,490 245,277.443 456.851,490 489.292,457.678 277.331,245.004 489.292,32.337 "/>
            </svg>
          </label>
          <div id="frame" style="width: 100%;margin: auto;position: relative; z-index: 99998;">
                          <div style="width: 70%;margin:auto;text-align:left;position: absolute;left: 0;right: 0; top:-24px">
                            <a style="display:inline-block;font-size: 13px;color: #263238;padding: 4px 10px;background: #F8F8F9;text-decoration: none; border-radius: 4px 4px 0 0;"
                              id="frame-link"
                              target="_blank"
                              href="https://aads.com/campaigns/new?source_id=2423892&source_type=ad_unit&partner=2423892">
                              Advertise here
                            </a>
                          </div>
                        <iframe data-aa=2423892 src=//acceptable.a-ads.com/2423892/?size=Adaptive style='border:0; padding:0; width:70%; height:auto; overflow:hidden; margin: auto'></iframe>
                    </div>
        </div>
        <style>
      #aadsstickymkajrk5k:checked + div {
        display: none;
      }
    </style>
    </div></div>
</body>

</html>